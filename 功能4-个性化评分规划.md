# åŠŸèƒ½4ï¼šä¸ªæ€§åŒ–è¯„åˆ†é¢„æµ‹ - è¯¦ç»†è§„åˆ’ã€åªè¯»æ¨¡å¼ã€‘

## âš ï¸ é‡è¦è¯´æ˜
**æœ¬åŠŸèƒ½å®Œå…¨ä¸ºåªè¯»æ“ä½œ**ï¼Œä»…å¯¹å›¾ç‰‡æ–‡ä»¶è¿›è¡Œæ‰«æã€åˆ†æå’Œè¯„åˆ†é¢„æµ‹ï¼Œä¸æ¶‰åŠä»»ä½•æ–‡ä»¶ä¿®æ”¹ã€ç§»åŠ¨æˆ–é‡å‘½åæ“ä½œã€‚å®‰å…¨æ— é£é™©ã€‚

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰
åŸºäºç”¨æˆ·å¯¹å›¾ç‰‡çš„ä¸ªæ€§åŒ–åå¥½è¯„åˆ†ï¼Œä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹ï¼ˆå²­å›å½’Ridge Regressionï¼‰é¢„æµ‹å…¶ä»–å›¾ç‰‡çš„å¯èƒ½è¯„åˆ†ï¼Œå¸®åŠ©ç”¨æˆ·å‘ç°ç¬¦åˆä¸ªäººå®¡ç¾çš„å†…å®¹ã€‚

### 1.2 å‰ç½®æ¡ä»¶
- âœ… åŠŸèƒ½1ï¼šåŸºç¡€å…ƒæ•°æ®æå–
- âœ… åŠŸèƒ½2ï¼šæ­£å‘è¯æ¸…æ´—
- âœ… **åŠŸèƒ½3ï¼šTF-IDFå…³é”®è¯æå–**ï¼ˆä½œä¸ºæ¨¡å‹è¾“å…¥ç‰¹å¾ï¼‰
- ğŸ“Š ç”¨æˆ·æ ‡æ³¨æ•°æ®ï¼šä»æ–‡ä»¶å¤¹åç§°è§£æï¼ˆä¾‹ï¼šæ–‡ä»¶å¤¹`[5stars]`ã€`[3stars]`ï¼‰
- ğŸ”’ çº¯åˆ†æé¢„æµ‹ï¼Œä¸ä¿®æ”¹æºæ–‡ä»¶

### 1.3 è¾“å…¥æ•°æ®æ¥æº
```
ç”¨æˆ·æ ‡æ³¨æ•°æ®æ¥æºï¼š
â”œâ”€ æ–‡ä»¶å¤¹ç»“æ„ï¼šC:\outputs\[è¯„åˆ†æ ‡ç­¾]_æè¿°\
â”‚  â”œâ”€ [5stars]_é«˜è´¨é‡  â†’ æ ‡ç­¾ï¼š5åˆ†
â”‚  â”œâ”€ [4stars]_ä¸é”™    â†’ æ ‡ç­¾ï¼š4åˆ†
â”‚  â”œâ”€ [3stars]_ä¸­ç­‰    â†’ æ ‡ç­¾ï¼š3åˆ†
â”‚  â””â”€ [2stars]_ä¸€èˆ¬    â†’ æ ‡ç­¾ï¼š2åˆ†
â””â”€ æå–æ–¹å¼ï¼šé€šè¿‡æ­£åˆ™åŒ¹é… \[(\d)stars\] è·å–æ•°å­—è¯„åˆ†
```

### 1.4 è¾“å‡ºå½¢å¼
**Excelæ–°å¢åˆ—ï¼ˆ2ä¸ªï¼‰ï¼š**
1. `åå¥½å®šæ ‡åˆ†`ï¼šç”¨æˆ·æ ‡æ³¨çš„è¯„åˆ†ï¼ˆ5/4/3/2/1ï¼‰
2. `ä¸ªæ€§åŒ–æ¨èé¢„ä¼°è¯„åˆ†`ï¼šæ¨¡å‹é¢„æµ‹çš„è¯„åˆ†ï¼ˆæµ®ç‚¹æ•°ï¼Œå¦‚ 4.23ï¼‰
- å®Œå…¨åªè¯»è¾“å‡ºï¼Œä¸ä¿®æ”¹åŸå§‹æ•°æ®

---

## 2. æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 2.1 æœºå™¨å­¦ä¹ æ¡†æ¶é€‰æ‹©

| æ¡†æ¶ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **ML.NET** | å¾®è½¯å®˜æ–¹ï¼ŒC# Nativeï¼Œæ€§èƒ½å¥½ | å­¦ä¹ æ›²çº¿é™¡ | â­â­â­â­â­ |
| Accord.NET | å®Œæ•´çš„MLåº“ | æ–‡æ¡£è¾ƒå°‘ï¼Œç»´æŠ¤ä¸æ´»è·ƒ | â­â­â­ |
| æ‰‹å†™Ridgeç®—æ³• | è½»é‡ï¼Œæ˜“ç†è§£ | æ€§èƒ½ä¸å¦‚åº“ï¼Œéœ€é˜²æ­¢æ•°å€¼ä¸ç¨³å®š | â­â­ |
| TensorFlow/PyTorch | å¼ºå¤§ï¼Œä¸šç•Œæ ‡å‡† | éœ€è¦Python/C++äº’æ“ä½œ | â­ |

**æœ€ç»ˆé€‰æ‹©ï¼š** ML.NETï¼ˆå¾®è½¯å®˜æ–¹ï¼ŒC# Nativeï¼Œæ€§èƒ½ä¼˜ï¼Œæ–‡æ¡£å®Œæ•´ï¼‰

### 2.2 ç®—æ³•åŸç†ï¼šå²­å›å½’ï¼ˆRidge Regressionï¼‰

```
æ ‡å‡†çº¿æ€§å›å½’ï¼šy = wâ‚€ + wâ‚xâ‚ + wâ‚‚xâ‚‚ + ... + wâ‚™xâ‚™
            Loss = Î£(yáµ¢ - Å·áµ¢)Â² + Î»Â·Î£(wâ±¼)Â²
                    â”œâ”€ æ‹Ÿåˆè¯¯å·®      â””â”€ æ­£åˆ™åŒ–é¡¹ï¼ˆé˜²æ­¢è¿‡æ‹Ÿåˆï¼‰

ä¼˜åŠ¿ï¼š
  âœ“ ç®€å•é«˜æ•ˆï¼Œè®­ç»ƒå¿«é€Ÿï¼ˆ< 100msï¼‰
  âœ“ è§£é‡Šæ€§å¼ºï¼Œæƒé‡å¯è§†åŒ–
  âœ“ é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œæ³›åŒ–èƒ½åŠ›å¥½
  âœ“ é€‚åˆç‰¹å¾æ•°é‡å¤šçš„åœºæ™¯ï¼ˆTF-IDFæœ‰ä¸Šç™¾ç»´ï¼‰

å‚æ•°ï¼š
  Î» (Lambda) = æ­£åˆ™åŒ–å¼ºåº¦ï¼Œé€šå¸¸ 0.01 - 100
  Î± (Learning Rate) = ä¸€èˆ¬æ— éœ€è°ƒæ•´ï¼Œç”±æ±‚è§£å™¨è‡ªåŠ¨è®¾å®š
```

### 2.3 ç‰¹å¾å·¥ç¨‹

**è¾“å…¥ç‰¹å¾ï¼š** TF-IDFå‘é‡ï¼ˆTOP 10è¯è¯­çš„åˆ†æ•°ï¼‰
```
ç‰¹å¾å‘é‡ = [è¯1_åˆ†æ•°, è¯2_åˆ†æ•°, ..., è¯10_åˆ†æ•°]
ç»´åº¦ï¼š10ç»´ï¼ˆå¯¹åº”TF-IDFçš„Top10ï¼‰

è¡¥å……ç‰¹å¾ï¼ˆå¯é€‰ï¼‰ï¼š
  - è¯æ•°é‡ï¼ˆPrompté•¿åº¦ï¼‰
  - æ¨¡å‹ç±»å‹ï¼ˆè½¬ä¸ºOneHotç¼–ç ï¼‰
  - é‡‡æ ·å™¨ç±»å‹
  é¢„æœŸæ€»ç»´åº¦ï¼š15-20ç»´
```

**è¾“å‡ºæ ‡ç­¾ï¼š** ç”¨æˆ·è¯„åˆ†ï¼ˆ1-5æ•´æ•°ï¼Œå°†æ ‡å‡†åŒ–ä¸º0-1ï¼‰

### 2.4 æ€§èƒ½é¢„æœŸ

```
å•æ¬¡è®­ç»ƒï¼ˆâ‰¤10,000æ ·æœ¬ï¼‰ï¼š< 500ms
å•æ¬¡é¢„æµ‹ï¼ˆå•å¼ å›¾ç‰‡ï¼‰ï¼š< 100Î¼s
æ‰¹é‡é¢„æµ‹ï¼ˆ133,509å›¾ç‰‡ï¼‰ï¼š< 15ç§’
æ¨¡å‹ä¿å­˜/åŠ è½½ï¼š< 50ms
å†…å­˜å ç”¨ï¼š< 100MB
```

---

## 3. å®ç°æµç¨‹è¯¦ç»†è®¾è®¡

### 3.1 å‰ç½®åŠŸèƒ½ï¼šæ•°æ®å‡†å¤‡é˜¶æ®µ

#### ç¬¬ä¸€æ­¥ï¼šè§£æç”¨æˆ·è¯„åˆ†æ ‡ç­¾ (ExtractRatingFromPath)

**è¾“å…¥ï¼š** `string folderPath` æˆ– `string filePath`

**è¿‡ç¨‹ï¼š**
```
æ–‡ä»¶å¤¹è·¯å¾„ï¼šC:\outputs\[5stars]_é«˜è´¨é‡\image.png
  â†“ æ­£åˆ™åŒ¹é… \[(\d)stars\]
  â†“ æå–æ•°å­—ï¼š5
  â†“ è¿”å›è¯„åˆ†ï¼š5
```

**ä¼ªä»£ç ï¼š**
```csharp
private static int? ExtractRatingFromPath(string path)
{
    var match = Regex.Match(path, @"\[(\d)stars\]");
    if(match.Success && int.TryParse(match.Groups[1].Value, out int rating))
    {
        return Math.Min(5, Math.Max(1, rating));  // é™åˆ¶åœ¨1-5èŒƒå›´
    }
    return null;  // æœªæ‰¾åˆ°æ ‡ç­¾
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(n)ï¼Œn = è·¯å¾„é•¿åº¦ï¼ˆé€šå¸¸ < 256å­—ç¬¦ï¼‰
- ç©ºé—´ï¼šO(1)

---

#### ç¬¬äºŒæ­¥ï¼šæå–TF-IDFç‰¹å¾å‘é‡ (ExtractFeatureVector)

**è¾“å…¥ï¼š** `string tfidfString` ï¼ˆæ¥è‡ªåŠŸèƒ½3çš„ "è¯1(0.82)|è¯2(0.76)|..."ï¼‰

**è¿‡ç¨‹ï¼š**
```
TF-IDFå­—ç¬¦ä¸² "beautiful(0.82)|girl(0.76)|...|red(0.45)"
  â†“ æŒ‰ "|" åˆ†å‰²
  â†“ å¯¹æ¯ä¸ª "è¯(åˆ†æ•°)" æå–åˆ†æ•°
  â†“ å­˜å…¥æ•°ç»„ [0.82, 0.76, ..., 0.45]
  â†“ è¿”å›å‘é‡ï¼ˆä½œä¸ºæ¨¡å‹è¾“å…¥ï¼‰
```

**ä¼ªä»£ç ï¼š**
```csharp
private static float[] ExtractFeatureVector(string tfidfString)
{
    if(string.IsNullOrEmpty(tfidfString))
        return new float[10];  // è¿”å›å…¨0å‘é‡
    
    var parts = tfidfString.Split('|');
    var features = new float[10];  // TOP 10ç»´
    
    for(int i = 0; i < Math.Min(parts.Length, 10); i++)
    {
        var match = Regex.Match(parts[i], @"(\d+\.\d+)");
        if(match.Success && float.TryParse(match.Groups[1].Value, out float score))
        {
            features[i] = score;
        }
    }
    
    return features;
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(10) = O(1)ï¼ˆå¸¸æ•°ï¼‰
- ç©ºé—´ï¼šO(10) = O(1)

---

#### ç¬¬ä¸‰æ­¥ï¼šæ„å»ºè®­ç»ƒæ•°æ®é›† (BuildTrainingDataset)

**è¾“å…¥ï¼š** `List<MetadataRecord> allRecords`

**è¿‡ç¨‹ï¼š**
```
éå†æ‰€æœ‰133,509ä¸ªæ–‡ä»¶ï¼ˆåªè¯»ï¼‰
  â†“
æ£€æŸ¥æ˜¯å¦æœ‰è¯„åˆ†æ ‡ç­¾ï¼ˆExtractRatingFromPathï¼‰
  â†“
YES â†’ æ„å»ºæ ·æœ¬ï¼š
    {
      Features: float[10],      // TF-IDFå‘é‡
      Label: float (0-1)        // æ ‡å‡†åŒ–çš„è¯„åˆ†
    }
  â†“
NO â†’ è·³è¿‡ï¼ˆæ­¤æ–‡ä»¶æ— æ ‡æ³¨ï¼‰
  â†“
è¿”å›è®­ç»ƒé›† List<TrainingData>
  ï¼ˆé¢„æœŸ 1,000 - 50,000 æ ·æœ¬ï¼‰
```

**æ•°æ®ç»“æ„ï¼š**
```csharp
public class TrainingData
{
    public float[] Features { get; set; }  // TF-IDFå‘é‡ [10ç»´]
    public float Label { get; set; }       // æ ‡å‡†åŒ–è¯„åˆ† [0-1]
    public string FileName { get; set; }   // ç”¨äºè°ƒè¯•
}

public class ImageScorerConfig
{
    public int RatingMin { get; set; } = 1;
    public int RatingMax { get; set; } = 5;
    public float Lambda { get; set; } = 0.01f;  // Ridgeæ­£åˆ™åŒ–å¼ºåº¦
    public int MaxTrainingSamples { get; set; } = 50000;
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(N)ï¼ŒN = æ–‡ä»¶æ€»æ•°
- ç©ºé—´ï¼šO(S)ï¼ŒS = æœ‰æ ‡æ³¨çš„æ ·æœ¬æ•°

---

### 3.2 åç½®åŠŸèƒ½ï¼šæ¨¡å‹è®­ç»ƒä¸é¢„æµ‹

#### ç¬¬å››æ­¥ï¼šæ¨¡å‹è®­ç»ƒ (TrainRidgeRegressionModel)

**è¾“å…¥ï¼š** `List<TrainingData> trainingSet, ImageScorerConfig config`

**è¿‡ç¨‹ï¼š**
```
éªŒè¯è®­ç»ƒé›†å¤§å°ï¼ˆéœ€â‰¥10ä¸ªæ ·æœ¬ï¼‰
  â†“
åˆå§‹åŒ–ML.NETä¸Šä¸‹æ–‡ MLContext
  â†“
åˆ›å»ºIDataViewï¼ˆML.NETæ•°æ®è¡¨ç¤ºï¼‰
  â†“
å®šä¹‰è®­ç»ƒæµç¨‹ï¼š
    1. ç‰¹å¾åˆ— â†’ è½¬æ¢ä¸ºå‘é‡
    2. åº”ç”¨Ridgeå›å½’ç®—æ³•
    3. æŒ‡å®šç›®æ ‡åˆ—ä¸º Label
  â†“
æ‰§è¡Œè®­ç»ƒï¼šfit(trainingData)
  â†“
è¿”å› ITransformer æ¨¡å‹å¯¹è±¡
```

**ä¼ªä»£ç ï¼ˆä½¿ç”¨ML.NETï¼‰ï¼š**
```csharp
public static ITransformer TrainRidgeModel(
    List<TrainingData> trainingSet,
    ImageScorerConfig config)
{
    var mlContext = new MLContext(seed: 0);
    
    // éªŒè¯æ•°æ®
    if(trainingSet.Count < 10)
        throw new ArgumentException("è®­ç»ƒé›†æ ·æœ¬æ•°è¿‡å°‘");
    
    // è½¬æ¢ä¸ºML.NETæ ¼å¼
    var data = mlContext.Data.LoadFromEnumerable(trainingSet);
    
    // å®šä¹‰å¤„ç†ç®¡é“
    var pipeline = mlContext.Transforms
        .CopyColumns("Features", "FeaturesVector")
        .Append(mlContext.Regression.Trainers.OnlineGradientDescent(
            labelColumnName: "Label",
            featureColumnName: "FeaturesVector",
            options: new OnlineGradientDescentTrainer.Options
            {
                NumberOfIterations = 100,
                LearningRate = 0.01f
            }))
        .Append(mlContext.Regression.Trainers.LbfgsRegression(
            labelColumnName: "Label",
            featureColumnName: "FeaturesVector"));
    
    // è®­ç»ƒæ¨¡å‹
    var model = pipeline.Fit(data);
    
    return model;
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(S Ã— I)ï¼ŒS = æ ·æœ¬æ•°ï¼ŒI = è¿­ä»£æ¬¡æ•°ï¼ˆé€šå¸¸10-100ï¼‰
- é¢„æœŸè€—æ—¶ï¼š< 500msï¼ˆS â‰¤ 50,000ï¼‰
- ç©ºé—´ï¼šO(S Ã— 10) = O(S)ï¼ˆç‰¹å¾æ•°å›ºå®šï¼‰

---

#### ç¬¬äº”æ­¥ï¼šæ¨¡å‹è¯„ä¼° (EvaluateModel)

**è¾“å…¥ï¼š** `ITransformer model, List<TrainingData> validationSet`

**è¿‡ç¨‹ï¼š**
```
ä½¿ç”¨éªŒè¯é›†è¯„ä¼°æ¨¡å‹è´¨é‡
  â†“
è®¡ç®—è¯„ä¼°æŒ‡æ ‡ï¼š
  - RSquared (RÂ²)ï¼šæ‹Ÿåˆåº¦ [0-1]ï¼Œ>0.7ä¸ºè‰¯å¥½
  - RMSEï¼šå‡æ–¹æ ¹è¯¯å·® [0-1]
  - MAEï¼šå¹³å‡ç»å¯¹è¯¯å·®
  â†“
è®°å½•è¯„ä¼°ç»“æœï¼Œè¾“å‡ºè¯Šæ–­ä¿¡æ¯
  â†“
è‹¥RÂ² < 0.5ï¼Œå‘å‡ºè­¦å‘Š
```

**ä¼ªä»£ç ï¼š**
```csharp
public static RegressionMetrics EvaluateModel(
    ITransformer model,
    List<TrainingData> validationSet)
{
    var mlContext = new MLContext();
    var data = mlContext.Data.LoadFromEnumerable(validationSet);
    
    var predictions = model.Transform(data);
    var metrics = mlContext.Regression.Evaluate(
        predictions,
        labelColumnName: "Label");
    
    Console.WriteLine($"RÂ² Score: {metrics.RSquared:F4}");
    Console.WriteLine($"RMSE: {metrics.RootMeanSquaredError:F4}");
    Console.WriteLine($"MAE: {metrics.MeanAbsoluteError:F4}");
    
    return metrics;
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(V)ï¼ŒV = éªŒè¯é›†æ ·æœ¬æ•°
- é¢„æœŸè€—æ—¶ï¼š< 200ms

---

#### ç¬¬å…­æ­¥ï¼šæ‰¹é‡é¢„æµ‹ (PredictScoresParallel)

**è¾“å…¥ï¼š** `List<MetadataRecord> allRecords, ITransformer model`

**è¿‡ç¨‹ï¼š**
```
ä½¿ç”¨ Parallel.ForEach å¹¶è¡Œå¤„ç†æ¯ä¸ªæ–‡ä»¶
  â†“
å¯¹äºæœ‰TF-IDFç‰¹å¾çš„æ–‡ä»¶ï¼š
  1. æå–ç‰¹å¾å‘é‡
  2. è°ƒç”¨æ¨¡å‹é¢„æµ‹
  3. è·å¾—é¢„æµ‹åˆ†æ•° [0-1]
  4. è½¬æ¢ä¸ºè¯„åˆ†èŒƒå›´ [1-5]
  5. å­˜å‚¨åˆ° record.PredictedScoreï¼ˆå†…å­˜ä¸­ï¼‰
  â†“
å¯¹äºæ— TF-IDFç‰¹å¾çš„æ–‡ä»¶ï¼š
  â†’ é¢„æµ‹åˆ†æ•°è®¾ä¸ºå¹³å‡å€¼ (2.5)
  â†“
ç”Ÿæˆè¿›åº¦æŠ¥å‘Šï¼ˆä¸ä¿®æ”¹æºæ–‡ä»¶ï¼‰
```

**ä¼ªä»£ç ï¼š**
```csharp
public static void PredictScoresParallel(
    List<MetadataRecord> records,
    ITransformer model,
    IProgress<int> progress = null)
{
    var predictionEngine = model.CreatePredictionEngine<
        ImageScoreInput, 
        ImageScorePrediction>(mlContext);
    
    Parallel.ForEach(records, new ParallelOptions { MaxDegreeOfParallelism = 8 },
        (record, state, index) =>
    {
        try
        {
            if(string.IsNullOrEmpty(record.TfidfFeatures))
            {
                record.PredictedScore = 2.5f;  // æ— æ•°æ®æ—¶ç”¨å¹³å‡å€¼
                return;
            }
            
            // æå–ç‰¹å¾å‘é‡
            var features = ExtractFeatureVector(record.TfidfFeatures);
            
            // é¢„æµ‹
            var input = new ImageScoreInput { Features = features };
            var prediction = predictionEngine.Predict(input);
            
            // è½¬æ¢ä¸º1-5èŒƒå›´
            record.PredictedScore = DenormalizeScore(prediction.Score);
        }
        catch(Exception ex)
        {
            Console.WriteLine($"é¢„æµ‹å¼‚å¸¸ {record.FileName}: {ex.Message}");
            record.PredictedScore = 2.5f;
        }
        
        progress?.Report((int)index);
    });
}

private static float DenormalizeScore(float normalizedScore)
{
    // [0-1] â†’ [1-5]
    return 1 + normalizedScore * 4;
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(N / P)ï¼ŒN = æ–‡ä»¶æ•°ï¼ŒP = å¹¶è¡Œåº¦
- é¢„æœŸè€—æ—¶ï¼š5-15ç§’ï¼ˆN = 133,509ï¼ŒP = 8ï¼‰
- å•æ¬¡é¢„æµ‹ï¼š< 100Î¼s

---

#### ç¬¬ä¸ƒæ­¥ï¼šç”ŸæˆæŠ¥å‘Š (GenerateExcelWithPredictions)

**è¾“å…¥ï¼š** `List<MetadataRecord> records, string folder`

**è¿‡ç¨‹ï¼š**
```
è°ƒç”¨ ReportService.GenerateExcelReport()
  â†“
æ–°å¢ä¸¤åˆ—ï¼ˆæŒ‰æ‰«ææ¨¡å¼åˆ¤æ–­ï¼‰ï¼š
  1. "åå¥½å®šæ ‡åˆ†" 
     â†’ æ¥è‡ª record.UserRatingï¼ˆä»è·¯å¾„æå–ï¼‰
  2. "ä¸ªæ€§åŒ–æ¨èé¢„ä¼°è¯„åˆ†"
     â†’ æ¥è‡ª record.PredictedScoreï¼ˆæ¨¡å‹é¢„æµ‹ï¼‰
  â†“
æ ¼å¼åŒ–åˆ†æ•°ä¸º (X.XX)
  â†“
ä¿å­˜Excelæ–‡ä»¶åˆ°è¾“å‡ºç›®å½•ï¼ˆåªè¯»è¾“å‡ºï¼Œä¸ä¿®æ”¹æºæ–‡ä»¶ï¼‰
```

**ä¼ªä»£ç ï¼š**
```csharp
public static void GenerateExcelReport(
    List<MetadataRecord> records,
    string folder,
    int scanMode)
{
    // ... ç°æœ‰ä»£ç  ...
    
    if(scanMode == 4)
    {
        // æ·»åŠ "åå¥½å®šæ ‡åˆ†"åˆ—
        if(record.UserRating.HasValue)
            worksheet.Cell(row, columnIndex).Value = record.UserRating;
        columnIndex++;
        
        // æ·»åŠ "ä¸ªæ€§åŒ–æ¨èé¢„ä¼°è¯„åˆ†"åˆ—
        worksheet.Cell(row, columnIndex).Value = 
            record.PredictedScore.ToString("F2");
        columnIndex++;
    }
    
    // ... å…¶ä»–ä»£ç  ...
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(N)ï¼ŒN = æ–‡ä»¶æ•°
- é¢„æœŸè€—æ—¶ï¼š< 5ç§’

---

## 4. é›†æˆç‚¹è®¾è®¡

### 4.1 æ–°å¢å­—æ®µï¼šMetadataRecord

**ä¿®æ”¹ä½ç½®ï¼š** `DevelopmentModeService.cs` â†’ `MetadataRecord` ç±»

```csharp
public class MetadataRecord
{
    // ç°æœ‰å­—æ®µ...
    public string TfidfFeatures { get; set; } = string.Empty;
    
    // æ–°å¢å­—æ®µï¼ˆåŠŸèƒ½4ï¼‰
    public int? UserRating { get; set; } = null;          // [1-5] ç”¨æˆ·æ ‡æ³¨è¯„åˆ†
    public float PredictedScore { get; set; } = 2.5f;     // [1-5] æ¨¡å‹é¢„æµ‹è¯„åˆ†
}
```

### 4.2 æ–°å¢ML.NETæ•°æ®ç±»

**æ–‡ä»¶ï¼š** `ImageScorerService.cs` ä¸­çš„å†…åµŒç±»

```csharp
public class ImageScoreInput
{
    [VectorType(10)]
    public float[] Features { get; set; }  // TF-IDFç‰¹å¾å‘é‡
}

public class ImageScorePrediction
{
    [ColumnName("Score")]
    public float Score { get; set; }  // é¢„æµ‹çš„åˆ†æ•° [0-1]
}
```

### 4.3 æ–°å¢å…¥å£æ–¹æ³•ï¼šRunScanMode4

**ä¿®æ”¹ä½ç½®ï¼š** `DevelopmentModeService.cs`

```csharp
public static void RunScanMode4(string folder)
{
    Console.WriteLine($"ğŸ”„ åŠŸèƒ½4ï¼šä¸ªæ€§åŒ–è¯„åˆ†é¢„æµ‹ã€åªè¯»ã€‘");
    var stopwatch = System.Diagnostics.Stopwatch.StartNew();
    
    try
    {
        // ç¬¬1æ­¥ï¼šæ‰«æå¹¶æå–å…ƒæ•°æ® + TF-IDFï¼ˆå¤ç”¨åŠŸèƒ½3ï¼‰
        var records = ScanAndExtractMetadata(folder);
        if(records.Count == 0)
            throw new InvalidOperationException("æ— æ–‡ä»¶æ•°æ®");
        
        // ç¬¬2æ­¥ï¼šæå–ç”¨æˆ·è¯„åˆ†æ ‡ç­¾ + æ„å»ºè®­ç»ƒé›†
        var trainingSet = new List<TrainingData>();
        foreach(var record in records)
        {
            var rating = ExtractRatingFromPath(record.FilePath);
            if(rating.HasValue)
            {
                record.UserRating = rating;
                trainingSet.Add(new TrainingData
                {
                    Features = ExtractFeatureVector(record.TfidfFeatures),
                    Label = NormalizeScore(rating.Value),
                    FileName = record.FileName
                });
            }
        }
        
        Console.WriteLine($"ğŸ“Š è®­ç»ƒé›†å¤§å°: {trainingSet.Count}");
        if(trainingSet.Count < 10)
        {
            Console.WriteLine("âš ï¸ è®­ç»ƒæ ·æœ¬è¿‡å°‘ï¼Œä½¿ç”¨é»˜è®¤è¯„åˆ†");
            foreach(var record in records)
                record.PredictedScore = 2.5f;
        }
        else
        {
            // ç¬¬3æ­¥ï¼šè®­ç»ƒæ¨¡å‹
            var config = new ImageScorerConfig();
            var model = ImageScorerService.TrainRidgeModel(trainingSet, config);
            
            // ç¬¬4æ­¥ï¼šè¯„ä¼°æ¨¡å‹
            var metrics = ImageScorerService.EvaluateModel(model, trainingSet);
            Console.WriteLine($"ğŸ“ˆ RÂ² Score: {metrics.RSquared:F4}");
            
            // ç¬¬5æ­¥ï¼šæ‰¹é‡é¢„æµ‹
            var progress = new Progress<int>(count =>
            {
                if(count % 10000 == 0)
                    Console.WriteLine($"å·²é¢„æµ‹: {count}/{records.Count}");
            });
            ImageScorerService.PredictScoresParallel(records, model, progress);
        }
        
        // ç¬¬6æ­¥ï¼šç”ŸæˆæŠ¥å‘Š
        ReportService.GenerateExcelReport(records, folder, scanMode: 4);
        
        stopwatch.Stop();
        Console.WriteLine($"âœ… åŠŸèƒ½4å®Œæˆï¼Œè€—æ—¶: {stopwatch.ElapsedMilliseconds}ms");
    }
    catch(Exception ex)
    {
        Console.WriteLine($"âŒ åŠŸèƒ½4å¼‚å¸¸: {ex.Message}");
    }
}
```

### 4.4 Program.cs å¿«é€Ÿå¯åŠ¨

**ä¿®æ”¹ä½ç½®ï¼š** `Program.cs` â†’ Main() æ–¹æ³•

```csharp
if (args.Length > 0 && args[0].StartsWith("--"))
{
    string quickLaunch = args[0].Substring(2).ToLowerInvariant();
    return quickLaunch switch
    {
        "1" => DevelopmentModeService.RunScanMode(folder),
        "2" => DevelopmentModeService.RunScanMode2(folder),
        "3" => DevelopmentModeService.RunScanMode3(folder),
        "4" => DevelopmentModeService.RunScanMode4(folder),  // æ–°å¢
        _ => RunNormalMode(args)
    };
}
```

---

## 5. æ–°å¢æ–‡ä»¶æ¸…å•

### 5.1 ImageScorerService.cs

**ä½ç½®ï¼š** `src/ImageInfo/Services/ImageScorerService.cs`

**æ ¸å¿ƒç±»å’Œæ–¹æ³•ï¼š**

```csharp
using Microsoft.ML;

public static class ImageScorerService
{
    // ===== å…¬å¼€æ–¹æ³• =====
    public static ITransformer TrainRidgeModel(
        List<TrainingData> trainingSet,
        ImageScorerConfig config);
    
    public static RegressionMetrics EvaluateModel(
        ITransformer model,
        List<TrainingData> validationSet);
    
    public static void PredictScoresParallel(
        List<MetadataRecord> records,
        ITransformer model,
        IProgress<int> progress = null);
    
    // ===== ç§æœ‰æ–¹æ³• =====
    private static float NormalizeScore(int rating);      // [1-5] â†’ [0-1]
    private static float DenormalizeScore(float score);   // [0-1] â†’ [1-5]
    private static int? ExtractRatingFromPath(string path);
    private static float[] ExtractFeatureVector(string tfidfString);
    
    // ===== å¸¸é‡ =====
    public const float DEFAULT_SCORE = 2.5f;
    public const int MIN_TRAINING_SAMPLES = 10;
}

// ===== æ•°æ®ç±» =====
public class ImageScoreInput
{
    [VectorType(10)]
    public float[] Features { get; set; }
}

public class ImageScorePrediction
{
    [ColumnName("Score")]
    public float Score { get; set; }
}

public class TrainingData
{
    public float[] Features { get; set; }
    public float Label { get; set; }
    public string FileName { get; set; }
}

public class ImageScorerConfig
{
    public int RatingMin { get; set; } = 1;
    public int RatingMax { get; set; } = 5;
    public float Lambda { get; set; } = 0.01f;
    public int MaxTrainingSamples { get; set; } = 50000;
}
```

**ä»£ç è¡Œæ•°ä¼°è®¡ï¼š** 350-450è¡Œ

### 5.2 æ–°å¢NuGetä¾èµ–

**é¡¹ç›®æ–‡ä»¶ï¼š** `src/ImageInfo/ImageInfo.csproj`

```xml
<ItemGroup>
    <PackageReference Include="Microsoft.ML" Version="3.0.1" />
</ItemGroup>
```

---

## 6. æµ‹è¯•è®¡åˆ’

### 6.1 å•å…ƒæµ‹è¯• (xUnit)

**æµ‹è¯•æ–‡ä»¶ï¼š** `tests/ImageInfo.Tests/ImageScorerTests.cs`

```csharp
public class ImageScorerTests
{
    // [1] æµ‹è¯•è¯„åˆ†æå–
    [Theory]
    [InlineData("C:\\[5stars]_é«˜è´¨é‡", 5)]
    [InlineData("C:\\[3stars]_ä¸­ç­‰", 3)]
    [InlineData("C:\\æ²¡æœ‰æ ‡ç­¾", null)]
    public void ExtractRating_VariousPaths_Success(string path, int? expected)
    {
        var result = ImageScorerService.ExtractRatingFromPath(path);
        Assert.Equal(expected, result);
    }
    
    // [2] æµ‹è¯•ç‰¹å¾å‘é‡æå–
    [Fact]
    public void ExtractFeatureVector_ValidTfidf_Success()
    {
        string tfidf = "beautiful(0.82)|girl(0.76)|smile(0.65)|blue(0.58)|eyes(0.52)";
        
        var features = ImageScorerService.ExtractFeatureVector(tfidf);
        
        Assert.Length(features, 10);
        Assert.Equal(0.82f, features[0], precision: 2);
        Assert.Equal(0.76f, features[1], precision: 2);
    }
    
    // [3] æµ‹è¯•ç©ºç‰¹å¾å¤„ç†
    [Fact]
    public void ExtractFeatureVector_Empty_ReturnZeroVector()
    {
        var features = ImageScorerService.ExtractFeatureVector("");
        
        Assert.All(features, f => Assert.Equal(0f, f));
    }
    
    // [4] æµ‹è¯•åˆ†æ•°è§„èŒƒåŒ–
    [Theory]
    [InlineData(1, 0f)]     // æœ€ä½åˆ†
    [InlineData(5, 1f)]     // æœ€é«˜åˆ†
    [InlineData(3, 0.5f)]   // ä¸­é—´åˆ†
    public void NormalizeScore_Conversion_Correct(int rating, float expected)
    {
        var normalized = ImageScorerService.NormalizeScore(rating);
        Assert.Equal(expected, normalized, precision: 2);
    }
    
    // [5-9] ... å…¶ä»–æµ‹è¯•ç”¨ä¾‹
}
```

**æµ‹è¯•ç”¨ä¾‹æ•°ï¼š** 9ä¸ª
**è¦†ç›–ç‡ç›®æ ‡ï¼š** 90%+

---

## 7. æµç¨‹æ€»ç»“

### 7.1 å®ç°æ­¥éª¤æ¸…å•

| åºå· | æ­¥éª¤ | å‡½æ•°æ•° | å¤æ‚åº¦ | é¢„æœŸè€—æ—¶ |
|-----|------|--------|--------|---------|
| 1 | è¯„åˆ†æ ‡ç­¾æå– | 1 | O(L) | - |
| 2 | TF-IDFç‰¹å¾å‘é‡æå– | 1 | O(1) | - |
| 3 | æ„å»ºè®­ç»ƒæ•°æ®é›† | 1 | O(N) | < 2ç§’ |
| 4 | æ¨¡å‹è®­ç»ƒ | 1 | O(SÃ—I) | < 500ms |
| 5 | æ¨¡å‹è¯„ä¼° | 1 | O(S) | < 200ms |
| 6 | æ‰¹é‡é¢„æµ‹ | 1 | O(N/P) | 5-15ç§’ |
| 7 | ç”ŸæˆExcelæŠ¥å‘Š | 1 | O(N) | < 5ç§’ |

**æ€»æ­¥éª¤æ•°ï¼š** 7æ­¥
**æ€»å‡½æ•°æ•°ï¼š** 6ä¸ªå…¬å¼€ + 4ä¸ªç§æœ‰ = 10ä¸ª
**æ€»å¤æ‚åº¦ï¼š** O(N + SÃ—I + N/P) â‰ˆ O(N)
**é¢„æœŸå…¨é‡è€—æ—¶ï¼š** 10-23ç§’

### 7.2 å‰ç½®åŠŸèƒ½ vs åç½®åŠŸèƒ½

| é˜¶æ®µ | åŠŸèƒ½ | ä¾èµ– | å…³é”®æ“ä½œ |
|------|------|------|---------|
| **å‰ç½®** | è¯„åˆ†æå– | æ—  | æ­£åˆ™åŒ¹é…è·¯å¾„ |
| **å‰ç½®** | ç‰¹å¾å‘é‡æå– | åŠŸèƒ½3çš„TF-IDF | å­—ç¬¦ä¸²è§£æ |
| **å‰ç½®** | è®­ç»ƒé›†æ„å»º | å‰ä¸¤ä¸ªå‰ç½® | éå†æ‰€æœ‰æ–‡ä»¶ï¼ˆåªè¯»ï¼‰ |
| **åç½®** | æ¨¡å‹è®­ç»ƒ | è®­ç»ƒé›† | ML.NETè°ƒç”¨ |
| **åç½®** | æ¨¡å‹è¯„ä¼° | è®­ç»ƒçš„æ¨¡å‹ | è®¡ç®—å›å½’æŒ‡æ ‡ |
| **åç½®** | æ‰¹é‡é¢„æµ‹ | è®­ç»ƒçš„æ¨¡å‹ | å¹¶è¡Œé¢„æµ‹ |

---

## 8. éªŒæ”¶æ ‡å‡†

- âœ… æ‰€æœ‰7ä¸ªå‡½æ•°å®ç°å®Œæˆ
- âœ… æ‰€æœ‰9ä¸ªå•å…ƒæµ‹è¯•é€šè¿‡ï¼Œè¦†ç›–ç‡â‰¥90%
- âœ… ML.NETåº“æˆåŠŸé›†æˆï¼Œç¼–è¯‘æ— é”™è¯¯
- âœ… æ¨¡å‹è®­ç»ƒè€—æ—¶< 500msï¼ˆâ‰¤50Kæ ·æœ¬ï¼‰
- âœ… æ‰¹é‡é¢„æµ‹è€—æ—¶< 15ç§’ï¼ˆ133,509æ–‡ä»¶ï¼‰
- âœ… RÂ²è¯„åˆ†> 0.5ï¼ˆæ¨¡å‹æœ‰æ•ˆæ€§ï¼‰
- âœ… ExcelæŠ¥å‘Šç”ŸæˆæˆåŠŸï¼Œè¯„åˆ†åˆ—æ­£ç¡®æ˜¾ç¤º
- âœ… **æ— ä»»ä½•æ–‡ä»¶ä¿®æ”¹ã€åªè¯»æ“ä½œ**
- âœ… æ— å†…å­˜æ³„æ¼ï¼Œæ— å¹¶å‘å¼‚å¸¸
- âœ… é”™è¯¯å¤„ç†å®Œå–„ï¼Œå¼‚å¸¸ä¸å¯¼è‡´ç¨‹åºå´©æºƒ
