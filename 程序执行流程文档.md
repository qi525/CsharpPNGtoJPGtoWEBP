# ImageInfo ç¨‹åºæ‰§è¡Œæµç¨‹æ–‡æ¡£

**é¡¹ç›®åç§°**: CsharpPNGtoJPGtoWEBP  
**æ›´æ–°æ—¶é—´**: 2025-11-21  
**ç›®çš„**: å±•ç¤ºç¨‹åºå„æ–‡ä»¶çš„è°ƒç”¨é¡ºåºå’Œæ‰§è¡Œæµç¨‹

---

## ğŸ“‹ ç›®å½•

1. [å¯åŠ¨æµç¨‹](#å¯åŠ¨æµç¨‹)
2. [ç”Ÿäº§æ¨¡å¼æµç¨‹](#ç”Ÿäº§æ¨¡å¼æµç¨‹)
3. [å¼€å‘æ¨¡å¼æµç¨‹](#å¼€å‘æ¨¡å¼æµç¨‹)
4. [æ ¸å¿ƒå¤„ç†æµç¨‹](#æ ¸å¿ƒå¤„ç†æµç¨‹)
5. [æ–‡ä»¶ä¾èµ–å…³ç³»](#æ–‡ä»¶ä¾èµ–å…³ç³»)
6. [æ•°æ®æµå‘å›¾](#æ•°æ®æµå‘å›¾)

---

## ğŸš€ å¯åŠ¨æµç¨‹

### ç¨‹åºå…¥å£ï¼š`Program.cs`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Main(string[] args)                                â”‚
â”‚  - è¯»å–è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„                                â”‚
â”‚  - åˆ¤æ–­æ˜¯å¼€å‘æ¨¡å¼è¿˜æ˜¯ç”Ÿäº§æ¨¡å¼                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€ æ£€æŸ¥ç¯å¢ƒå˜é‡ IMAGEINFO_DEV
          â”‚
          â”œâ”€ è‹¥æ— ç¯å¢ƒå˜é‡ â†’ ç”Ÿäº§æ¨¡å¼
          â”‚
          â””â”€ è‹¥æœ‰ç¯å¢ƒå˜é‡ â†’ å¼€å‘æ¨¡å¼ï¼ˆå¯èƒ½çš„å€¼ï¼šscanã€verifyã€å…¶ä»–ï¼‰
```

### æµç¨‹å†³ç­–æ ‘

```
Program.Main()
    â†“
GetInputFolder(args)
    â”œâ”€ args[0] å­˜åœ¨? â†’ è¿”å›å‘½ä»¤è¡Œå‚æ•°è·¯å¾„
    â”œâ”€ IMAGEINFO_DEV ç¯å¢ƒå˜é‡å­˜åœ¨? â†’ è¿”å›æµ‹è¯•è·¯å¾„
    â””â”€ äº¤äº’è¾“å…¥ â†’ è¯¢é—®ç”¨æˆ·è¾“å…¥
    â†“
IsDevelopmentMode()
    â”œâ”€ IMAGEINFO_DEV == "scan"? â†’ è°ƒç”¨ DevelopmentModeService.RunScanMode()
    â”œâ”€ IMAGEINFO_DEV == "verify"? â†’ è°ƒç”¨ DevelopmentModeService.RunFullConversionMode()
    â”œâ”€ IMAGEINFO_DEV å…¶ä»–å€¼? â†’ è°ƒç”¨ DevelopmentModeService.RunFullConversionMode()
    â””â”€ IMAGEINFO_DEV æ— å€¼? â†’ è°ƒç”¨ ProductionModeService.RunInteractiveMode()
```

---

## ğŸ¯ ç”Ÿäº§æ¨¡å¼æµç¨‹

### 1. å¯åŠ¨ï¼š`ProductionModeService.RunInteractiveMode()`

```
ProductionModeService.RunInteractiveMode(folder)
    â”œâ”€ GetConversionModeChoice()
    â”‚  â”œâ”€ æç¤ºç”¨æˆ·é€‰æ‹©è½¬æ¢æ¨¡å¼
    â”‚  â”œâ”€ 1) PNG â†’ JPG
    â”‚  â”œâ”€ 2) PNG â†’ WEBP
    â”‚  â””â”€ 3) JPG â†’ WEBP
    â”‚
    â”œâ”€ GetOutputDirectoryMode()
    â”‚  â”œâ”€ æç¤ºç”¨æˆ·é€‰æ‹©è¾“å‡ºç›®å½•æ¨¡å¼
    â”‚  â”œâ”€ 1) å…„å¼Ÿç›®å½•å¹¶å¤åˆ»ç»“æ„
    â”‚  â””â”€ 2) æœ¬åœ°å­ç›®å½•
    â”‚
    â””â”€ ConversionService.ScanConvertAndReport()
       â†“ [è§ä¸‹ä¸€æ­¥]
```

### 2. è½¬æ¢æ ¸å¿ƒï¼š`ConversionService.ScanConvertAndReport()`

```
ConversionService.ScanConvertAndReport(sourceFolder, choice, mode, openReport=true)
    â”‚
    â”œâ”€ ã€æ­¥éª¤1ï¼šæ‰«æã€‘FileScanner.GetImageFiles(sourceFolder)
    â”‚  â””â”€ é€’å½’æ‰«ææ‰€æœ‰å›¾ç‰‡æ–‡ä»¶ (.png, .jpg, .jpeg, .webp, .gif, .bmp, .tiff)
    â”‚
    â”œâ”€ ã€æ­¥éª¤2ï¼šå¤„ç†ã€‘GenerateConversionRows(sourceFolder, files, choice, mode)
    â”‚  â””â”€ å¯¹æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œ AddConversionRow() [è§ä¸‹ä¸€æ­¥]
    â”‚
    â”œâ”€ ã€æ­¥éª¤3ï¼šæŠ¥å‘Šã€‘ReportService.WriteConversionReport(rows, outPath, openAfterSave=true)
    â”‚  â””â”€ ç”Ÿæˆ Excel æŠ¥å‘Šæ–‡ä»¶ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
    â”‚
    â”œâ”€ ã€æ­¥éª¤4ï¼šè¯Šæ–­ã€‘LogAnalyzer.Analyze(sourceFolder)
    â”‚  â””â”€ åˆ†ææ—¥å¿—æ–‡ä»¶ï¼Œç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
    â”‚
    â””â”€ ã€æ­¥éª¤5ï¼šè¾“å‡ºã€‘LogAnalyzer.PrintDiagnosisToConsole()
       â””â”€ åœ¨æ§åˆ¶å°è¾“å‡ºè¯Šæ–­æ‘˜è¦
```

### 3. å•ä¸ªæ–‡ä»¶è½¬æ¢ï¼š`ConversionService.AddConversionRow()`

```
AddConversionRow(rows, srcPath, rootFolder, mode, destFormat, quality, 
                 createdUtc, modifiedUtc, aiMetadata)
    â”‚
    â”œâ”€ ã€è¯»ã€‘ReadFileTimes(srcPath)
    â”‚  â””â”€ FileTimeService è¯»å–æºæ–‡ä»¶çš„åˆ›å»º/ä¿®æ”¹æ—¶é—´
    â”‚
    â”œâ”€ ã€è¯»ã€‘ReadAIMetadata(srcPath)
    â”‚  â””â”€ MetadataExtractors è¯»å– AI å…ƒæ•°æ®
    â”‚
    â”œâ”€ ã€å†™ã€‘æ‰§è¡Œæ ¼å¼è½¬æ¢
    â”‚  â”œâ”€ PNG â†’ JPG: ImageConverter.ConvertPngToJpeg()
    â”‚  â”œâ”€ PNG â†’ WEBP: ImageConverter.ConvertPngToWebP()
    â”‚  â””â”€ JPG â†’ WEBP: ImageConverter.ConvertJpegToWebP()
    â”‚
    â”œâ”€ ã€å†™ã€‘WriteFileTimes(destPath, createdUtc, modifiedUtc)
    â”‚  â””â”€ FileTimeService å¤åˆ¶æºæ–‡ä»¶æ—¶é—´æˆ³åˆ°ç›®æ ‡æ–‡ä»¶
    â”‚
    â”œâ”€ ã€å†™ã€‘WriteAIMetadata(destPath, aiMetadata)
    â”‚  â””â”€ MetadataExtractors å†™å…¥å…ƒæ•°æ®åˆ°ç›®æ ‡æ–‡ä»¶
    â”‚
    â”œâ”€ ã€éªŒè¯ã€‘VerifyFileTimes(destPath, expectedModifiedUtc)
    â”‚  â””â”€ FileTimeService éªŒè¯æ—¶é—´æˆ³æ˜¯å¦æˆåŠŸå†™å…¥
    â”‚
    â”œâ”€ ã€éªŒè¯ã€‘VerifyAIMetadata(destPath, originalMetadata)
    â”‚  â””â”€ MetadataExtractors éªŒè¯å…ƒæ•°æ®æ˜¯å¦æˆåŠŸå†™å…¥
    â”‚
    â””â”€ ã€ä¿å­˜ã€‘å°†å®Œæ•´çš„è½¬æ¢ç»“æœæ·»åŠ åˆ° ConversionReportRow åˆ—è¡¨
```

---

## ğŸ”§ å¼€å‘æ¨¡å¼æµç¨‹

### åˆ†æ”¯1ï¼šæ‰«ææ¨¡å¼ï¼ˆ`IMAGEINFO_DEV=scan`ï¼‰

```
DevelopmentModeService.RunScanMode(folder)
    â”‚
    â”œâ”€ ã€æ­¥éª¤1ã€‘FileScanner.GetImageFiles(folder)
    â”‚  â””â”€ è·å–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶åˆ—è¡¨
    â”‚
    â”œâ”€ ã€æ­¥éª¤2ã€‘éå†æ‰€æœ‰æ–‡ä»¶ï¼Œè°ƒç”¨ MetadataExtractors.ReadAIMetadata()
    â”‚  â””â”€ åªè¯»å–å…ƒæ•°æ®ï¼Œä¸è½¬æ¢æ–‡ä»¶
    â”‚
    â”œâ”€ ã€æ­¥éª¤3ã€‘æ„å»ºå…ƒæ•°æ®è®°å½•é›†åˆ
    â”‚  â””â”€ åˆ›å»º MetadataRecord å¯¹è±¡
    â”‚
    â””â”€ ã€æ­¥éª¤4ã€‘ç”Ÿæˆ Excel æŠ¥å‘Š
       â””â”€ ä½¿ç”¨ ClosedXML å†™å…¥å…ƒæ•°æ®ç»Ÿè®¡
```

### åˆ†æ”¯2ï¼šå®Œæ•´éªŒè¯æ¨¡å¼ï¼ˆ`IMAGEINFO_DEV=verify` æˆ–å…¶ä»–å€¼ï¼‰

```
DevelopmentModeService.RunFullConversionMode(folder)
    â”‚
    â”œâ”€ è¿è¡Œ3æ¬¡ ConversionService.ScanConvertAndReport()
    â”‚  â”œâ”€ ç¬¬1æ¬¡ï¼šPNG â†’ JPG
    â”‚  â”œâ”€ ç¬¬2æ¬¡ï¼šPNG â†’ WEBP
    â”‚  â””â”€ ç¬¬3æ¬¡ï¼šJPG â†’ WEBP
    â”‚
    â””â”€ æ¯æ¬¡éƒ½è‡ªåŠ¨æ‰“å¼€ç”Ÿæˆçš„ Excel æŠ¥å‘Š
```

---

## ğŸ”„ æ ¸å¿ƒå¤„ç†æµç¨‹

### å›¾ç‰‡æ ¼å¼è½¬æ¢æµç¨‹

```
ImageConverter.Convert[Format]To[Format]()
    â”œâ”€ åŠ è½½æºæ–‡ä»¶: new MagickImage(srcPath)
    â”œâ”€ è®¾ç½®æ ¼å¼: image.Format = MagickFormat.[æ ¼å¼]
    â”œâ”€ è®¾ç½®è´¨é‡: image.Quality = (uint)quality
    â”œâ”€ å¤„ç†ç‰¹æ®Šæƒ…å†µï¼ˆå¦‚ PNGâ†’JPEG çš„é€æ˜èƒŒæ™¯å¤„ç†ï¼‰
    â””â”€ ä¿å­˜ç›®æ ‡æ–‡ä»¶: image.Write(outPath)
```

### å…ƒæ•°æ®å¤„ç†æµç¨‹

```
MetadataExtractors.ReadAIMetadata(imagePath)
    â”œâ”€ åˆ¤æ–­æ–‡ä»¶æ ¼å¼
    â”œâ”€ æ ¹æ®æ ¼å¼è°ƒç”¨ç›¸åº”çš„è¯»å–æ–¹æ³•
    â”‚  â”œâ”€ PNG: ReadPngMetadata()
    â”‚  â”œâ”€ JPEG: ReadJpegMetadata()
    â”‚  â””â”€ WebP: ReadWebPMetadata()
    â””â”€ è¿”å› AIMetadata å¯¹è±¡

MetadataExtractors.WriteAIMetadata(destImagePath, aiMetadata)
    â”œâ”€ åˆ¤æ–­æ–‡ä»¶æ ¼å¼
    â”œâ”€ æ ¹æ®æ ¼å¼è°ƒç”¨ç›¸åº”çš„å†™å…¥æ–¹æ³•
    â”‚  â”œâ”€ PNG: WritePngMetadata()
    â”‚  â”œâ”€ JPEG: WriteJpegMetadata()
    â”‚  â””â”€ WebP: WriteWebPMetadata()
    â””â”€ å…ƒæ•°æ®å†™å…¥å®Œæˆ

MetadataExtractors.VerifyAIMetadata(destImagePath, originalMetadata)
    â”œâ”€ åˆ¤æ–­æ–‡ä»¶æ ¼å¼
    â”œâ”€ è¯»å–å®é™…å†™å…¥çš„å…ƒæ•°æ®
    â”œâ”€ ä¸åŸå§‹å…ƒæ•°æ®è¿›è¡Œæ¯”å¯¹
    â””â”€ è¿”å›éªŒè¯ç»“æœï¼ˆtrue/falseï¼‰
```

### æŠ¥å‘Šç”Ÿæˆæµç¨‹

```
ReportService.WriteConversionReport(rows, outPath, openAfterSave)
    â”‚
    â”œâ”€ ã€åˆå§‹åŒ–ã€‘åˆ›å»º Excel å·¥ä½œç°¿å’Œå·¥ä½œè¡¨
    â”‚  â””â”€ å®šä¹‰ 35 åˆ—è¡¨å¤´ï¼ˆæº/ç›®æ ‡/å…ƒæ•°æ®/éªŒè¯ç­‰ï¼‰
    â”‚
    â”œâ”€ ã€è®¾ç½®æ ·å¼ã€‘
    â”‚  â”œâ”€ è®¾ç½®åˆ—å®½
    â”‚  â”œâ”€ è®¾ç½®è¡¨å¤´æ ¼å¼ï¼ˆç²—ä½“ã€ç°è‰²èƒŒæ™¯ï¼‰
    â”‚  â””â”€ å¯ç”¨æ–‡æœ¬æ¢è¡Œ
    â”‚
    â”œâ”€ ã€å¡«å……æ•°æ®ã€‘éå†æ‰€æœ‰ ConversionReportRow
    â”‚  â””â”€ å°†è½¬æ¢ç»“æœé€è¡Œå†™å…¥ Excel
    â”‚
    â”œâ”€ ã€ä¿å­˜æ–‡ä»¶ã€‘wb.SaveAs(timestampedPath)
    â”‚  â””â”€ æ–‡ä»¶åæ ¼å¼ï¼šconversion-report-yyyyMMdd-HHmmss.xlsx
    â”‚
    â”œâ”€ ã€è®°å½•æ—¥å¿—ã€‘LogReportGeneration()
    â”‚  â””â”€ å†™å…¥ conversion.logï¼ˆç»Ÿè®¡ä¿¡æ¯ï¼‰
    â”‚
    â””â”€ ã€å¯é€‰ã€‘å¦‚æœ openAfterSave=trueï¼Œç”¨ç³»ç»Ÿé»˜è®¤åº”ç”¨æ‰“å¼€
       â”œâ”€ Windows: ProcessStartInfo + UseShellExecute
       â”œâ”€ Linux: xdg-open
       â””â”€ macOS: open å‘½ä»¤
```

### æ—¥å¿—è¯Šæ–­æµç¨‹

```
LogAnalyzer.Analyze(sourceFolder)
    â”‚
    â”œâ”€ ã€åˆ†æ1ã€‘AnalyzeExtractionLog()
    â”‚  â”œâ”€ æ‰«æ metadata-extraction.log
    â”‚  â”œâ”€ ç»Ÿè®¡ ALARM äº‹ä»¶ï¼ˆå…ƒæ•°æ®ç¼ºå¤±ï¼‰
    â”‚  â””â”€ ç»Ÿè®¡ RawBytes äº‹ä»¶ï¼ˆé™çº§æå–ï¼‰
    â”‚
    â”œâ”€ ã€åˆ†æ2ã€‘AnalyzeConversionLog()
    â”‚  â”œâ”€ æ‰«æ conversion.log
    â”‚  â””â”€ æå–è½¬æ¢æ€»æ•°ã€æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
    â”‚
    â”œâ”€ ã€ç”Ÿæˆã€‘GenerateDiagnosisReport()
    â”‚  â”œâ”€ è®¡ç®—ç¼ºå¤±ç‡å’Œé™çº§ç‡
    â”‚  â”œâ”€ ç”Ÿæˆè¯Šæ–­è­¦å‘Šä¿¡æ¯
    â”‚  â””â”€ è¾“å‡ºåˆ° diagnosis.log
    â”‚
    â””â”€ ã€è¾“å‡ºã€‘PrintDiagnosisToConsole()
       â””â”€ åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯Šæ–­æ‘˜è¦
```

---

## ğŸ“¦ æ–‡ä»¶ä¾èµ–å…³ç³»

### æŒ‰è°ƒç”¨å±‚çº§åˆ†ç±»

#### ç¬¬ 0 å±‚ï¼šæ•°æ®æ¨¡å‹ï¼ˆæ— ä¾èµ–ï¼‰
```
â”œâ”€ Models/AIMetadata.cs
â”œâ”€ Models/ImageInfoModel.cs
â”œâ”€ Models/OutputDirectoryMode.cs
â””â”€ Models/ConversionReportRow.cs
```

#### ç¬¬ 1 å±‚ï¼šåŸºç¡€å·¥å…·ï¼ˆä»…ä¾èµ–æ•°æ®æ¨¡å‹ï¼‰
```
â”œâ”€ Services/FileScanner.cs
â”‚  â””â”€ åŠŸèƒ½ï¼šé€’å½’æ‰«ææ–‡ä»¶
â”‚
â”œâ”€ Services/FileTimeService.cs
â”‚  â””â”€ åŠŸèƒ½ï¼šè¯»å†™æ–‡ä»¶æ—¶é—´æˆ³
â”‚
â”œâ”€ Services/CreationTimeService.cs
â”‚  â””â”€ åŠŸèƒ½ï¼šè®¾ç½®æ–‡ä»¶åˆ›å»ºæ—¶é—´
â”‚
â”œâ”€ Services/ImageTypeDetector.cs
â”‚  â””â”€ åŠŸèƒ½ï¼šæ£€æµ‹å›¾ç‰‡æ ¼å¼
â”‚
â”œâ”€ Services/ImageConverter.cs
â”‚  â””â”€ åŠŸèƒ½ï¼šæ ¼å¼è½¬æ¢ï¼ˆPNGâ†”JPEGâ†”WebPï¼‰
â”‚
â”œâ”€ Services/ValidationService.cs
â”‚  â””â”€ åŠŸèƒ½ï¼šéªŒè¯æ–‡ä»¶å’Œè½¬æ¢ç»“æœ
â”‚
â””â”€ Services/FileBackupService.cs
   â””â”€ åŠŸèƒ½ï¼šå¤‡ä»½æºæ–‡ä»¶
```

#### ç¬¬ 2 å±‚ï¼šä¸­å±‚æœåŠ¡ï¼ˆä¾èµ–ç¬¬ 1 å±‚ï¼‰
```
â”œâ”€ Services/MetadataExtractors.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šImageTypeDetector
â”‚  â””â”€ åŠŸèƒ½ï¼šè¯»å†™éªŒè¯å…ƒæ•°æ®ï¼ˆPNG/JPEG/WebPï¼‰
â”‚
â”œâ”€ Services/MetadataWriter.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šæ— 
â”‚  â””â”€ åŠŸèƒ½ï¼šä½¿ç”¨ Magick.NET å†™å…¥å…ƒæ•°æ®
â”‚
â”œâ”€ Services/AIParameterParser.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šæ— 
â”‚  â””â”€ åŠŸèƒ½ï¼šè§£æ AI ç”Ÿæˆå‚æ•°
â”‚
â”œâ”€ Services/ProgressBarManager.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šSpectre.Console
â”‚  â””â”€ åŠŸèƒ½ï¼šæ˜¾ç¤ºè¿›åº¦æ¡å’Œç»Ÿè®¡
â”‚
â””â”€ Services/LogAnalyzer.cs
   â”œâ”€ ä¾èµ–ï¼šæ— 
   â””â”€ åŠŸèƒ½ï¼šåˆ†ææ—¥å¿—ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
```

#### ç¬¬ 3 å±‚ï¼šé«˜å±‚ä¸šåŠ¡é€»è¾‘
```
â”œâ”€ Services/ReportService.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šConversionReportRow
â”‚  â””â”€ åŠŸèƒ½ï¼šç”Ÿæˆ Excel æŠ¥å‘Š
â”‚
â”œâ”€ Services/BatchImageConverter.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šImageConverter, ProgressBarManager
â”‚  â””â”€ åŠŸèƒ½ï¼šæ‰¹é‡è½¬æ¢å’Œç»“æœè¿½è¸ª
â”‚
â”œâ”€ Services/AdvancedBatchConverter.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šProgressBarManager, ImageConverter
â”‚  â””â”€ åŠŸèƒ½ï¼šå¼‚æ­¥æ‰¹é‡è½¬æ¢
â”‚
â””â”€ Services/ConversionService.cs
   â”œâ”€ ä¾èµ–ï¼šFileScanner, FileTimeService, MetadataExtractors, 
   â”‚        ImageConverter, ReportService, LogAnalyzer
   â””â”€ åŠŸèƒ½ï¼šå®Œæ•´çš„è½¬æ¢æµç¨‹ç¼–æ’
```

#### ç¬¬ 4 å±‚ï¼šæ¨¡å¼æœåŠ¡
```
â”œâ”€ Services/ProductionModeService.cs
â”‚  â”œâ”€ ä¾èµ–ï¼šConversionService, OutputDirectoryMode
â”‚  â””â”€ åŠŸèƒ½ï¼šç”Ÿäº§æ¨¡å¼äº¤äº’èœå•
â”‚
â””â”€ Services/DevelopmentModeService.cs
   â”œâ”€ ä¾èµ–ï¼šFileScanner, MetadataExtractors, ReportService, ConversionService
   â””â”€ åŠŸèƒ½ï¼šå¼€å‘è°ƒè¯•åŠŸèƒ½é›†
```

#### ç¬¬ 5 å±‚ï¼šç¨‹åºå…¥å£
```
â””â”€ Program.cs
   â”œâ”€ ä¾èµ–ï¼šProductionModeService, DevelopmentModeService
   â””â”€ åŠŸèƒ½ï¼šä¸»ç¨‹åºæµç¨‹æ§åˆ¶
```

---

## ğŸ”€ æ•°æ®æµå‘å›¾

### ç”Ÿäº§æ¨¡å¼ï¼šPNG â†’ JPG è½¬æ¢ç¤ºä¾‹

```
ç”¨æˆ·è¾“å…¥
    â†“
Program.Main()
    â†“ GetInputFolder() â†’ è·å–æºæ–‡ä»¶å¤¹è·¯å¾„
    â†“
ProductionModeService.RunInteractiveMode()
    â”œâ”€ GetConversionModeChoice() â†’ ç”¨æˆ·é€‰ 1 (PNGâ†’JPG)
    â”œâ”€ GetOutputDirectoryMode() â†’ ç”¨æˆ·é€‰ 1 (å…„å¼Ÿç›®å½•)
    â†“
ConversionService.ScanConvertAndReport(folder, choice=1, mode=1)
    â”œâ”€ FileScanner.GetImageFiles(folder)
    â”‚  â””â”€ è·å–æ–‡ä»¶åˆ—è¡¨ï¼š[photo1.png, photo2.png, ...]
    â”‚
    â”œâ”€ GenerateConversionRows()
    â”‚  â”œâ”€ å¯¹æ¯ä¸ª photo.png æ‰§è¡Œï¼š
    â”‚  â”‚  â”œâ”€ FileTimeService.ReadFileTimes(photo.png)
    â”‚  â”‚  â”‚  â””â”€ è¯»å–æ—¶é—´æˆ³ï¼šcreated=2025-01-01, modified=2025-01-02
    â”‚  â”‚  â”‚
    â”‚  â”‚  â”œâ”€ MetadataExtractors.ReadAIMetadata(photo.png)
    â”‚  â”‚  â”‚  â”œâ”€ åˆ¤æ–­æ ¼å¼ï¼šPNG
    â”‚  â”‚  â”‚  â”œâ”€ è¯»å– PNG tEXt å—
    â”‚  â”‚  â”‚  â””â”€ è¿”å›ï¼šAIMetadata{prompt="...", seed="...", ...}
    â”‚  â”‚  â”‚
    â”‚  â”‚  â”œâ”€ ImageConverter.ConvertPngToJpeg(photo.png, photo.jpg, quality=85)
    â”‚  â”‚  â”‚  â”œâ”€ åŠ è½½ï¼šnew MagickImage("photo.png")
    â”‚  â”‚  â”‚  â”œâ”€ è½¬æ¢ï¼šimage.Format = Jpeg
    â”‚  â”‚  â”‚  â”œâ”€ è®¾ç½®è´¨é‡ï¼šimage.Quality = 85
    â”‚  â”‚  â”‚  â”œâ”€ å¤„ç†é€æ˜èƒŒæ™¯ï¼šBackgroundColor = White
    â”‚  â”‚  â”‚  â””â”€ ä¿å­˜ï¼šimage.Write("photo.jpg")
    â”‚  â”‚  â”‚
    â”‚  â”‚  â”œâ”€ FileTimeService.WriteFileTimes(photo.jpg, created, modified)
    â”‚  â”‚  â”‚  â””â”€ å¤åˆ¶æ—¶é—´æˆ³åˆ° photo.jpg
    â”‚  â”‚  â”‚
    â”‚  â”‚  â”œâ”€ MetadataExtractors.WriteAIMetadata(photo.jpg, aiMetadata)
    â”‚  â”‚  â”‚  â”œâ”€ åˆ¤æ–­æ ¼å¼ï¼šJPEG
    â”‚  â”‚  â”‚  â”œâ”€ è½¬æ¢ AIMetadata ä¸º JSON å­—ç¬¦ä¸²
    â”‚  â”‚  â”‚  â”œâ”€ å†™å…¥ JPEG EXIF.ImageDescription
    â”‚  â”‚  â”‚  â””â”€ éªŒè¯å†™å…¥æˆåŠŸ
    â”‚  â”‚  â”‚
    â”‚  â”‚  â”œâ”€ FileTimeService.VerifyFileTimes(photo.jpg, modified)
    â”‚  â”‚  â”‚  â””â”€ éªŒè¯æ—¶é—´æˆ³ï¼ˆå®¹å·® Â±2ç§’ï¼‰ï¼šâœ“ é€šè¿‡
    â”‚  â”‚  â”‚
    â”‚  â”‚  â”œâ”€ MetadataExtractors.VerifyAIMetadata(photo.jpg, aiMetadata)
    â”‚  â”‚  â”‚  â””â”€ éªŒè¯å…ƒæ•°æ®ï¼šâœ“ é€šè¿‡
    â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€ åˆ›å»º ConversionReportRow{
    â”‚  â”‚      SourcePath="photo.png", DestPath="photo.jpg",
    â”‚  â”‚      SourceWidth=1920, SourceHeight=1080, SourceFormat="PNG",
    â”‚  â”‚      DestWidth=1920, DestHeight=1080, DestFormat="JPG",
    â”‚  â”‚      Success=true, AIPrompt="...", ...
    â”‚  â”‚    }
    â”‚
    â”œâ”€ ReportService.WriteConversionReport(rows, "conversion-report.xlsx", openAfterSave=true)
    â”‚  â”œâ”€ åˆ›å»º Excel å·¥ä½œç°¿
    â”‚  â”œâ”€ å®šä¹‰ 35 åˆ—è¡¨å¤´
    â”‚  â”œâ”€ å¾ªç¯å†™å…¥æ¯è¡Œæ•°æ®
    â”‚  â”œâ”€ è®¾ç½®æ ¼å¼å’Œæ ·å¼
    â”‚  â”œâ”€ ä¿å­˜ä¸º conversion-report-20250121-143022.xlsx
    â”‚  â”œâ”€ LogReportGeneration() å†™å…¥æ—¥å¿—
    â”‚  â””â”€ Process.Start() æ‰“å¼€ Excel
    â”‚
    â”œâ”€ LogAnalyzer.Analyze(folder)
    â”‚  â”œâ”€ æ‰«æ metadata-extraction.log
    â”‚  â”œâ”€ æ‰«æ conversion.log
    â”‚  â””â”€ ç”Ÿæˆ diagnosis.log å’Œ DiagnosisReport
    â”‚
    â””â”€ LogAnalyzer.PrintDiagnosisToConsole()
       â””â”€ åœ¨æ§åˆ¶å°æ‰“å°è¯Šæ–­æ‘˜è¦

æœ€ç»ˆè¾“å‡º
    â”œâ”€ conversion-report-yyyyMMdd-HHmmss.xlsx (Excel æŠ¥å‘Š)
    â”œâ”€ conversion.log (è½¬æ¢æ—¥å¿—)
    â”œâ”€ diagnosis.log (è¯Šæ–­æŠ¥å‘Š)
    â””â”€ æ§åˆ¶å°è¾“å‡º (è¯Šæ–­æ‘˜è¦)
```

---

## ğŸ”¢ æ‰§è¡Œæ—¶é—´ä¼°ç®—

| æ­¥éª¤ | æ–‡ä»¶æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | å¤‡æ³¨ |
|------|--------|----------|------|
| æ‰«ææ–‡ä»¶ | FileScanner | O(n) | n = æ–‡ä»¶æ•°é‡ |
| è¯»å…ƒæ•°æ® | MetadataExtractors | O(n) | æ¯ä¸ªæ–‡ä»¶ ~10-50ms |
| æ ¼å¼è½¬æ¢ | ImageConverter | O(n) | æ¯ä¸ªæ–‡ä»¶ ~500-2000ms |
| å†™å…ƒæ•°æ® | MetadataExtractors | O(n) | æ¯ä¸ªæ–‡ä»¶ ~20-100ms |
| ç”ŸæˆæŠ¥å‘Š | ReportService | O(n) | æ¯ä¸ªæ–‡ä»¶ ~5-20ms |
| åˆ†ææ—¥å¿— | LogAnalyzer | O(m) | m = æ—¥å¿—è¡Œæ•° |

**æ€»ä½“æ—¶é—´**: O(n)ï¼Œå¤§çº¦ 100 å¼ å›¾ç‰‡éœ€è¦ ~2-5 åˆ†é’Ÿ

---

## ğŸ’¾ å…³é”®æ–‡ä»¶è¾“å‡º

### ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶å | ä½ç½® | è¯´æ˜ |
|------|------|------|
| `conversion-report-yyyyMMdd-HHmmss.xlsx` | æºæ–‡ä»¶å¤¹ | è½¬æ¢ç»“æœæŠ¥å‘Š |
| `conversion.log` | æºæ–‡ä»¶å¤¹ | è½¬æ¢ç»Ÿè®¡æ—¥å¿— |
| `diagnosis.log` | æºæ–‡ä»¶å¤¹ | è¯Šæ–­åˆ†ææŠ¥å‘Š |
| `metadata-extraction.log` | å·¥ä½œç›®å½• | å…ƒæ•°æ®æå–æ—¥å¿— |
| `metadata-writer.log` | å·¥ä½œç›®å½• | å…ƒæ•°æ®å†™å…¥æ—¥å¿— |
| `[è¾“å‡ºæ–‡ä»¶]/*.jpg/.webp` | æŒ‡å®šè¾“å‡ºç›®å½• | è½¬æ¢åçš„å›¾ç‰‡æ–‡ä»¶ |

---

## ğŸ“ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šç”Ÿäº§ç”¨æˆ· - æ‰¹é‡è½¬æ¢å›¾ç‰‡

```bash
# åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ
ImageInfo.exe "C:\MyPhotos"

â†’ ç¨‹åºå¯åŠ¨
â†’ è¯¢é—®ï¼šé€‰æ‹©è½¬æ¢æ¨¡å¼ï¼ˆPNGâ†’JPG / PNGâ†’WEBP / JPGâ†’WEBPï¼‰
â†’ è¯¢é—®ï¼šé€‰æ‹©è¾“å‡ºç›®å½•æ¨¡å¼ï¼ˆå…„å¼Ÿç›®å½• / æœ¬åœ°å­ç›®å½•ï¼‰
â†’ æ‰§è¡Œè½¬æ¢
â†’ æ‰“å¼€ Excel æŠ¥å‘Š
â†’ æ§åˆ¶å°è¾“å‡ºè¯Šæ–­ä¿¡æ¯
```

### åœºæ™¯2ï¼šå¼€å‘è€… - æ‰«æå’Œè¯Šæ–­å…ƒæ•°æ®

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
SET IMAGEINFO_DEV=scan
ImageInfo.exe "C:\TestPhotos"

â†’ ç¨‹åºè¿›å…¥å¼€å‘æ¨¡å¼
â†’ åªè¯»å–å…ƒæ•°æ®ï¼ˆä¸è½¬æ¢æ–‡ä»¶ï¼‰
â†’ ç”Ÿæˆ Excel å…ƒæ•°æ®æŠ¥å‘Š
â†’ è¾“å‡ºè¯Šæ–­ä¿¡æ¯
```

### åœºæ™¯3ï¼šè´¨é‡æ£€æŸ¥ - éªŒè¯ä¸‰ç§è½¬æ¢æ–¹å¼

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
SET IMAGEINFO_DEV=verify
ImageInfo.exe "C:\TestPhotos"

â†’ ç¨‹åºè¿›å…¥å®Œæ•´éªŒè¯æ¨¡å¼
â†’ è¿è¡Œ PNGâ†’JPG è½¬æ¢å¹¶ç”ŸæˆæŠ¥å‘Š
â†’ è¿è¡Œ PNGâ†’WEBP è½¬æ¢å¹¶ç”ŸæˆæŠ¥å‘Š
â†’ è¿è¡Œ JPGâ†’WEBP è½¬æ¢å¹¶ç”ŸæˆæŠ¥å‘Š
â†’ æ¯å®Œæˆä¸€æ¬¡éƒ½è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Š
```

---

## ğŸ“ æ€»ç»“

ç¨‹åºçš„æ‰§è¡Œæµç¨‹é‡‡ç”¨äº†**åˆ†å±‚è®¾è®¡**ï¼š

1. **å…¥å£å±‚** (Program.cs) - è´Ÿè´£å‚æ•°è§£æå’Œæ¨¡å¼é€‰æ‹©
2. **æ¨¡å¼å±‚** (ProductionModeService / DevelopmentModeService) - å¤„ç†ä¸åŒè¿è¡Œæ¨¡å¼
3. **ä¸šåŠ¡å±‚** (ConversionService / BatchImageConverter) - å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
4. **æœåŠ¡å±‚** (å„ä¸ª Service ç±») - æä¾›ç»†ç²’åº¦çš„åŠŸèƒ½ç»„ä»¶
5. **æ•°æ®å±‚** (Models) - å®šä¹‰æ•°æ®ç»“æ„

**æ‰§è¡Œæµçš„å…³é”®ç‰¹ç‚¹**ï¼š

- âœ… **æ¨¡å—åŒ–**: å„å±‚èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- âœ… **å¯è§‚æµ‹**: å®Œæ•´çš„æ—¥å¿—ã€æŠ¥å‘Šå’Œè¯Šæ–­è¾“å‡º
- âœ… **å®¹é”™æ€§**: å•ä¸ªæ–‡ä»¶å¤±è´¥ä¸å½±å“æ•´ä½“å¤„ç†
- âœ… **çµæ´»æ€§**: æ”¯æŒä¸åŒçš„è½¬æ¢æ¨¡å¼å’Œè¾“å‡ºç›®å½•æ¨¡å¼
- âœ… **å¯éªŒè¯**: å†…ç½®ä¸‰å±‚éªŒè¯æœºåˆ¶ï¼ˆæ—¶é—´æˆ³ã€å…ƒæ•°æ®ã€è½¬æ¢ç»“æœï¼‰

