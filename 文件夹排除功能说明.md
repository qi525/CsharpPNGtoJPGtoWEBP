# FileScanner 改进：文件夹排除功能

## 问题描述

在扫描目录时，会扫描到一些不需要的文件夹内的文件，例如：
- `.bf`（Stable Diffusion WebUI 的 BeautifulSoup 缓存）
- `.preview`（预览缓存文件夹）
- `.thumbnails`（缩略图缓存）
- `__pycache__`（Python 缓存）
- 等等

例如扫描路径：
```
C:\stable-diffusion-webui\outputs\txt2img-images\.bf\.preview\ff\image.png
```

这些路径中包含的文件不应该被扫描，但原来的代码仍然会扫描它们。

## 解决方案

### 1. 添加排除文件夹名称列表

在 `FileScanner.cs` 中添加了 `ExcludedFolderNames` 数组，包含默认的需要排除的文件夹名称：

```csharp
private static readonly string[] ExcludedFolderNames = new[] 
{ 
    ".bf", 
    ".preview", 
    ".thumbnails",
    ".cache",
    "__pycache__",
    ".git",
    ".svn",
    "node_modules"
};
```

### 2. 实现路径检查函数

添加了 `ShouldSkipFile()` 私有方法，用来检查文件路径是否包含需要排除的文件夹：

```csharp
private static bool ShouldSkipFile(string filePath)
{
    // 将路径分解为各个部分
    var parts = filePath.Split(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);
    
    // 检查是否有任何部分匹配排除的文件夹名称
    foreach (var part in parts)
    {
        if (ExcludedFolderNames.Contains(part, System.StringComparer.OrdinalIgnoreCase))
            return true;
    }
    
    return false;
}
```

**关键特性：**
- ✓ 不区分大小写（`.BF` 和 `.bf` 都会被排除）
- ✓ 支持嵌套排除（如果路径中的任何层级包含排除的文件夹名，整个文件都会被跳过）
- ✓ 高效：在过滤扩展名之前就进行路径检查

### 3. 修改 GetImageFiles 方法

在主扫描方法中添加了路径过滤：

```csharp
public static IEnumerable<string> GetImageFiles(string root)
{
    if (!Directory.Exists(root))
        return Enumerable.Empty<string>();

    return Directory.EnumerateFiles(root, "*", SearchOption.AllDirectories)
        .Where(f => !ShouldSkipFile(f))  // 先过滤掉包含排除文件夹的文件
        .Where(f => ImageExtensions.Contains(Path.GetExtension(f).ToLowerInvariant()));
}
```

### 4. 添加公共方法

- `GetExcludedFolders()`：获取当前的排除文件夹列表，用于日志和配置展示
- 为未来的扩展预留了 `AddExcludedFolders()` 方法的框架

## 测试验证

创建了测试程序 `TestScannerExclude` 来验证功能，测试结果：

```
✓ .bf 文件夹中的文件被正确排除
✓ .preview 文件夹中的文件被正确排除
✓ 根目录中的文件被正确包含
✓ 正常子目录中的文件被正确包含
```

测试场景：
```
C:\temp\test_scan
├─ root.png                           ✓ 被扫描
├─ normal_subfolder\sub.png           ✓ 被扫描
├─ .bf\excluded_bf.png                ✗ 被排除
├─ .bf\.preview\excluded_nested.png   ✗ 被排除
└─ .preview\excluded_preview.png      ✗ 被排除
```

## 使用方法

### 基础使用（自动排除默认文件夹）

```csharp
var imageFiles = FileScanner.GetImageFiles(@"C:\path\to\scan");
// 自动排除 .bf, .preview 等文件夹中的文件
```

### 查看被排除的文件夹列表

```csharp
var excluded = FileScanner.GetExcludedFolders();
foreach (var folder in excluded)
{
    Console.WriteLine($"排除: {folder}");
}
```

## 性能影响

- **正向影响**：减少了需要处理的文件数量，总处理时间减少
- **路径检查开销**：每个文件执行一次字符串分割和比较，开销极小（<1ms）
- **整体效果**：性能提升（因为排除了大量缓存文件）

## 默认排除列表说明

| 文件夹名 | 来源 | 说明 |
|---------|------|------|
| `.bf` | Stable Diffusion WebUI | BeautifulSoup 缓存 |
| `.preview` | 多个工具 | 预览缓存 |
| `.thumbnails` | 系统/应用 | 缩略图缓存 |
| `.cache` | 系统/应用 | 通用缓存 |
| `__pycache__` | Python | Python 编译缓存 |
| `.git` | Git | 版本控制 |
| `.svn` | SVN | 版本控制 |
| `node_modules` | Node.js | 依赖包 |

## 未来改进空间

1. 从配置文件读取排除列表，支持用户自定义
2. 支持通配符模式（如 `.*` 表示所有隐藏文件夹）
3. 支持白名单模式（只扫描指定的文件夹）
4. 添加排除列表的运行时修改功能
5. 性能优化：使用 HashSet 和并行扫描

## 相关文件修改

- **修改文件**：`src/ImageInfo/Services/FileScanner.cs`
- **测试程序**：`TestScannerExclude/Program.cs`
- **编译状态**：✓ 编译成功，0 警告，0 错误

## 兼容性

- ✓ 完全向后兼容
- ✓ 不改变 API 签名
- ✓ 不改变返回类型
- ✓ 只是增加了过滤逻辑

---

**日期**：2025-11-23  
**状态**：✅ 完成并测试
