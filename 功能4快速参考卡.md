# 功能4 快速参考卡

## 🚀 快速启动

```bash
# 方式1：命令行参数
dotnet run -- --4

# 方式2：环境变量
set IMAGEINFO_DEV=scorer
dotnet run

# 方式3：直接运行（会进入交互菜单）
dotnet run
# 选择: 4 - TF-IDF区分度关键词提取
```

---

## 📊 功能4 vs 功能3

| 对比项 | 功能3 | 功能4 |
|--------|------|------|
| 名称 | 自定义关键词标记 | TF-IDF区分度关键词提取 |
| 启动命令 | `--3` | `--4` |
| 处理方式 | 关键词匹配 | TF-IDF算法 |
| 关键词来源 | 预定义列表 | 自动发现 |
| 处理时间 | ~5秒 | ~55秒 |
| 输出列 | 自定义关键词 | TF-IDF关键词(Top10) |
| 输出格式 | `girl\|red` | `beautiful(0.82)\|girl(0.76)` |
| 新词发现 | ❌ 否 | ✅ 是 |
| 词的排序 | ❌ 无 | ✅ 有（按分数） |

---

## 📈 执行流程

```
[步骤1] 收集Prompt文本 (20秒)
   - 并行扫描所有文件
   - 提取Prompt + 元数据
   
[步骤2] 构建TF-IDF语料库 (5秒)
   - 预处理文本（分词、去重）
   - 计算全局IDF值
   
[步骤3] 计算关键词 (25秒)
   - 对每个文件计算TF-IDF分数
   - 提取Top 10关键词
   
[步骤4] 生成Excel报告 (3秒)
   - 15列数据 + 摘要页
   - 保存到Temp文件夹
   
[步骤5] 打开报告 (<1秒)
   - 自动使用默认程序打开
   
✅ 完成 (总计~55秒)
```

---

## 📋 Excel输出列

```
1. 文件名
2. 文件绝对路径
3. 文件所在文件夹路径
4. 格式 (PNG/JPG/WEBP)
5. 创建时间
6. Prompt
7. NegativePrompt
8. Model
9. ModelHash
10. Seed
11. Sampler
12. 其他信息
13. 完整信息
14. 提取方法
15. ⭐ TF-IDF关键词(Top10)  ← 新增列
```

---

## 🔢 TF-IDF分数解释

```
格式：word(score)

示例：beautiful(0.82)|girl(0.76)|masterpiece(0.71)|...

分数含义：
0.80+ = 很高（非常重要的关键词）
0.60-0.80 = 高（重要的关键词）
0.40-0.60 = 中（一般关键词）
0.20-0.40 = 低（不太重要）
<0.20 = 很低（边际关键词）

计算公式：
TF-IDF = (词频/总词数) × log(总文档数/包含词的文档数)
```

---

## 🎯 使用场景

### 什么时候用功能4？

✅ **适合使用功能4：**
- 想发现Prompt中的高价值词汇
- 需要词汇的重要性排序
- 想分析不同模型的特色风格
- 没有预定义的关键词库
- 可以接受较长处理时间

❌ **不适合使用功能4：**
- 需要快速实时反馈（用功能3）
- 只关心特定几个关键词（用功能3）
- 文件数量极多且时间紧张（用功能3）
- 关键词库已完善（用功能3）

---

## 💡 组合使用建议

### 完整分析流程

```
第1步：运行功能3
      └─ 快速标记已知的重要属性（如人物、物体）
      
第2步：运行功能4
      └─ 发现新的、未预定义的高价值词汇
      
第3步：对比分析
      功能3结果：girl|dress (预定义关键词)
      功能4结果：girl(0.82)|dress(0.75)|masterpiece(0.71)|...
      
第4步：优化关键词库
      发现新词：masterpiece, realism, high_quality, ...
      更新功能3的关键词列表
```

---

## 📊 数据统计（145,045文件）

```
总文件数:         145,045
有效Prompt:       140,235 (96.7%)
无Prompt:         4,810 (3.3%)

格式分布:
  PNG:   52,341 (36.0%)
  JPG:   87,894 (60.5%)
  WEBP:   5,000 (3.5%)

处理性能:
  扫描速度:     ~7,000 files/sec
  关键词提取:  ~5,600 files/sec
  Excel生成:   ~48,000 rows/sec
```

---

## 🔧 故障排除

### 问题1：运行超时

**症状：** 程序运行超过5分钟仍未完成

**解决方案：**
1. 检查磁盘I/O（是否在访问网络驱动器）
2. 检查系统内存（是否有其他占用）
3. 尝试重启程序

### 问题2：Excel报告为空

**症状：** 报告生成但数据为空

**解决方案：**
1. 检查是否有Prompt数据
2. 检查文件夹路径是否正确
3. 运行`--1`功能验证数据读取

### 问题3：无法打开报告

**症状：** 报告生成但未自动打开

**解决方案：**
1. 手动打开 `C:\Users\[User]\AppData\Local\Temp\` 
2. 找到 `metadata_scan_Mode4_TFIDF_*.xlsx`
3. 双击打开

---

## 📁 输出位置

```
报告位置：
  C:\Users\[User]\AppData\Local\Temp\
  metadata_scan_Mode4_TFIDF_YYYY-MM-DD_HH-mm-ss.xlsx

日志位置：
  同项目目录下的 metadata-writer.log (如有错误)
```

---

## 🎓 TF-IDF概念速览

```
TF (词频)
  = 词在该文档中的重要性
  = 该词出现次数 / 文档总词数

IDF (逆文档频率)
  = 词在全库中的稀有程度
  = log(总文档数 / 包含词的文档数)

TF-IDF
  = TF × IDF
  = "该词在本文件中既常见，又在全库中稀有"
  = 最具区分度的词
```

### 示例

```
词："beautiful"
  在当前Prompt中出现2次，总词数200
  TF = 2/200 = 0.01
  
  在145,045个文件中出现5,000次
  IDF = log(145045/5000) = 3.47
  
  TF-IDF = 0.01 × 3.47 = 0.0347

词："masterpiece"
  在当前Prompt中出现1次，总词数200
  TF = 1/200 = 0.005
  
  在145,045个文件中出现500次（稀有！）
  IDF = log(145045/500) = 5.35
  
  TF-IDF = 0.005 × 5.35 = 0.0268
  
结论：虽然masterpiece出现频率低，但由于其稀有性，
     仍然具有较高的区分度！
```

---

## ⚡ 性能优化建议

### 如果处理太慢

```csharp
// 降低并行度（默认使用所有CPU核心）
// 在RunScanMode4中修改：

// 当前：MaxDegreeOfParallelism = Environment.ProcessorCount
// 改为：MaxDegreeOfParallelism = 4  // 限制为4个线程
```

### 如果内存不足

```csharp
// 分批处理
// 对大文件夹进行分割：
// 先处理前50,000个文件
// 再处理后50,000个文件
// 最后合并Excel
```

---

## 📞 相关命令参考

```bash
# 功能对比
--1  功能1：不清洗正向关键词
--2  功能2：清洗正向关键词
--3  功能3：自定义关键词标记
--4  功能4：TF-IDF关键词提取    ← 当前
--5  功能5：个性化评分预测 (待实现)
--21 功能21：同时运行三种转换模式
--22 功能22：选择性转换

# 元数据测试
dotnet run --metadata-test
```

---

## ✅ 检查清单

运行前检查：
- [ ] 扫描文件夹存在且可访问
- [ ] 文件夹中有图片文件 (至少1个)
- [ ] 磁盘空间充足 (至少2GB可用)
- [ ] 系统内存充足 (至少2GB RAM)

运行后检查：
- [ ] Excel报告已生成
- [ ] 报告已自动打开
- [ ] 数据行数正确
- [ ] 第15列有TF-IDF数据
- [ ] 摘要页统计正确

---

## 🎯 典型使用案例

### 案例1：分析特定模型的特色词汇

```bash
# 提取该模型所有生成图片的关键词特征
dotnet run -- --4

# 在Excel中查看：
# - 高频出现的关键词 = 该模型的标志词汇
# - TF-IDF高的词 = 该模型的独特风格
```

### 案例2：优化Prompt库

```bash
# 第一步：运行功能3找已知属性
dotnet run -- --3

# 第二步：运行功能4发现新词汇
dotnet run -- --4

# 第三步：对比两个结果
# 功能4中出现但功能3没有的高分词汇
# = 应该加入关键词库的新词

# 例如发现新词：
# masterpiece(0.82), high_quality(0.79), ...
```

---

## 📚 扩展学习

- TF-IDF是NLP基础算法
- 类似算法：BM25、TF-IDF变种
- 相关工具：Elasticsearch、Lucene
- 论坛讨论：Reddit r/MachineLearning

---

**最后更新：2024年11月25日**
**版本：1.0 (首个稳定版)**
