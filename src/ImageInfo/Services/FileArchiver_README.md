# FileArchiver 文件归档器 - 实现注意事项

## 概述

`FileArchiver` 是核心的文件归档模块，负责将图片文件从源目录安全移动到按日期组织的归档目录。

**难度系数**：8/10（涉及复杂的目录扫描、多重安全检查、日期目录创建和并发计数）

---

## 主流程说明

### ExecuteArchiving 方法

主流程在 `FileArchiver.cs` 的 `ExecuteArchiving()` 方法内，完整的流程步骤如下：

1. **验证根目录存在性** - 检查源目录是否可访问
2. **扫描待归档文件** - 递归扫描并过滤符合条件的图片文件
3. **生成预览统计** - 按日期文件夹分组统计，展示待归档文件清单
4. **用户确认** - 用户输入 `y` 才继续，否则流程终止（安全门）
5. **并行归档处理** - 使用 Spectre.Console 进度条，并发处理文件
6. **打印最终统计** - 展示成功、失败和跳过的详细分类统计
7. **清理空文件夹** - 安全删除归档后遗留的空目录

---

## 核心安全机制

### 1. 多重保护关键词检查

**保护关键词**：`"超"`, `"精"`, `"特"`, `"处"`

- **位置1**：扫描阶段（ScanFilesToArchive）- 跳过包含关键词的整个文件夹目录
- **位置2**：移动阶段（ProcessFileForArchiving）- 二次检查源文件路径（确保万无失一）
- **位置3**：清理阶段（CleanEmptyDirectories）- 避免误删含保护关键词的目录

**实现方法**：`IsPathProtected()` 递归检查路径中的所有目录名，确保多层级保护

```csharp
// 示例：含有保护关键词的目录结构
C:\...\txt2img-images\超级精选  ❌ 不会被处理
C:\...\txt2img-images\2024-09-15\精选图片  ❌ 不会被处理
```

### 2. 排除特殊文件夹

**排除规则**：`.bf` 文件夹（程序缓存，非目标文件）

- 在扫描阶段跳过
- 在清理阶段不删除

### 3. 图片文件白名单

**支持的文件后缀**：`.png`, `.jpg`, `.jpeg`, `.webp`

- 只有符合后缀的文件才会被归档
- 其他文件被计为"跳过 (非图片文件)"

### 4. 冲突检测与保护

在 `MoveFileSafe()` 中实现：

| 冲突类型 | 处理方式 | 状态记录 |
|---------|--------|--------|
| 目标文件已存在 | 跳过（避免覆盖） | "跳过 (目标图片文件冲突)" |
| 源与目标路径相同 | 跳过（幂等性保护） | "跳过 (源与目标路径相同)" |
| SafeMoveProtection 拒绝 | 跳过 | "安全跳过 (SafeMoveProtection)" |
| 权限或IO异常 | 记录错误并继续 | "移动失败/异常" |

### 5. 预览与用户确认

**新增的安全门**：

```
--- 归档预览 ---
日期文件夹: 2025-12-07  归档数量: 150
  - C:\...\image1.png
  - C:\...\image2.jpg
  ... 还有 140 个文件未显示

总计待归档文件: 150 个
是否继续归档？输入 y 确认，其他键取消：
```

用户必须显式输入 `y` 才能继续，防止误操作。

---

## 并发处理

### 进度条实现

使用 **Spectre.Console** 替代 ShellProgressBar：

```csharp
AnsiConsole.Progress()
    .Columns(new ProgressColumn[]
    {
        new TaskDescriptionColumn(),    // 任务名称
        new ProgressBarColumn(),        // 进度条
        new PercentageColumn(),         // 百分比
        new RemainingTimeColumn(),      // 剩余时间
    })
    .Start(ctx => { ... });
```

### 并发度控制

```csharp
MaxDegreeOfParallelism = Environment.ProcessorCount
```

根据 CPU 核心数自动调整，充分利用硬件性能。

---

## 风险分析与限制

### 能够规避的风险 ✅

1. **误删保护目录** - 通过关键词和二次检查防止
2. **文件覆盖冲突** - 检查目标文件是否已存在
3. **权限问题** - try-catch 捕获异常，详细日志记录
4. **误操作** - 归档前预览+用户确认
5. **并发数据竞争** - 使用 ConcurrentDictionary 进行计数

### 无法完全消除的风险 ⚠️

1. **磁盘故障或掉线** - 文件系统级故障无法预防
2. **权限动态变更** - 运行过程中权限被收回
3. **外部进程干扰** - 其他程序同时修改目标目录
4. **配置被篡改** - 保护关键词被修改后的恶意操作
5. **极小概率的 Race Condition** - 尽管概率极低，但并发操作中仍可能发生

### 现有的局限性

- **不支持回滚** - 已归档的文件无法自动恢复
- **不支持 Dry-Run** - 无模拟演练模式
- **日志持久化不足** - 操作日志仅打印到控制台，未存储到文件
- **缺少操作审计** - 未记录谁、何时、执行了什么操作

---

## 最佳实践建议

### 生产环境前

- [ ] **充分测试** - 在测试数据上运行，验证逻辑正确性
- [ ] **备份关键数据** - 在归档前备份历史目录和待归档目录
- [ ] **权限加固** - 限制操作人员和程序的文件系统权限
- [ ] **监控磁盘空间** - 确保目标目录有足够空间

### 运行过程中

- [ ] **仔细阅读预览** - 确认待归档文件列表无误
- [ ] **观察进度条** - 监控是否有异常中断或性能下降
- [ ] **检查日志输出** - 关注是否有权限错误或其他异常

### 运行后

- [ ] **验证归档结果** - 核实文件是否正确移动到目标目录
- [ ] **清理验证** - 确认空文件夹被正确清理（或未被清理的原因）
- [ ] **保留日志** - 复制控制台输出或重定向到日志文件，以备审计

---

## 未来增强功能

如需进一步提升安全性，可考虑以下功能：

1. **Dry-Run 模式** - 模拟归档流程，不实际移动文件
2. **操作日志持久化** - 将所有操作记录到日志文件
3. **回滚支持** - 记录映射关系，支持将文件还原到原位置
4. **操作审计日志** - 记录执行者、执行时间、操作详情
5. **异常恢复机制** - 针对中断场景的恢复策略
6. **邮件或 Webhook 通知** - 在归档完成或出错时发送告警
7. **数据库审计表** - 存储所有操作记录便于后续查询和追踪

---

## 相关代码文件

- **主实现文件**：`FileArchiver.cs`
- **安全保护模块**：`SafeMoveProtection.cs`
- **调用入口**：`Program.cs` 的 `case "32"` 分支

---

## 更新历史

| 日期 | 变更 | 说明 |
|------|------|------|
| 2025-12-07 | 添加预览+确认 | 用户确认前展示待归档文件清单 |
| 2025-12-07 | 文档创建 | 记录实现细节和安全注意事项 |

