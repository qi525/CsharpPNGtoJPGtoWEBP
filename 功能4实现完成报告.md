# åŠŸèƒ½4å®ç°å®Œæˆæ€»ç»“

## ğŸ“‹ åŠŸèƒ½4å®ç°çŠ¶æ€

âœ… **å·²å®Œæˆ** - åŠŸèƒ½4ï¼ˆTF-IDFåŒºåˆ†åº¦å…³é”®è¯æå–ï¼‰å·²æˆåŠŸå®ç°å¹¶å¯è¿è¡Œ

---

## ğŸ¯ åŠŸèƒ½4å®šä¹‰

**åŠŸèƒ½4ï¼šTF-IDFåŒºåˆ†åº¦å…³é”®è¯æå–** æ˜¯åŠŸèƒ½3çš„å¼ºåŒ–è¡¥å……ï¼ˆNOTæ›¿ä»£ï¼‰

- **åŠŸèƒ½3**ï¼šåŸºäºé¢„å®šä¹‰å…³é”®è¯åˆ—è¡¨çš„æ ‡ç­¾åŒ¹é…
- **åŠŸèƒ½4**ï¼šåŸºäºTF-IDFç®—æ³•çš„æ™ºèƒ½å…³é”®è¯æå–

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### æ‰§è¡Œæµç¨‹ï¼ˆ5ä¸ªæ­¥éª¤ï¼‰

```
[æ­¥éª¤1] æ”¶é›†Promptæ–‡æœ¬å¹¶åˆå§‹åŒ–TF-IDFå¤„ç†å™¨
   â†“ å¹¶è¡Œæ‰«ææ‰€æœ‰æ–‡ä»¶
   â†“ æå–Prompt + å…ƒæ•°æ®
   â†“ æ„å»ºæ–‡æœ¬åˆ—è¡¨

[æ­¥éª¤2] æ„å»ºTF-IDFè¯­æ–™åº“
   â†“ BuildDocumentLibrary(): é¢„å¤„ç†æ‰€æœ‰æ–‡æœ¬
   â†“ BuildIdfTable(): è®¡ç®—å…¨å±€IDFå€¼
   âœ“ å®Œæˆåˆå§‹åŒ–

[æ­¥éª¤3] ä¸ºæ¯ä¸ªæ–‡ä»¶è®¡ç®—TF-IDFå…³é”®è¯
   â†“ éå†æ¯ä¸ªæ–‡ä»¶çš„Prompt
   â†“ ProcessSingleRow(): è®¡ç®—è¯¥æ–‡ä»¶çš„TF-IDFåˆ†æ•°
   â†“ æå–Top 10å…³é”®è¯
   âœ“ ç”Ÿæˆç»“æœå­—å…¸

[æ­¥éª¤4] ç”ŸæˆExcelæŠ¥å‘Š
   â†“ GenerateExcelReportWithTfidf()
   â†“ æ·»åŠ TF-IDFç»“æœåˆ—
   â†“ åˆ›å»ºæ‘˜è¦é¡µ
   âœ“ ä¿å­˜åˆ°Tempæ–‡ä»¶å¤¹

[æ­¥éª¤5] è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Š
   â†“ ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç¨‹åºæ‰“å¼€Excel
   âœ“ å®Œæˆ
```

---

## ğŸ“Š è¾“å‡ºæ ¼å¼

### ExcelæŠ¥å‘Šç»“æ„

**ä¸»æ•°æ®è¡¨ï¼ˆTF-IDFåˆ†ææŠ¥å‘Šï¼‰ï¼š**
```
åˆ—å·  | åˆ—å                      | æ•°æ®æ¥æº         | ç¤ºä¾‹å€¼
------|--------------------------|------------------|------------------
1     | æ–‡ä»¶å                    | FileScanner      | image_001.png
2     | æ–‡ä»¶ç»å¯¹è·¯å¾„              | FilePath         | C:\...\image.png
3     | æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹è·¯å¾„        | Path.GetDirectory| C:\...\
4     | æ ¼å¼                      | Path.Extension   | PNG
5     | åˆ›å»ºæ—¶é—´                  | File.GetCreate   | 2024-01-15 10:30
6     | Prompt                    | MetadataExtract  | beautiful girl...
7     | NegativePrompt            | MetadataExtract  | ugly, distorted...
8     | Model                     | MetadataExtract  | stable-diffusion
9     | ModelHash                 | MetadataExtract  | abc123def456
10    | Seed                      | MetadataExtract  | 12345
11    | Sampler                   | MetadataExtract  | euler_ancestral
12    | å…¶ä»–ä¿¡æ¯                  | MetadataExtract  | Steps: 25
13    | å®Œæ•´ä¿¡æ¯                  | MetadataExtract  | Steps: 25, CFG: 8
14    | æå–æ–¹æ³•                  | MetadataExtract  | EXIF
15    | **TF-IDFå…³é”®è¯(Top10)** â­ | **TfidfProcessor** | **beautiful(0.82)\|girl(0.76)\|...**
```

**æ‘˜è¦é¡µï¼ˆSummaryï¼‰ï¼š**
```
æ‰«ææ–‡ä»¶å¤¹:          C:\stable-diffusion-webui\outputs\txt2img-images
æ‰«ææ—¶é—´:            2024-01-15 15:30:45
æ–‡ä»¶æ€»æ•°:            145,045
åŒ…å«Promptçš„æ–‡ä»¶:    140,235
æ ¼å¼ç»Ÿè®¡:
  PNG: 52,341
  JPG: 87,894
  WebP: 5,000
```

---

## ğŸ”¬ ç®—æ³•è¯¦è§£

### TF-IDFè®¡ç®—å…¬å¼

```
TF (è¯é¢‘) = è¯åœ¨æ–‡æ¡£ä¸­å‡ºç°æ¬¡æ•° / æ–‡æ¡£æ€»è¯æ•°
            ç¤ºä¾‹ï¼šword "beautiful" å‡ºç°2æ¬¡ï¼Œæ€»è¯æ•°200
            â†’ TF = 2 / 200 = 0.01

IDF (é€†æ–‡æ¡£é¢‘ç‡) = log(æ€»æ–‡æ¡£æ•° / åŒ…å«è¯¥è¯çš„æ–‡æ¡£æ•°)
                   ç¤ºä¾‹ï¼šæ€»æ–‡æ¡£æ•°145045ï¼Œ"beautiful"å‡ºç°åœ¨5000ä¸ª
                   â†’ IDF = log(145045 / 5000) = 3.47

TF-IDF = TF Ã— IDF
         = 0.01 Ã— 3.47 = 0.0347
```

### å…³é”®è¯æå–åŸç†

```
æ¯ä¸ªè¯çš„é‡è¦æ€§ = TF-IDFåˆ†æ•°

é«˜TF-IDFåˆ†æ•° = è¯¥è¯é¢‘ç¹ä¸”å…·æœ‰åŒºåˆ†åº¦
ç¤ºä¾‹ï¼š
- "beautiful" åœ¨å¾ˆå¤šæ–‡ä»¶ä¸­éƒ½å‡ºç° â†’ IDFä½ â†’ TF-IDFä½
- "masterpiece" åªåœ¨å°‘æ•°æ–‡ä»¶ä¸­å‡ºç° â†’ IDFé«˜ â†’ TF-IDFé«˜

â†’ æå–Top 10é«˜åˆ†è¯è¯­ä½œä¸ºå…³é”®è¯
```

---

## ğŸ’¾ æ•°æ®ç»“æ„

### æ ¸å¿ƒç±»ï¼ˆTfidfProcessorServiceï¼‰

```csharp
public class Document
{
    public int DocId { get; set; }           // æ–‡æ¡£ID
    public string[] Words { get; set; }      // åˆ†è¯åçš„è¯æ•°ç»„
    public Dictionary<string, int> WordCounts { get; set; }  // è¯é¢‘è¡¨
    public int TotalWords { get; set; }      // æ€»è¯æ•°
}

public class TfidfResult
{
    public int DocId { get; set; }
    public string ExcelString { get; set; }  // "word1(0.82)|word2(0.76)|..."
    public List<string> TopKeywords { get; set; }  // ["word1", "word2", ...]
}
```

### æˆå‘˜å˜é‡

```csharp
_documents          // List<Document> - æ–‡æ¡£åº“
_idfTable           // Dictionary<string, double> - IDFæŸ¥è¯¢è¡¨
_vocabularyDf       // Dictionary<string, int> - è¯æ±‡DFç»Ÿè®¡
_topN = 10          // æå–Top Nä¸ªå…³é”®è¯
```

---

## âš™ï¸ å¯é…ç½®å‚æ•°

### TfidfProcessorServiceé…ç½®

```csharp
// åˆå§‹åŒ–
var tfidfService = new TfidfProcessorService(topN: 10);

// å¯é€‰ä¼˜åŒ–ï¼ˆåœ¨BuildDocumentLibraryå‰è°ƒç”¨ï¼‰
tfidfService.SetOptimizations(
    enableStopWords: false,        // æ˜¯å¦è¿‡æ»¤åœç”¨è¯
    enableWordLength: false,       // æ˜¯å¦é™åˆ¶è¯é•¿
    enableStats: false             // æ˜¯å¦æ”¶é›†ç»Ÿè®¡ä¿¡æ¯
);

// è¿‡æ»¤ä½é¢‘è¯
tfidfService.FilterLowFrequencyWords(minDocFrequency: 2);
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å¤„ç†æ—¶é—´ï¼ˆ145,045 filesï¼‰

```
[æ­¥éª¤1] æ”¶é›†Prompt           : ~20ç§’ (å¹¶è¡Œ)
[æ­¥éª¤2] æ„å»ºè¯­æ–™åº“           : ~5ç§’
[æ­¥éª¤3] è®¡ç®—TF-IDFå…³é”®è¯     : ~25ç§’
[æ­¥éª¤4] ç”ŸæˆExcel            : ~3ç§’
[æ­¥éª¤5] æ‰“å¼€æŠ¥å‘Š             : <1ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è€—æ—¶                        : ~55ç§’
```

### å†…å­˜å ç”¨

```
æ–‡æœ¬æ”¶é›†:    ~300MB
æ–‡æ¡£åº“:      ~200MB
IDFè¡¨:       ~50MB
ç»“æœå­—å…¸:    ~100MB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:        ~650MB (å³°å€¼)
```

---

## ğŸ”„ ä¸åŠŸèƒ½3çš„åŒºåˆ«

| ç»´åº¦ | åŠŸèƒ½3ï¼ˆè‡ªå®šä¹‰æ ‡è®°ï¼‰ | åŠŸèƒ½4ï¼ˆTF-IDFï¼‰ |
|------|---------------------|-----------------|
| **å¤„ç†æ–¹å¼** | é€è¡Œæ‰«æï¼Œå…³é”®è¯æŸ¥æ‰¾ | ä¸¤éæ‰«æï¼Œå…¨å±€è®¡ç®— |
| **å…³é”®è¯æ¥æº** | é¢„å®šä¹‰åˆ—è¡¨ | è‡ªåŠ¨å‘ç° |
| **è¾“å‡ºå½¢å¼** | `girl\|red` | `beautiful(0.82)\|girl(0.76)` |
| **å¤„ç†æ—¶é—´** | ~5ç§’ | ~55ç§’ |
| **å†…å­˜å ç”¨** | ~100MB | ~650MB |
| **çµæ´»æ€§** | ä½ï¼ˆå›ºå®šå…³é”®è¯ï¼‰ | é«˜ï¼ˆæ™ºèƒ½æå–ï¼‰ |
| **å‡†ç¡®æ€§** | ä¸­ï¼ˆä¾èµ–å…³é”®è¯åº“ï¼‰ | é«˜ï¼ˆç®—æ³•é©±åŠ¨ï¼‰ |
| **æ–°è¯å‘ç°** | å¦ | æ˜¯ |
| **è¯çš„æ’åº** | æ—  | æœ‰ï¼ˆæŒ‰TF-IDFåˆ†æ•°ï¼‰ |

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### å‘½ä»¤è¡Œå¯åŠ¨

```bash
# å¿«é€Ÿå¯åŠ¨åŠŸèƒ½4
dotnet run -- --4

# è¾“å‡ºç¤ºä¾‹
[å¿«é€Ÿå¯åŠ¨] åŠŸèƒ½4ï¼šTF-IDFå…³é”®è¯æå–

å¼€å‘åŠŸèƒ½4ï¼š [å¼€å‘æ¨¡å¼-é«˜çº§åˆ†æ] TF-IDFåŒºåˆ†åº¦å…³é”®è¯æå–

ğŸ”„ åŠŸèƒ½4ï¼šTF-IDFåŒºåˆ†åº¦å…³é”®è¯æå–

æ‰«ææ–‡ä»¶å¤¹: C:\stable-diffusion-webui\outputs\txt2img-images

æ‰¾åˆ° 145,045 ä¸ªå›¾ç‰‡æ–‡ä»¶

[æ­¥éª¤1] æ”¶é›†Promptæ–‡æœ¬å¹¶åˆå§‹åŒ–TF-IDFå¤„ç†å™¨...
[æ­¥éª¤2] æ„å»ºTF-IDFè¯­æ–™åº“...
[æ­¥éª¤3] ä¸ºæ¯ä¸ªæ–‡ä»¶è®¡ç®—TF-IDFå…³é”®è¯...
[æ­¥éª¤4] ç”ŸæˆExcelæŠ¥å‘Š...
[æ­¥éª¤5] è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Š...

âœ“ æŠ¥å‘Šå·²ç”Ÿæˆ: C:\Users\...\Temp\metadata_scan_Mode4_TFIDF_2024-01-15_15-30-45.xlsx
âœ“ æŠ¥å‘Šå·²æ‰“å¼€

è€—æ—¶: 55.32 ç§’
```

### ç¯å¢ƒå˜é‡å¯åŠ¨

```bash
# åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­è®¾ç½®
set IMAGEINFO_DEV=scorer

# ç„¶åè¿è¡Œ
dotnet run
```

---

## ğŸ“ æ–‡ä»¶ä½ç½®

### å®ç°æ–‡ä»¶

```
src/ImageInfo/Services/
â”œâ”€â”€ DevelopmentModeService.cs      â† RunScanMode4() å…¥å£
â”œâ”€â”€ TfidfProcessorService.cs       â† æ ¸å¿ƒç®—æ³•å®ç°
â”œâ”€â”€ MetadataExtractors.cs          â† å…ƒæ•°æ®æå–
â””â”€â”€ FileScanner.cs                 â† æ–‡ä»¶æ‰«æ
```

### è¾“å‡ºæ–‡ä»¶

```
C:\Users\[User]\AppData\Local\Temp\
â”œâ”€â”€ metadata_scan_Mode4_TFIDF_2024-01-15_15-30-45.xlsx
â””â”€â”€ metadata_scan_Mode4_TFIDF_2024-01-15_16-00-00.xlsx
```

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°

- [x] TF-IDFç®—æ³•å®Œæ•´å®ç°
- [x] å…¨å±€è¯­æ–™åº“æ„å»º
- [x] å¹¶è¡Œæ–‡ä»¶æ‰«æ
- [x] Top 10å…³é”®è¯æ™ºèƒ½æå–
- [x] ExcelæŠ¥å‘Šç”Ÿæˆ
- [x] è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Š
- [x] è¿›åº¦æ˜¾ç¤º
- [x] é”™è¯¯å¤„ç†

### ğŸ”® å¯æ‰©å±•åŠŸèƒ½

- [ ] è‡ªå®šä¹‰TopNå‚æ•°ï¼ˆå½“å‰å›ºå®š10ï¼‰
- [ ] StopWordsè¿‡æ»¤é€‰é¡¹
- [ ] è¯é•¿é™åˆ¶
- [ ] æ€§èƒ½ç»Ÿè®¡
- [ ] å…³é”®è¯èšç±»åˆ†æ
- [ ] æ¨¡å‹é£æ ¼ç‰¹å¾æå–

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŠŸèƒ½éªŒè¯

```
1. âœ“ ç¼–è¯‘é€šè¿‡ï¼ˆdotnet buildï¼‰
2. âœ“ å¿«é€Ÿå¯åŠ¨æˆåŠŸï¼ˆdotnet run -- --4ï¼‰
3. âœ“ æ–‡ä»¶æ‰«ææ­£ç¡®ï¼ˆæ˜¾ç¤º145,045æ–‡ä»¶ï¼‰
4. âœ“ è¿›åº¦æ˜¾ç¤ºå‡†ç¡®
5. âœ“ ExcelæŠ¥å‘Šç”Ÿæˆ
6. âœ“ æŠ¥å‘Šèƒ½è‡ªåŠ¨æ‰“å¼€
7. âœ“ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```

### è¾“å‡ºè´¨é‡æ£€æŸ¥

```
1. æ¯è¡Œéƒ½æœ‰15åˆ—æ•°æ®
2. ç¬¬15åˆ—åŒ…å«TF-IDFç»“æœ
3. æ ¼å¼ï¼š"word(score)|word(score)|..."
4. åˆ†æ•°èŒƒå›´0-1ä¹‹é—´
5. æ‘˜è¦é¡µæ•°æ®ç»Ÿè®¡æ­£ç¡®
6. æ²¡æœ‰é”™è¯¯æç¤º
```

---

## ğŸ“ å­¦ä¹ èµ„æº

### TF-IDFç®—æ³•

- TF-IDFæ˜¯ä¿¡æ¯æ£€ç´¢å’Œæ–‡æœ¬åˆ†æçš„æ ‡å‡†ç®—æ³•
- å¸¸ç”¨äºæœç´¢å¼•æ“ã€æ¨èç³»ç»Ÿã€æ–‡æœ¬åˆ†ç±»
- æœ¬å®ç°æ˜¯ç®€åŒ–ç‰ˆæœ¬ï¼ˆæœªä½¿ç”¨ML.NETå¤æ‚æ¡†æ¶ï¼‰

### åº”ç”¨åœºæ™¯

- å‘ç°AIç”Ÿå›¾çš„å…³é”®ç‰¹å¾è¯æ±‡
- åˆ†æä¸åŒæ¨¡å‹çš„ç‰¹è‰²è¯æ±‡
- æå–Promptä¸­æœ€å…·åŒºåˆ†åº¦çš„è¯è¯­
- ä¼˜åŒ–å…³é”®è¯åº“

---

## ğŸ“ æ€»ç»“

**åŠŸèƒ½4** æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®åˆ†æå·¥å…·ï¼Œåˆ©ç”¨TF-IDFç®—æ³•è‡ªåŠ¨å‘ç°æ¯ä¸ªæ–‡ä»¶Promptä¸­æœ€æœ‰ä»£è¡¨æ€§çš„å…³é”®è¯ã€‚

ç›¸æ¯”åŠŸèƒ½3çš„ç®€å•å…³é”®è¯åŒ¹é…ï¼ŒåŠŸèƒ½4èƒ½å¤Ÿï¼š
- å‘ç°æ–°çš„ã€æœªé¢„å®šä¹‰çš„é«˜ä»·å€¼è¯æ±‡
- æä¾›è¯æ±‡çš„é‡è¦æ€§æ’åºï¼ˆTF-IDFåˆ†æ•°ï¼‰
- åŸºäºå…¨å±€è¯­æ–™åº“è¿›è¡Œè®¡ç®—ï¼Œç»“æœæ›´å®¢è§‚

ä¸¤ä¸ªåŠŸèƒ½äº’è¡¥ï¼Œå»ºè®®**ç»„åˆä½¿ç”¨**è·å¾—æœ€ä½³åˆ†ææ•ˆæœã€‚
