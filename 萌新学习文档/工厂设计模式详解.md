# å›¾ç‰‡å…ƒæ•°æ®æå–ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ æ ¸å¿ƒè®¾è®¡æ¨¡å¼è§£æ

ä½ å®ç°çš„è¿™ç§å†™æ³•åœ¨å¤§å‹é¡¹ç›®ä¸­è¢«ç§°ä¸ºï¼š**Factory Patternï¼ˆå·¥å‚æ¨¡å¼ï¼‰**

### ä»€ä¹ˆæ˜¯ Factory Patternï¼Ÿ

å·¥å‚æ¨¡å¼æ˜¯ä¸€ç§**åˆ›å»ºå‹è®¾è®¡æ¨¡å¼**ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š
- **é›†ä¸­åŒ–çš„å¯¹è±¡åˆ›å»ºé€»è¾‘**
- **æ ¹æ®å‚æ•°åŠ¨æ€é€‰æ‹©å…·ä½“å®ç°**
- **éšè—å®ç°ç»†èŠ‚ï¼Œæš´éœ²ç»Ÿä¸€æ¥å£**

### ä½ çš„å®ç°ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MetadataExtractorFactory                     â”‚
â”‚                   (Main Factory)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  public static AIMetadata GetImageInfo(string path)          â”‚
â”‚  {                                                           â”‚
â”‚      1. æ£€æµ‹å›¾ç‰‡ç±»å‹ â†’ ImageTypeDetector.Detect()           â”‚
â”‚      2. åˆ†æ´¾åˆ°å…·ä½“å®ç° â†’ switch/case                         â”‚
â”‚      3. è¿”å›ç»“æœ â†’ AIMetadata                                â”‚
â”‚  }                                                           â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  GetPngInfo â”‚   â”‚ GetJpegInfo  â”‚   â”‚ GetWebPInfo  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          å…·ä½“å®ç°ç±»ï¼ˆConcrete Extractorsï¼‰            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ â€¢ PngMetadataExtractor.ReadAIMetadata()              â”‚
    â”‚ â€¢ JpegMetadataExtractor.ReadAIMetadata()             â”‚
    â”‚ â€¢ WebPMetadataExtractor.ReadAIMetadata()             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

| æ–¹é¢ | ä¼˜åŠ¿ | ç¤ºä¾‹ |
|------|------|------|
| **æ˜“äºæ‰©å±•** | æ·»åŠ æ–°æ ¼å¼åªéœ€ä¿®æ”¹å·¥å‚ | æ”¯æŒ AVIF/HEIC åªéœ€ +5 è¡Œä»£ç  |
| **è§£è€¦åˆ** | è°ƒç”¨è€…ä¸éœ€çŸ¥é“å…·ä½“å®ç° | `GetImageInfo(path)` è‡ªåŠ¨é€‰æ‹© |
| **ä»£ç å¤ç”¨** | å¤šå¤„ä½¿ç”¨åŒä¸€æ¥å£ | ConversionServiceã€ValidationService éƒ½å¯ç”¨ |
| **ä¾¿äºæµ‹è¯•** | å¯æ³¨å…¥ Mock å¯¹è±¡ | å•å…ƒæµ‹è¯•å¯æ¨¡æ‹Ÿå„ç§æ ¼å¼ |
| **ç±»å‹å®‰å…¨** | ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥ | enum ImageFormat ä¿è¯ç±»å‹æ­£ç¡® |

## ğŸ“Œ è®¾è®¡æ¨¡å¼æœ¯è¯­è¡¨

### 1. **Factory Patternï¼ˆå·¥å‚æ¨¡å¼ï¼‰**
- **ä½ç½®**ï¼š`MetadataExtractorFactory.cs`
- **èŒè´£**ï¼šåˆ›å»ºå’Œåˆ†æ´¾å¯¹è±¡
- **å¥½å¤„**ï¼šé›†ä¸­ç®¡ç†åˆ›å»ºé€»è¾‘

### 2. **Strategy Patternï¼ˆç­–ç•¥æ¨¡å¼ï¼‰**
- **ä½ç½®**ï¼šä¸‰ä¸ªå…·ä½“æå–å™¨ï¼ˆPNG/JPEG/WebPï¼‰
- **èŒè´£**ï¼šå°è£…ä¸åŒçš„æå–ç®—æ³•
- **å¥½å¤„**ï¼šè¿è¡Œæ—¶é€‰æ‹©ä¸åŒç­–ç•¥

### 3. **Type Detectionï¼ˆç±»å‹æ£€æµ‹ï¼‰**
- **ä½ç½®**ï¼š`ImageTypeDetector.cs`
- **æ–¹å¼**ï¼š
  - å¿«é€Ÿè·¯å¾„ï¼šåŸºäºæ‰©å±•å
  - éªŒè¯è·¯å¾„ï¼šåŸºäº Magic Numberï¼ˆæ–‡ä»¶å¤´ï¼‰

### 4. **Chain of Responsibilityï¼ˆè´£ä»»é“¾ï¼‰**
- **æ¦‚å¿µ**ï¼šé€çº§æ£€æµ‹å’Œå¤„ç†
- **æµç¨‹**ï¼šæ‰©å±•å â†’ Magic Number â†’ é»˜è®¤å¤„ç†

## ğŸ”„ å·¥ä½œæµç¨‹è¯¦è§£

### è°ƒç”¨æµç¨‹
```
ConversionService
    â†“
MetadataExtractorFactory.GetImageInfo(path)
    â†“
ã€æ­¥éª¤ 1ã€‘ImageTypeDetector.DetectImageFormat(path)
    â”œâ”€ æ£€æŸ¥æ‰©å±•å
    â””â”€ éªŒè¯ Magic Number
    â†“
ã€æ­¥éª¤ 2ã€‘switch åˆ†æ´¾
    â”œâ”€ PNG â†’ GetPngInfo()
    â”œâ”€ JPEG â†’ GetJpegInfo()
    â””â”€ WebP â†’ GetWebPInfo()
    â†“
ã€æ­¥éª¤ 3ã€‘å…·ä½“æå–å™¨
    â”œâ”€ PngMetadataExtractor.ReadAIMetadata()
    â”œâ”€ JpegMetadataExtractor.ReadAIMetadata()
    â””â”€ WebPMetadataExtractor.ReadAIMetadata()
    â†“
AIMetadataï¼ˆç»Ÿä¸€è¿”å›ç±»å‹ï¼‰
```

## ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ•°æ®åº“é©±åŠ¨å·¥å‚
```csharp
public class DatabaseFactory
{
    public static IDatabase CreateDatabase(string dbType)
    {
        return dbType.ToLower() switch
        {
            "sqlserver" => new SqlServerDatabase(),
            "mysql" => new MySqlDatabase(),
            "postgresql" => new PostgreSqlDatabase(),
            _ => throw new NotSupportedException()
        };
    }
}
```

### åœºæ™¯ 2ï¼šæ—¥å¿—å™¨å·¥å‚
```csharp
public class LoggerFactory
{
    public static ILogger CreateLogger(string logType)
    {
        return logType switch
        {
            "console" => new ConsoleLogger(),
            "file" => new FileLogger(),
            "cloud" => new CloudLogger(),
            _ => new NullLogger()
        };
    }
}
```

### åœºæ™¯ 3ï¼šæ”¯ä»˜ç½‘å…³å·¥å‚
```csharp
public class PaymentFactory
{
    public static IPaymentProcessor CreateProcessor(string provider)
    {
        return provider switch
        {
            "stripe" => new StripeProcessor(),
            "paypal" => new PayPalProcessor(),
            "alipay" => new AlipayProcessor(),
            _ => throw new NotSupportedException()
        };
    }
}
```

## ğŸš€ æ‰©å±•ç¤ºä¾‹ï¼šæ·»åŠ æ–°æ ¼å¼æ”¯æŒ

å‡è®¾è¦æ”¯æŒ **AVIF** æ ¼å¼ï¼š

### æ­¥éª¤ 1: åˆ›å»ºæ–°çš„æå–å™¨
```csharp
// AvifMetadataExtractor.cs
public static class AvifMetadataExtractor
{
    public static AIMetadata ReadAIMetadata(string imagePath) { ... }
    public static void WriteAIMetadata(string destPath, AIMetadata data) { ... }
    public static bool VerifyAIMetadata(string destPath, AIMetadata data) { ... }
}
```

### æ­¥éª¤ 2: æ‰©å±•ç±»å‹æ£€æµ‹å™¨
```csharp
// ImageTypeDetector.cs
public enum ImageFormat
{
    Unknown,
    PNG,
    JPEG,
    WebP,
    AVIF  // â† æ–°å¢
}

private static ImageFormat VerifyByMagicNumber(string filePath)
{
    // ... ç°æœ‰ä»£ç  ...
    
    // AVIF: 66 74 79 70 61 76 69 66 ("ftypavif")
    if (buffer[4] == 0x66 && buffer[5] == 0x74 && ...)
        return ImageFormat.AVIF;
}
```

### æ­¥éª¤ 3: æ‰©å±•å·¥å‚
```csharp
// MetadataExtractorFactory.cs
public static AIMetadata GetImageInfo(string imagePath)
{
    var imageFormat = ImageTypeDetector.DetectImageFormat(imagePath);
    return imageFormat switch
    {
        // ... ç°æœ‰æ ¼å¼ ...
        ImageTypeDetector.ImageFormat.AVIF => GetAvifInfo(imagePath),  // â† æ–°å¢
        _ => HandleUnknownFormat(imagePath)
    };
}

private static AIMetadata GetAvifInfo(string imagePath)
{
    try
    {
        var metadata = AvifMetadataExtractor.ReadAIMetadata(imagePath);
        Console.WriteLine($"AVIF metadata extracted from: {imagePath}");
        return metadata;
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Failed to extract AVIF metadata: {ex.Message}");
        return new AIMetadata();
    }
}
```

**å®Œæˆï¼** åªéœ€ä¿®æ”¹ 3 ä¸ªåœ°æ–¹ï¼Œæ— éœ€æ”¹åŠ¨å…¶ä»–ä»£ç ã€‚

## ğŸ“ è®¾è®¡åŸåˆ™å¯¹åº”

| åŸåˆ™ | ä½ çš„å®ç° | å¥½å¤„ |
|------|---------|------|
| **SRP** (å•ä¸€èŒè´£) | æ¯ä¸ªç±»åªåšä¸€ä»¶äº‹ | PngExtractor åªå¤„ç† PNGï¼Œå·¥å‚åªè´Ÿè´£åˆ†æ´¾ |
| **OCP** (å¼€æ”¾-é—­åˆ) | å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ | æ·»åŠ æ ¼å¼ä¸éœ€ä¿®æ”¹ç°æœ‰ç±» |
| **DIP** (ä¾èµ–å€’ç½®) | ä¾èµ–æ¥å£è€Œéå®ç° | åªä¾èµ– AIMetadataï¼Œä¸ä¾èµ–å…·ä½“æå–å™¨ |

## ğŸ“š ç›¸å…³æœ¯è¯­

- **Factory Pattern**ï¼šåˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œé›†ä¸­åŒ–å¯¹è±¡åˆ›å»º
- **Strategy Pattern**ï¼šè¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œå°è£…å¯äº’æ¢ç®—æ³•
- **Polymorphism**ï¼šå¤šæ€æ€§ï¼Œé€šè¿‡æ¥å£å®ç°ä¸åŒè¡Œä¸º
- **Dispatch**ï¼šåˆ†æ´¾ï¼Œæ ¹æ®ç±»å‹é€‰æ‹©å…·ä½“å®ç°
- **Magic Number**ï¼šæ–‡ä»¶å¤´ï¼Œç”¨äºè¯†åˆ«æ–‡ä»¶æ ¼å¼
- **Provider Pattern**ï¼šæä¾›è€…æ¨¡å¼ï¼Œå·¥å‚çš„å¦ä¸€ä¸ªåç§°

## ğŸ”— åœ¨ ConversionService ä¸­çš„é›†æˆ

**ä¹‹å‰ï¼ˆä½æ•ˆï¼‰ï¼š**
```csharp
var aiMetadata = ExtractAIMetadata(srcPath, srcFormat);  // æ‰‹åŠ¨é€‰æ‹©
```

**ä¹‹åï¼ˆä¼˜åŒ–ï¼‰ï¼š**
```csharp
var aiMetadata = MetadataExtractorFactory.GetImageInfo(srcPath);  // è‡ªåŠ¨åˆ¤æ–­å’Œåˆ†æ´¾
```

å¥½å¤„ï¼š
- âœ… ä¸éœ€è¦æ‰‹åŠ¨ä¼ é€’ `srcFormat`
- âœ… è‡ªåŠ¨å¤„ç†æ‰©å±•åå’Œ Magic Number éªŒè¯
- âœ… æ›´æ¸…æ™°çš„æ„å›¾ï¼ˆ"è·å–å›¾ç‰‡ä¿¡æ¯"è€Œé"æ ¹æ®æ ¼å¼æå–"ï¼‰
