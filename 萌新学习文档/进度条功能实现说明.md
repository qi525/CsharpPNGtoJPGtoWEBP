# 进度条功能增强 - 实现说明

## 📋 概览

本次更新为 `ProgressBarManager` 添加了完整的进度条功能，支持以下新特性：

- ⏱️ **已运行时间** - HH:MM:SS 格式显示
- ⏳ **剩余时间估算** - 基于已处理文件平均速度计算
- 📈 **文件处理速度** - 每秒处理文件数量
- 📉 **数据处理速度** - 每秒处理的数据量（MB/秒）
- ✓✗ **成功/失败统计** - 实时显示处理结果
- 📊 **实时进度面板** - 美观的双面板布局显示

## ✅ 已实现功能

### 1. 新增的类成员

```csharp
private int _successCount;        // 成功处理的文件数
private int _failureCount;        // 处理失败的文件数
private long _totalProcessedBytes; // 总处理数据量（字节）
```

### 2. 增强的 UpdateProgress 方法

**原始签名：**
```csharp
public void UpdateProgress(string currentFile)
```

**新签名：**
```csharp
public void UpdateProgress(string currentFile, bool success = true, long fileSize = 0)
```

**功能增强：**
- 支持追踪成功/失败状态
- 累计处理数据大小
- 实时计算数据处理速度
- 显示成功/失败计数

**输出示例：**
```
进度: 025% (5/20) | ✓ 4 ✗ 1 | 耗时: 00:00:15 | 剩余: 00:00:45 | 速度: 0.33 文件/秒 (0.52 MB/秒)
```

### 3. 增强的 ShowSummary 方法

**新增字段：**
- 已运行时间（与总耗时相同）
- 平均文件处理速度
- 平均数据处理速度
- 总处理数据量

**输出示例（完整表格）：**
```
╔════════════════════════════════════════════════════════════════╗
║                    ✓ 处理完成                                  ║
╠════════════════════════════════════════════════════════════════╣
║ 项目           │ 值                                             ║
╠════════════════════════════════════════════════════════════════╣
║ 总文件数       │ 20                                             ║
║ 成功数         │ 18                                             ║
║ 失败数         │ 2                                              ║
║ 成功率         │ 90.0%                                          ║
║ 总耗时         │ 01:02:30                                       ║
║ 已运行时间     │ 01:02:30                                       ║
║ 平均文件速度   │ 0.32 文件/秒                                  ║
║ 平均数据速度   │ 0.48 MB/秒                                    ║
║ 总处理数据量   │ 30.45 MB                                      ║
╚════════════════════════════════════════════════════════════════╝
```

### 4. 新增的 ShowProgressPanel 方法

实时显示详细进度信息的双面板布局。

**方法签名：**
```csharp
public void ShowProgressPanel(string currentFile = "处理中...")
```

**输出示例：**
```
┌───────────────────────────────────────────────────────────────────┐
│ 进度                   │ 时间统计                                  │
├───────────────────────────────────────────────────────────────────┤
│                       │ 📊 processing_file.png                     │
│     025%              │                                             │
│     5/20              │ ⏱️  耗时: 00:00:15                         │
│     ✓4 ✗1             │ ⏳ 剩余: 00:00:45                         │
│                       │ 📈 速度: 0.33 文件/秒                    │
│                       │ 📉 数据: 0.52 MB/秒                      │
└───────────────────────────────────────────────────────────────────┘
```

### 5. 增强的 ShowSpectreProgressBar 方法

**原始实现：**
- 仅显示基础进度条

**新实现：**
- 支持多列显示（描述、进度条、百分比、剩余时间、加载动画）
- 可选的回调函数支持动态更新

**方法签名：**
```csharp
public void ShowSpectreProgressBar(Action<ProgressTask>? updateCallback = null)
```

### 6. 新增的工具方法

**CalculateFileProcessingSpeed()**
```csharp
// 计算文件处理速度（文件/秒）
private double CalculateFileProcessingSpeed()
{
    var elapsedSeconds = _totalStopwatch.Elapsed.TotalSeconds;
    if (elapsedSeconds == 0) return 0;
    return _processedFiles / elapsedSeconds;
}
```

**CalculateDataProcessingSpeed()**
```csharp
// 计算数据处理速度（MB/秒）
private double CalculateDataProcessingSpeed()
{
    var elapsedSeconds = _totalStopwatch.Elapsed.TotalSeconds;
    if (elapsedSeconds == 0 || _totalProcessedBytes == 0) return 0;
    return (_totalProcessedBytes / 1024.0 / 1024.0) / elapsedSeconds;
}
```

**FormatTime()**
```csharp
// 格式化时间为 HH:MM:SS
private static string FormatTime(TimeSpan time)
{
    return $"{time.Hours:D2}:{time.Minutes:D2}:{time.Seconds:D2}";
}
```

## 📝 使用示例

### 基础使用

```csharp
var progress = new ProgressBarManager(totalFiles);

foreach (var file in files)
{
    var fileInfo = new FileInfo(file);
    var success = ProcessFile(file);

    progress.UpdateProgress(
        currentFile: Path.GetFileName(file),
        success: success,
        fileSize: fileInfo.Length
    );
}

progress.ShowSummary(successCount, failureCount);
progress.Dispose();
```

### 显示实时面板

```csharp
// 每 5 个文件显示一次进度面板
if ((processedCount) % 5 == 0)
{
    progress.ShowProgressPanel(currentFileName);
}
```

## 🔧 技术细节

### 时间估算算法

```
已处理文件数：n
总文件数：N
已耗费时间：T

平均处理时间 = T / n
剩余文件数 = N - n
剩余时间估算 = (T / n) * (N - n)
```

### 速度计算

**文件处理速度：**
```
速度(文件/秒) = 已处理文件数 / 已耗费时间(秒)
```

**数据处理速度：**
```
速度(MB/秒) = 总处理字节数 / 1024 / 1024 / 已耗费时间(秒)
```

## 📊 性能考虑

- **内存占用**：仅存储四个额外的 long/int 变量，内存占用极小
- **计算开销**：所有速度计算都是 O(1) 的简单算术运算
- **显示更新**：建议间隔至少 500ms，避免频繁更新导致输出过多

## 🎯 使用场景

### 1. 批量文件处理
```csharp
// 适用于大量文件的转换/处理任务
var progress = new ProgressBarManager(imageCount);
for each file:
    progress.UpdateProgress(file, success, fileSize);
    if processedCount % 10 == 0:
        progress.ShowProgressPanel(file);
progress.ShowSummary(success, failure);
```

### 2. 实时监控长时间任务
```csharp
// 显示实时的时间和速度信息
progress.ShowProgressPanel(currentFile); // 定期调用
```

### 3. 最终报告生成
```csharp
// 任务完成后生成详细汇总
progress.ShowSummary(successCount, failureCount);
```

## 📚 文档

已创建 `进度条功能使用指南.md`，包含详细的：
- 功能概述
- 完整使用示例
- 输出样式示例
- 配置方法
- 故障排除

## 🔍 测试

已创建 `ProgressBarDemo.cs` 演示程序，包括：
1. **Demo_BasicProgress** - 基础进度更新演示
2. **Demo_FileDetails** - 文件详情显示演示
3. **Demo_ProgressPanel** - 进度面板演示
4. **Demo_Complete** - 完整流程演示

运行方式：
```bash
cd src/ImageInfo
dotnet run --project ImageInfo.csproj -- --demo
```

## 📋 更新日志

- **2025-11-16**：
  - ✅ 添加已运行时间显示（HH:MM:SS）
  - ✅ 实现剩余时间估算
  - ✅ 添加文件处理速度计算
  - ✅ 添加数据处理速度计算（MB/秒）
  - ✅ 实现成功/失败统计
  - ✅ 创建实时进度面板
  - ✅ 增强 ShowSummary 显示内容
  - ✅ 创建使用指南文档

## 🎓 架构说明

### 类结构图

```
ProgressBarManager
├── 时间追踪
│   ├── _totalStopwatch    // 总耗时
│   └── _itemStopwatch     // 单个文件耗时
├── 计数统计
│   ├── _totalFiles        // 总文件数
│   ├── _processedFiles    // 已处理文件数
│   ├── _successCount      // 成功数
│   └── _failureCount      // 失败数
├── 数据统计
│   └── _totalProcessedBytes // 总处理数据量
└── 公共方法
    ├── UpdateProgress()       // 更新进度
    ├── ShowSummary()          // 显示汇总
    ├── ShowProgressPanel()    // 显示面板
    ├── ShowFileDetails()      // 显示文件详情
    └── ShowSpectreProgressBar() // 显示进度条
```

## 🚀 建议的下一步优化

1. **并发支持** - 添加线程安全的进度更新
2. **日志集成** - 将进度信息写入日志文件
3. **配置选项** - 支持自定义显示格式
4. **进度保存** - 支持中断恢复
5. **性能监控** - 实时内存/CPU 使用统计

---

**实现日期**：2025-11-16  
**版本**：1.0  
**状态**：✅ 完成并通过编译测试
