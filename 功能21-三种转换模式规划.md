# åŠŸèƒ½21ï¼šä¸‰ç§è½¬æ¢æ¨¡å¼åŒæ—¶è¿è¡Œ - è¯¦ç»†è§„åˆ’ã€æ–‡ä»¶è½¬æ¢æ¨¡å¼ã€‘

## âš ï¸ åŠŸèƒ½è¯´æ˜
**æœ¬åŠŸèƒ½ä¸ºæ–‡ä»¶è½¬æ¢æ“ä½œ**ï¼Œæ¶‰åŠå›¾ç‰‡æ ¼å¼è½¬æ¢ï¼ˆPNGâ†’JPGã€PNGâ†’WEBPã€JPGâ†’WEBPï¼‰ï¼Œä¼šäº§ç”Ÿæ–°çš„è½¬æ¢åæ–‡ä»¶ã€‚ä½¿ç”¨å‰åŠ¡å¿…å¤‡ä»½åŸå§‹æ–‡ä»¶ã€‚

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰
åŒæ—¶è¿è¡Œä¸‰ç§å›¾ç‰‡æ ¼å¼è½¬æ¢æ¨¡å¼ï¼Œè‡ªåŠ¨è¿›è¡Œ PNGâ†’JPGã€PNGâ†’WEBPã€JPGâ†’WEBP çš„è½¬æ¢ï¼Œå¹¶ä¸ºæ¯ç§è½¬æ¢æ¨¡å¼è‡ªåŠ¨ç”Ÿæˆè½¬æ¢æŠ¥å‘Šã€‚

### 1.2 å·¥ä½œæµç¨‹
```
è¾“å…¥æ–‡ä»¶å¤¹
  â†“
[æ¨¡å¼1] PNG â†’ JPG è½¬æ¢
  â”œâ”€ è¾“å‡ºæ–‡ä»¶ï¼šfolder/convert_png2jpg/*.jpg
  â””â”€ æŠ¥å‘Šï¼šconvert_png2jpg_report.xlsx
  â†“
[æ¨¡å¼2] PNG â†’ WEBP è½¬æ¢
  â”œâ”€ è¾“å‡ºæ–‡ä»¶ï¼šfolder/convert_png2webp/*.webp
  â””â”€ æŠ¥å‘Šï¼šconvert_png2webp_report.xlsx
  â†“
[æ¨¡å¼3] JPG â†’ WEBP è½¬æ¢
  â”œâ”€ è¾“å‡ºæ–‡ä»¶ï¼šfolder/convert_jpg2webp/*.webp
  â””â”€ æŠ¥å‘Šï¼šconvert_jpg2webp_report.xlsx
  â†“
[å®Œæˆ] è‡ªåŠ¨æ‰“å¼€ä¸‰ä»½è½¬æ¢æŠ¥å‘Š
```

### 1.3 è¾“å…¥è¾“å‡º
**è¾“å…¥ï¼š** æºå›¾ç‰‡æ–‡ä»¶ï¼ˆPNGã€JPGæ ¼å¼ï¼‰
**è¾“å‡ºï¼š** 
- è½¬æ¢åçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæ–°å»ºç›®å½•å­˜æ”¾ï¼‰
- è½¬æ¢æŠ¥å‘ŠExcelæ–‡ä»¶ï¼ˆåŒ…å«è½¬æ¢è¯¦æƒ…ã€é”™è¯¯æ—¥å¿—ï¼‰
- ä¸ä¿®æ”¹æºæ–‡ä»¶ï¼Œå®‰å…¨å¯é€†

---

## 2. æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 2.1 å›¾ç‰‡è½¬æ¢åº“é€‰æ‹©

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **ImageMagick** | åŠŸèƒ½å®Œæ•´ï¼Œæ€§èƒ½å¥½ | éœ€è¦å¤–éƒ¨ä¾èµ– | â­â­â­â­â­ |
| SkiaSharp | è·¨å¹³å°ï¼Œé«˜æ•ˆ | éœ€å­¦ä¹ API | â­â­â­â­ |
| System.Drawing | BCLå†…ç½® | ä»…Windowsï¼ŒåŠŸèƒ½æœ‰é™ | â­â­â­ |
| Magick.NET | ImageMagickçš„C#åŒ…è£… | ä¾èµ–é¡¹è¾ƒå¤š | â­â­â­ |

**æœ€ç»ˆé€‰æ‹©ï¼š** ImageMagickï¼ˆå·²åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ï¼‰

### 2.2 è½¬æ¢å‚æ•°é…ç½®

```csharp
public class ConversionConfig
{
    // JPG è½¬æ¢å‚æ•°
    public int JpgQuality { get; set; } = 85;           // è´¨é‡ [1-100]
    
    // WEBP è½¬æ¢å‚æ•°
    public int WebpQuality { get; set; } = 80;          // è´¨é‡ [1-100]
    
    // é€šç”¨å‚æ•°
    public bool PreserveMetadata { get; set; } = true;  // ä¿ç•™å…ƒæ•°æ®
    public int MaxThreads { get; set; } = 8;            // å¹¶è¡Œçº¿ç¨‹æ•°
    public int TimeoutMs { get; set; } = 30000;         // å•æ–‡ä»¶è¶…æ—¶
    
    // è¾“å‡ºé…ç½®
    public bool CreateSubfolders { get; set; } = true;  // æŒ‰æºç›®å½•ç»“æ„åˆ›å»º
    public bool OverwriteExisting { get; set; } = false; // ä¸è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶
}
```

### 2.3 æ€§èƒ½é¢„æœŸ

```
å•æ–‡ä»¶è½¬æ¢ï¼š100-500msï¼ˆä¾èµ–æ–‡ä»¶å¤§å°ï¼‰
å…¨é‡æ•°æ®ï¼ˆ133,509æ–‡ä»¶ï¼‰ï¼š
  - PNGâ†’JPGï¼š~2-3 å°æ—¶
  - PNGâ†’WEBPï¼š~2-3 å°æ—¶
  - JPGâ†’WEBPï¼š~1-2 å°æ—¶
ç£ç›˜å ç”¨ï¼šå–å†³äºè½¬æ¢è´¨é‡å’Œç›®æ ‡æ ¼å¼
å†…å­˜å ç”¨ï¼š< 500MBï¼ˆå•æ–‡ä»¶å¤„ç†ï¼‰
```

---

## 3. å®ç°æµç¨‹è¯¦ç»†è®¾è®¡

### 3.1 å‰ç½®æ­¥éª¤ï¼šåˆå§‹åŒ–å’ŒéªŒè¯

#### ç¬¬ä¸€æ­¥ï¼šæ£€æµ‹æºæ–‡ä»¶ (ScanSourceFiles)

**è¾“å…¥ï¼š** `string sourceFolder`

**è¿‡ç¨‹ï¼š**
```
æ‰«ææºæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰PNGå’ŒJPGæ–‡ä»¶
  â†“
ç»Ÿè®¡æ–‡ä»¶æ•°é‡å’Œå¤§å°
  â†“
éªŒè¯ç£ç›˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
  â†“
è¿”å›æ–‡ä»¶åˆ—è¡¨å’Œé¢„è®¡æ—¶é—´
```

**æ•°æ®ç»“æ„ï¼š**
```csharp
public class ConversionTask
{
    public string SourcePath { get; set; }
    public string SourceFormat { get; set; }     // "PNG" æˆ– "JPG"
    public string TargetFormat { get; set; }     // "JPG" æˆ– "WEBP"
    public long FileSizeBytes { get; set; }
    public ConversionStatus Status { get; set; } = ConversionStatus.Pending;
    public string? ErrorMessage { get; set; }
    public long OutputSizeBytes { get; set; }
    public int ExecutionTimeMs { get; set; }
}

public enum ConversionStatus
{
    Pending,      // å¾…å¤„ç†
    Processing,   // å¤„ç†ä¸­
    Success,      // æˆåŠŸ
    Failed,       // å¤±è´¥
    Skipped       // è·³è¿‡ï¼ˆå·²å­˜åœ¨æˆ–å…¶ä»–åŸå› ï¼‰
}
```

**å¤æ‚åº¦ï¼š** O(N)ï¼ŒN = æ–‡ä»¶æ€»æ•°

---

#### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè¾“å‡ºç›®å½• (PrepareOutputDirectories)

**è¾“å…¥ï¼š** `string sourceFolder`

**è¿‡ç¨‹ï¼š**
```
åˆ›å»ºä¸‰ä¸ªè¾“å‡ºç›®å½•ï¼š
  â”œâ”€ convert_png2jpg/
  â”œâ”€ convert_png2webp/
  â””â”€ convert_jpg2webp/
  â†“
éªŒè¯ç›®å½•åˆ›å»ºæˆåŠŸ
  â†“
æ£€æŸ¥ç£ç›˜å†™å…¥æƒé™
```

**å¤æ‚åº¦ï¼š** O(1)ï¼ˆå›ºå®š3ä¸ªç›®å½•ï¼‰

---

### 3.2 æ ¸å¿ƒæ­¥éª¤ï¼šä¸‰ç§è½¬æ¢æ¨¡å¼

#### ç¬¬ä¸‰æ­¥ï¼šPNGâ†’JPG è½¬æ¢ (ConvertPngToJpg)

**è¾“å…¥ï¼š** `List<ConversionTask> pngFiles, ConversionConfig config`

**è¿‡ç¨‹ï¼š**
```
ä½¿ç”¨ Parallel.ForEach å¹¶è¡Œå¤„ç†æ¯ä¸ªPNGæ–‡ä»¶
  â†“
[1] åŠ è½½PNGå›¾ç‰‡
  â†“
[2] é…ç½®JPGè´¨é‡å‚æ•°
  â†“
[3] æ‰§è¡Œè½¬æ¢
  â†“
[4] ä¿å­˜åˆ°è¾“å‡ºç›®å½•
  â†“
[5] è®°å½•è½¬æ¢ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥/è·³è¿‡ï¼‰
  â†“
æŠ¥å‘Šè¿›åº¦å’Œé”™è¯¯ç»Ÿè®¡
```

**ä¼ªä»£ç ï¼š**
```csharp
public static void ConvertPngToJpg(
    List<ConversionTask> tasks,
    ConversionConfig config,
    IProgress<ConversionProgress> progress = null)
{
    var outputDir = Path.Combine(config.OutputFolder, "convert_png2jpg");
    Directory.CreateDirectory(outputDir);
    
    int processed = 0;
    int succeeded = 0;
    int failed = 0;
    
    Parallel.ForEach(tasks, new ParallelOptions 
    { 
        MaxDegreeOfParallelism = config.MaxThreads 
    }, (task, state) =>
    {
        var sw = Stopwatch.StartNew();
        try
        {
            using(var image = new MagickImage(task.SourcePath))
            {
                image.Format = MagickFormat.Jpg;
                image.Quality = config.JpgQuality;
                
                var outputPath = Path.Combine(
                    outputDir,
                    Path.GetFileNameWithoutExtension(task.SourcePath) + ".jpg");
                
                image.Write(outputPath);
                
                task.Status = ConversionStatus.Success;
                task.OutputSizeBytes = new FileInfo(outputPath).Length;
                succeeded++;
            }
        }
        catch(Exception ex)
        {
            task.Status = ConversionStatus.Failed;
            task.ErrorMessage = ex.Message;
            failed++;
        }
        finally
        {
            sw.Stop();
            task.ExecutionTimeMs = (int)sw.ElapsedMilliseconds;
            processed++;
            
            progress?.Report(new ConversionProgress 
            { 
                ProcessedCount = processed,
                SuccessCount = succeeded,
                FailureCount = failed
            });
        }
    });
}
```

**å¤æ‚åº¦ï¼š**
- æ—¶é—´ï¼šO(Nâ‚ / P)ï¼ŒNâ‚ = PNGæ–‡ä»¶æ•°
- é¢„æœŸè€—æ—¶ï¼š2-3 å°æ—¶ï¼ˆå…¨é‡ï¼‰

---

#### ç¬¬å››æ­¥ï¼šPNGâ†’WEBP è½¬æ¢ (ConvertPngToWebp)

**è¾“å…¥ï¼š** `List<ConversionTask> pngFiles, ConversionConfig config`

**è¿‡ç¨‹ï¼š** åŒä¸Šï¼Œç›®æ ‡æ ¼å¼ä¸ºWEBP

**å¤æ‚åº¦ï¼š** O(Nâ‚ / P)ï¼ŒNâ‚ = PNGæ–‡ä»¶æ•°

---

#### ç¬¬äº”æ­¥ï¼šJPGâ†’WEBP è½¬æ¢ (ConvertJpgToWebp)

**è¾“å…¥ï¼š** `List<ConversionTask> jpgFiles, ConversionConfig config`

**è¿‡ç¨‹ï¼š** åŒä¸Šï¼Œæºæ ¼å¼ä¸ºJPGï¼Œç›®æ ‡æ ¼å¼ä¸ºWEBP

**å¤æ‚åº¦ï¼š** O(Nâ‚‚ / P)ï¼ŒNâ‚‚ = JPGæ–‡ä»¶æ•°

---

### 3.3 åç½®æ­¥éª¤ï¼šæŠ¥å‘Šå’Œå®Œæˆ

#### ç¬¬å…­æ­¥ï¼šç”Ÿæˆè½¬æ¢æŠ¥å‘Š (GenerateConversionReports)

**è¾“å…¥ï¼š** `List<ConversionTask> allTasks, string outputFolder`

**è¿‡ç¨‹ï¼š**
```
ä¸ºä¸‰ç§è½¬æ¢åˆ†åˆ«ç”ŸæˆExcelæŠ¥å‘Šï¼š
  â†“
[æŠ¥å‘Šå†…å®¹]
  - æ–‡ä»¶å
  - æºè·¯å¾„
  - è¾“å‡ºè·¯å¾„
  - æºæ–‡ä»¶å¤§å°
  - è½¬æ¢åå¤§å°
  - è½¬æ¢æ—¶é—´
  - è½¬æ¢çŠ¶æ€
  - é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰
  â†“
[ç»Ÿè®¡æ‘˜è¦]
  - æ€»æ–‡ä»¶æ•°
  - æˆåŠŸæ•°
  - å¤±è´¥æ•°
  - è·³è¿‡æ•°
  - æ€»è€—æ—¶
  - å¹³å‡è½¬æ¢æ—¶é—´
```

**å¤æ‚åº¦ï¼š** O(N)ï¼ŒN = ä»»åŠ¡æ€»æ•°

---

#### ç¬¬ä¸ƒæ­¥ï¼šè‡ªåŠ¨æ‰“å¼€æŠ¥å‘Š (OpenReportsAutomatically)

**è¿‡ç¨‹ï¼š**
```
ç”ŸæˆæŠ¥å‘Šåï¼Œè‡ªåŠ¨æ‰“å¼€ä¸‰ä»½Excelæ–‡ä»¶
  â†“
ä½¿ç”¨ System.Diagnostics.Process.Start()
  â†“
ç”¨ç³»ç»Ÿé»˜è®¤åº”ç”¨æ‰“å¼€
```

**å¤æ‚åº¦ï¼š** O(1)ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

---

## 4. é›†æˆç‚¹è®¾è®¡

### 4.1 æ–°å¢å…¥å£æ–¹æ³•ï¼šRunFullConversionMode

**ä¿®æ”¹ä½ç½®ï¼š** `DevelopmentModeService.cs`

```csharp
public static void RunFullConversionMode(string folder)
{
    Console.WriteLine("ğŸ”„ åŠŸèƒ½21ï¼šä¸‰ç§è½¬æ¢æ¨¡å¼åŒæ—¶è¿è¡Œ");
    Console.WriteLine("âš ï¸  æœ¬åŠŸèƒ½ä¼šç”Ÿæˆæ–°æ–‡ä»¶ï¼Œè¯·ç¡®ä¿å·²å¤‡ä»½åŸå§‹æ•°æ®\n");
    
    var config = new ConversionConfig 
    { 
        OutputFolder = folder,
        JpgQuality = 85,
        WebpQuality = 80
    };
    
    var stopwatch = Stopwatch.StartNew();
    
    // ç¬¬1-2æ­¥ï¼šæ‰«æå’Œåˆå§‹åŒ–
    var pngFiles = ScanSourceFiles(folder, "*.png");
    var jpgFiles = ScanSourceFiles(folder, "*.jpg");
    PrepareOutputDirectories(folder);
    
    Console.WriteLine($"ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ï¼šPNG {pngFiles.Count} ä¸ªï¼ŒJPG {jpgFiles.Count} ä¸ª\n");
    
    // ç¬¬3-5æ­¥ï¼šä¸‰ç§è½¬æ¢å¹¶è¡Œè¿è¡Œ
    Task.WaitAll(
        Task.Run(() => ConvertPngToJpg(pngFiles, config)),
        Task.Run(() => ConvertPngToWebp(pngFiles, config)),
        Task.Run(() => ConvertJpgToWebp(jpgFiles, config))
    );
    
    // ç¬¬6-7æ­¥ï¼šç”ŸæˆæŠ¥å‘Šå¹¶æ‰“å¼€
    GenerateConversionReports(pngFiles, folder);
    GenerateConversionReports(jpgFiles, folder);
    OpenReportsAutomatically(folder);
    
    stopwatch.Stop();
    Console.WriteLine($"âœ… åŠŸèƒ½21å®Œæˆï¼Œæ€»è€—æ—¶: {stopwatch.Elapsed.TotalHours:F1} å°æ—¶");
}
```

---

## 5. æ–°å¢æ–‡ä»¶æ¸…å•

### 5.1 AdvancedBatchConverter.cs

**ä½ç½®ï¼š** `src/ImageInfo/Services/AdvancedBatchConverter.cs`

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```csharp
public static class AdvancedBatchConverter
{
    // ===== å…¬å¼€æ–¹æ³• =====
    public static void ConvertPngToJpg(
        List<ConversionTask> tasks,
        ConversionConfig config,
        IProgress<ConversionProgress> progress = null);
    
    public static void ConvertPngToWebp(
        List<ConversionTask> tasks,
        ConversionConfig config,
        IProgress<ConversionProgress> progress = null);
    
    public static void ConvertJpgToWebp(
        List<ConversionTask> tasks,
        ConversionConfig config,
        IProgress<ConversionProgress> progress = null);
    
    // ===== ç§æœ‰æ–¹æ³• =====
    private static void ConvertImage(
        ConversionTask task,
        MagickFormat targetFormat,
        ConversionConfig config);
    
    private static void GenerateConversionReport(
        List<ConversionTask> tasks,
        string mode);
    
    private static void OpenReportInExcel(string reportPath);
}
```

**ä»£ç è¡Œæ•°ä¼°è®¡ï¼š** 400-500è¡Œ

---

## 6. æµ‹è¯•è®¡åˆ’

### 6.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶ï¼š** `tests/ImageInfo.Tests/AdvancedBatchConverterTests.cs`

```csharp
public class AdvancedBatchConverterTests
{
    // [1] æµ‹è¯•PNGâ†’JPGè½¬æ¢
    [Fact]
    public void ConvertPngToJpg_ValidPngFile_Success()
    {
        // Arrange
        var testFile = CreateTestPngFile();
        var tasks = new List<ConversionTask> 
        { 
            new() { SourcePath = testFile, SourceFormat = "PNG" } 
        };
        var config = new ConversionConfig { JpgQuality = 85 };
        
        // Act
        AdvancedBatchConverter.ConvertPngToJpg(tasks, config);
        
        // Assert
        Assert.Equal(ConversionStatus.Success, tasks[0].Status);
        Assert.True(File.Exists(Path.ChangeExtension(testFile, ".jpg")));
    }
    
    // [2] æµ‹è¯•è½¬æ¢æŠ¥å‘Šç”Ÿæˆ
    [Fact]
    public void GenerateReport_ValidTasks_ReportCreated()
    {
        var tasks = GenerateTestTasks(100);
        
        var reportPath = AdvancedBatchConverter.GenerateConversionReport(tasks, "png2jpg");
        
        Assert.True(File.Exists(reportPath));
    }
    
    // [3] æµ‹è¯•å¹¶å‘è½¬æ¢
    [Fact]
    public void ConvertBatch_ParallelConversion_AllCompleted()
    {
        var tasks = GenerateTestTasks(1000);
        var config = new ConversionConfig { MaxThreads = 8 };
        
        AdvancedBatchConverter.ConvertPngToJpg(tasks, config);
        
        Assert.All(tasks, t => Assert.NotEqual(ConversionStatus.Pending, t.Status));
    }
}
```

**æµ‹è¯•ç”¨ä¾‹æ•°ï¼š** 10+ä¸ª

---

## 7. æµç¨‹æ€»ç»“

### 7.1 å®ç°æ­¥éª¤æ¸…å•

| åºå· | æ­¥éª¤ | å‡½æ•°æ•° | å¤æ‚åº¦ | é¢„æœŸè€—æ—¶ |
|-----|------|--------|--------|---------|
| 1 | æ‰«ææºæ–‡ä»¶ | 1 | O(N) | < 1ç§’ |
| 2 | åˆ›å»ºè¾“å‡ºç›®å½• | 1 | O(1) | < 1ç§’ |
| 3 | PNGâ†’JPGè½¬æ¢ | 1 | O(Nâ‚/P) | 2-3å°æ—¶ |
| 4 | PNGâ†’WEBPè½¬æ¢ | 1 | O(Nâ‚/P) | 2-3å°æ—¶ |
| 5 | JPGâ†’WEBPè½¬æ¢ | 1 | O(Nâ‚‚/P) | 1-2å°æ—¶ |
| 6 | ç”ŸæˆæŠ¥å‘Š | 1 | O(N) | < 1åˆ†é’Ÿ |
| 7 | æ‰“å¼€æŠ¥å‘Š | 1 | O(1) | < 1ç§’ |

**æ€»æ­¥éª¤æ•°ï¼š** 7æ­¥
**æ€»å‡½æ•°æ•°ï¼š** 3ä¸ªå…¬å¼€ + 3ä¸ªç§æœ‰ = 6ä¸ª
**é¢„æœŸå…¨é‡è€—æ—¶ï¼š** 5-8å°æ—¶ï¼ˆå¹¶è¡Œï¼‰

---

## 8. éªŒæ”¶æ ‡å‡†

- âœ… ä¸‰ç§è½¬æ¢æ¨¡å¼æ­£å¸¸è¿è¡Œ
- âœ… è½¬æ¢æˆåŠŸç‡ â‰¥ 99%
- âœ… è½¬æ¢æŠ¥å‘Šç”Ÿæˆæ­£ç¡®
- âœ… è‡ªåŠ¨æ‰“å¼€æŠ¥å‘ŠåŠŸèƒ½æ­£å¸¸
- âœ… æ— æºæ–‡ä»¶ä¿®æ”¹
- âœ… ç£ç›˜ç©ºé—´æ ¡éªŒæ­£å¸¸
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ”¯æŒä¸­æ–­å’Œç»­ä¼ 
