# 功能5 使用示例和测试说明

## 📋 功能概览

功能5是一个**个性化推荐评分系统**，包含两个评分维度：

1. **文件夹默认匹配分** (难度0) - 基于RATING_MAP关键词快速匹配
2. **个性化推荐预估评分** (难度3) - 基于机器学习(TF-IDF + Ridge回归)预测用户偏好

---

## 🚀 启动方式

### 方式1：命令行快速启动（推荐）

```powershell
cd c:\个人数据\C#Code\imageInfo
dotnet run -- --5
```

### 方式2：交互式启动

```powershell
cd c:\个人数据\C#Code\imageInfo
dotnet run
# 程序提示时输入: 5
```

### 方式3：Release版本（更快）

```powershell
cd c:\个人数据\C#Code\imageInfo
dotnet run -c Release -- --5
```

---

## 📝 输入数据要求

### Excel文件结构

功能5需要读取功能4的输出Excel文件，必须包含：

| 列序号 | 列名 | 说明 | 例值 |
|-------|------|------|-----|
| 1 (A列) | 任意 (路径信息) | 文件完整路径 | `C:\精选\girl.jpg` |
| ... | ... | 中间列可以是任何数据 | ... |
| 12 (L列) | 任意 (核心词汇) | TF-IDF提取的关键词 | `少女 精致 光线好` |

**重要**: 
- Excel必须有表头行
- L列（第12列）必须存在，包含核心词汇
- 推荐从功能4的输出开始

### Excel文件示例

```
文件路径                          | ... | 核心词汇
C:\特殊：100分\img1.jpg          | ... | 少女 精致 和服 光线好
C:\精选\img2.jpg                 | ... | 少女 精致 古装 质感
C:\unknown\img3.jpg              | ... | 少女 光线一般 细节
C:\超绝\img4.jpg                 | ... | 美女 高质 光线完美
```

---

## 🎯 工作流程示例

### 场景：对图库进行个性化评分

#### 初始数据
```
100张图片，其中：
- 30张标注了"精选"（RATING_MAP中的关键词）
- 70张未标注（需要通过模型预测）
```

#### 执行功能5
```powershell
dotnet run -- --5

[功能5] 开始处理Excel文件: report.xlsx
[功能5] 读取成功，共 100 行数据
[功能5] 识别的列: 路径列='文件路径', 词汇列='核心词汇'
[功能5] 开始计算文件夹默认匹配分 (难度0)...
[功能5] 文件夹匹配分计算完成，找到 30 个训练样本
[功能5] 开始计算个性化推荐预估评分 (难度3)...
[功能5-A] 步骤A：构建词汇表和IDF值...
[功能5-A] 词汇表大小: 245
[功能5-C] 学到的Top 10高权重词汇:
  少女: 0.8520 ↑ (正向)
  精致: 0.7234 ↑ (正向)
  光线好: 0.6891 ↑ (正向)
  质感: 0.5123 ↑ (正向)
  ...
[功能5] 个性化推荐预估评分计算完成

✅ 评分处理完成！
📁 结果已保存到：report.xlsx
```

#### 输出结果

新增两列到Excel：

```
文件路径                    | 核心词汇              | 文件夹默认匹配分 | 个性化推荐预估评分
C:\精选\img1.jpg           | 少女 精致 光线好      | 80              | 82
C:\精选\img2.jpg           | 少女 精致 古装 质感  | 80              | 84
C:\精选\img3.jpg           | 少女 光线一般         | 80              | 72
C:\unknown\img4.jpg        | 少女 精致 光线好      | 50              | 76
C:\unknown\img5.jpg        | 少女 光线一般         | 50              | 62
C:\超绝\img6.jpg           | 美女 高质 光线完美    | 95              | 93
```

---

## 💡 算法逻辑详解

### 【难度0】文件夹默认匹配分

#### 规则 (RATING_MAP)
```
"特殊：100分"  → 100分
"特殊：98分"   → 98分
"超绝"         → 95分
"特殊画风"     → 90分
"超级精选"     → 85分
"精选"         → 80分
(都不匹配)     → 50分
```

#### 例子
```
路径: C:\精选\photo.jpg
  └─ 包含"精选" → 返回80分

路径: C:\图片\test.jpg
  └─ 都不包含 → 返回50分
```

#### 自定义标记
```
路径: C:\image@@@评分75.jpg
  └─ 匹配@@@评分75 → 返回75分
```

#### 优先级
```
自定义标记 > 关键词匹配 > 默认中性分
```

---

### 【难度3】个性化推荐预估评分

#### 步骤A：构建词汇表和IDF

目的：识别所有词汇并计算其重要性

```
所有文档中的词汇: {少女, 精致, 光线好, 古装, 质感, ...}

计算每个词的IDF值：
  IDF(少女) = log(100 / 90) ≈ 0.105  (90张图片中都有)
  IDF(质感) = log(100 / 20) ≈ 1.609  (只有20张图片有)
  
结论: 稀有词(质感)比常见词(少女)权重更高
```

#### 步骤B：构建TF-IDF矩阵

目的：将每张图片的文本转换为数值向量

```
图片1的L列: "少女 精致 光线好"
分词结果: [少女, 精致, 光线好]
TF计算:
  TF(少女) = 1/3 = 0.333
  TF(精致) = 1/3 = 0.333
  TF(光线好) = 1/3 = 0.333
  
结合IDF得到TF-IDF:
  TF-IDF(少女) = 0.333 × 0.105 = 0.035
  TF-IDF(精致) = 0.333 × 1.234 = 0.411
  TF-IDF(光线好) = 0.333 × 1.123 = 0.374
  
向量化结果: [0.035, 0.411, 0.374, 0, 0, ...]
                 少女   精致   光线好  古装 质感
```

#### 步骤C：训练Ridge回归模型

目的：学习从词汇特征到评分的映射

```
训练数据 (基于RATING_MAP标注的30张图):
  [TF-IDF向量1] → 80分 (来自"精选"标签)
  [TF-IDF向量2] → 80分 (来自"精选"标签)
  [TF-IDF向量3] → 95分 (来自"超绝"标签)
  ...

模型学到的权重:
  少女的权重:   0.85  (正数，高分图片中常见)
  精致的权重:   0.72  (正数，高分图片中常见)
  光线好的权重: 0.69  (正数，高分图片中常见)
  光线一般的权重: -0.30 (负数，低分图片中常见)
```

#### 步骤D：预测所有图片

目的：使用学到的权重对所有图片进行评分

```
待预测图片的TF-IDF向量: [0.035, 0.411, 0.374, ...]

计算公式:
预测分数 = 基础分 + Σ(TF-IDF向量 × 权重)
        = 50.0 + (0.035×0.85 + 0.411×0.72 + 0.374×0.69 + ...)
        = 50.0 + 0.030 + 0.296 + 0.258 + ...
        = 50.0 + 0.584 + ...
        = 50 + 26.5
        = 76.5
        ≈ 77分 (四舍五入到整数)
```

---

## 🔧 配置修改示例

### 修改RATING_MAP

需要修改: `src/ImageInfo/Models/ImageScorerConfig.cs`

```csharp
// 原配置
public Dictionary<string, int> RatingMap { get; set; } = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
{
    { "特殊：100分", 100 },
    { "特殊：98分", 98 },
    { "超绝", 95 },
    { "特殊画风", 90 },
    { "超级精选", 85 },
    { "精选", 80 }
};

// 修改为你的分类规则
public Dictionary<string, int> RatingMap { get; set; } = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase)
{
    { "精品", 95 },
    { "推荐", 75 },
    { "普通", 50 }
};
```

编译并运行：
```powershell
dotnet build
dotnet run -- --5
```

### 调整模型灵活度

需要修改: `src/ImageInfo/Models/ImageScorerConfig.cs`

```csharp
// 原配置
public double RidgeAlpha { get; set; } = 1.0;

// 更灵活的模型（更容易拟合特殊情况）
public double RidgeAlpha { get; set; } = 0.5;

// 更稳定的模型（更平滑的预测）
public double RidgeAlpha { get; set; } = 2.0;
```

### 修改分词规则

```csharp
public int MinTokenLength { get; set; } = 1;     // 最小词长
public int MaxTokenLength { get; set; } = 100;   // 最大词长

// 修改为：只保留长度在2-30的词
public int MinTokenLength { get; set; } = 2;
public int MaxTokenLength { get; set; } = 30;
```

---

## 📊 测试数据示例

### 测试文件结构

创建测试Excel文件 `test_scorer.xlsx`：

```
文件路径                          | 其他数据 | 核心词汇
C:\特殊：100分\test1.jpg          | ...     | 美女 精致 和服
C:\特殊：100分\test2.jpg          | ...     | 少女 高质 光线好
C:\精选\test3.jpg                 | ...     | 美女 精致 光线好
C:\精选\test4.jpg                 | ...     | 少女 质感 细节
C:\unknown\test5.jpg              | ...     | 美女 光线一般
C:\unknown\test6.jpg              | ...     | 少女 普通 背景模糊
```

### 预期输出

运行后，Excel会新增两列：

```
文件路径                          | 文件夹默认匹配分 | 个性化推荐预估评分
C:\特殊：100分\test1.jpg          | 100              | 98
C:\特殊：100分\test2.jpg          | 100              | 99
C:\精选\test3.jpg                 | 80               | 85
C:\精选\test4.jpg                 | 80               | 82
C:\unknown\test5.jpg              | 50               | 62
C:\unknown\test6.jpg              | 50               | 45
```

---

## ✅ 验证检查清单

运行功能5后，检查以下几点：

- [ ] Excel文件成功打开
- [ ] 新增了两个新列
- [ ] "文件夹默认匹配分"的值符合RATING_MAP规则
- [ ] "个性化推荐预估评分"的值在0-100范围内
- [ ] 相同特征的图片有相近的评分
- [ ] 高分图片和低分图片有明显区分
- [ ] 程序输出了Top 10权重词汇

---

## 🐛 常见问题和解决方案

### Q: 所有图片的预测分都是50分

**原因**: 没有找到训练样本（没有匹配RATING_MAP的文件路径）

**解决**:
1. 检查RATING_MAP中的关键词是否与实际文件路径匹配
2. 使用自定义标记: 文件名@@@评分80.jpg
3. 修改RATING_MAP以匹配你的文件结构

### Q: 预测分数都太接近了

**原因**: 
1. 训练样本太少
2. L列的词汇特征差异不大
3. RidgeAlpha太大（过度正则化）

**解决**:
1. 增加标注样本（目标>20个）
2. 确保L列有丰富的词汇变化
3. 降低RidgeAlpha (改为0.5)

### Q: 出现"找不到L列"的错误

**原因**: Excel文件的列数少于12列

**解决**:
1. 确保是功能4的输出文件
2. 检查L列是否存在且有内容
3. 如果Excel结构不同，修改配置中的 `LColumnIndex`

### Q: 程序崩溃或卡住

**原因**: 
1. Excel文件被其他程序占用
2. Excel文件行数过多（>100000）
3. L列包含大量空值

**解决**:
1. 关闭Excel编辑窗口
2. 对大文件进行分割处理
3. 清理L列中的空值

---

## 📈 性能优化建议

### 对于大型数据集

| 数据规模 | 建议 |
|---------|------|
| 1-100张 | 直接运行，无需优化 |
| 100-1000张 | 正常运行，可能需要1-2秒 |
| 1000-10000张 | 可能需要5-10秒，内存占用50-100MB |
| >10000张 | 考虑分割处理或使用高级ML库 |

### 优化策略

1. **分割处理**: 把大Excel分割成多个小文件分别处理
2. **减少词汇**: 降低MinTokenLength或增加MaxTokenLength限制
3. **使用Release编译**: `dotnet run -c Release -- --5`

---

## 🎓 理论基础

### TF-IDF的直觉理解

**TF (词频)**: 某个词在某个文档中的重要性
- 词出现越多 → TF越高 → 在该文档中越重要

**IDF (逆文档频率)**: 某个词在整个文档集合中的罕见度
- 越多文档包含该词 → IDF越低 → 越常见
- 越少文档包含该词 → IDF越高 → 越稀有

**TF-IDF结合**: 既考虑局部重要性，又考虑全局稀有性
- 结果是一个平衡，能找到既在该文档中常见，又在整体中稀有的词

### Ridge回归的直觉理解

**普通线性回归的问题**: 如果特征太多或特征间相关性强，权重会变得很大，模型易过拟合

**Ridge回归的解决**: 在目标函数中加入"权重平方和"项，限制权重的大小

```
目标: 最小化 (预测误差² + 权重大小²)
结果: 权重较小且稳定的模型，泛化能力更强
```

---

## 📚 扩展阅读

- Python原始实现: `PythonSourceCode2/image_scorer_supervised.py`
- 完整技术文档: `功能5-个性化推荐评分系统.md`
- 快速启动指南: `功能5-快速启动指南.md`

---

**Ready to use!** 🚀
