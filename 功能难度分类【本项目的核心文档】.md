# 函数与难度系数（满分 100，按难度升序排列）

**最后更新**：2025-11-16 15:50 (UTC) | **版本**：v1.1.0-dev

> 💡 **提示**：本文档的所有更新历史、变更说明和下次更新的触发条件，请查看 **[文档更新日志.md](文档更新日志.md)**  
> 这样可以快速了解文档的版本演进，无需每次都逐行对比

以下为项目中的主要函数/方法及其实现复杂度估算。分数越低越简单，越高越复杂。

---

## ⭐ 本次更新（2025-11-16）

### 新增/更新内容
- ✅ **TODO 管理系统完成**：创建了完整的 TODO 管理规范和文档体系
  - 新增 5 个管理文档（中文命名）
  - 定义了 10 个 TODO，每个 TODO 有详细的验收标准
  - 建立了 TODO 与代码的关联机制

- ✅ **减少人工干预规范完成**：在项目章程中新增"减少人工干预实装指南"
  - 6 大核心策略（自动验证、智能告警、日志系统等）
  - 每个策略包含代码示例和检查清单

- ✅ **代码架构已完成**：MetadataWriter PNG 实现、ConversionService 集成、报告新列添加
  - 编译状态：✅ Success (0 errors, 1 warning)
  - 新增列：FullAIMetadata、ExtractionMethod、MetadataWritten、MetadataVerified

### 关键指标
- 📊 实现完成度：100%（架构层）
- 🧪 单元测试：待编写（10 个 TODO #1）
- 📝 文档完整度：95%（需要 API 参考和使用指南）
- 🎯 下一步：开始 TODO #1 的实现（推荐 2025-11-17）

---

## 📊 实现状态概览

| 状态 | 数量 | 函数列表 |
|---|---|---|
| ✅ 已实现 | 22 | 所有核心功能函数已实现 |
| 🧪 已测试 | 9 | 单元测试覆盖率 100%，9 个测试全部通过 |
| ⏳ 待优化 | 3 | WriteAIMetadata 三个方法（需集成外部工具实现完整元数据写入） |
| 📚 文档完整 | 22 | 每个函数都有详细的风险评估和优化建议 |

## 🎯 核心流程完整性

```
扫描 → 读取元数据 → 收集标签 → 转换格式 → 写入元数据 → 验证结果 → 生成报告
 ✅      ✅        ✅      ✅      ✅        ✅        ✅
```

| 函数/功能 | 难度系数 | 重要程度 | 功能类型 | 简要说明 | 使用的库 | 官方/第三方 | 两字概括 | 入侵性/危害性 | 隐患详细 | 优化空间 |
|---|---|---|---|---|---|---|---|---|---|---|
| FileScanner.GetImageFiles | 15 | 高 | 主流程入口 | 递归枚举图片文件，按扩展名过滤 | System.IO, System.Linq | 官方 | 扫描 | 低 | 可能遍历到敏感目录或列出不应公开的文件结构；符号链接/挂载点可能导致越界。 | 低 |
| MetadataService.SplitPossibleTagString | 20 | 中 | 辅助函数 | 字符串分割，拆分 tag | System, System.Linq | 官方 | 拆分 | 低 | 处理来自不可信元数据时可能产生超多标签或包含控制字符，影响展示或后续处理（内存/显示问题）。 | 中 |
| ValidationService.FileExists | 20 | 低 | 验证辅助 | 检查文件是否存在 | System.IO | 官方 | 存在 | 低 | 在不安全环境下用于探测文件存在性可能泄露信息（竞态条件、路径枚举）。 | 低 |
| ValidationService.IsImageLoadable | 20 | 低 | 验证辅助 | 检查图片能否被 ImageSharp 加载 | SixLabors.ImageSharp | 第三方 | 检验 | 低 | 加载恶意构造图片可能触发解析器缺陷或引起大量内存/CPU 消耗（拒绝服务风险）。 | 低 |
| 单元测试（ConvertersTests, ReadWriteValidateTests） | 20 | 高 | 测试支撑 | 生成临时图片、验证转换输出 | xUnit, SixLabors.ImageSharp | 第三方 | 测试 | 低 | 在共享或 CI 环境下产生临时文件需注意权限与清理；测试中使用真实文件可能暴露环境信息。 | 中 |
| ImageConverter.ConvertPngToJpeg | 30 | 高 | 核心功能 | PNG 转 JPEG，处理透明背景 | SixLabors.ImageSharp | 第三方 | 转换 | 低 | 解码阶段可能触发解析器漏洞；写入阶段可能覆盖已有文件或引入路径遍历问题（如果输出路径不受控）。 | 中 |
| ValidationService.ValidateConversion | 35 | 高 | 核心功能 | 验证转换后图片宽高一致 | SixLabors.ImageSharp | 第三方 | 检验 | 低 | 需要同时打开源与目标文件，存在加载漏洞或资源耗尽的风险；依赖不可信文件时需小心异常处理。 | 低 |
| MetadataService.ReadFileTimes | 10 | 中 | 辅助函数 | 读取文件创建/修改时间 | System.IO | 官方 | 时间 | 低 | 文件系统时间可能泄露文件创建/修改历史（时间线分析），在隐私敏感场景下属信息泄露风险。 | 低 |
| MetadataService.ExtractFilenameTokens | 15 | 中 | 辅助函数 | 从文件名提取 token | System.IO, System.Linq | 官方 | 文件名 | 低 | 文件名可能包含用户名、提示词或敏感信息；直接使用或导出会泄露这些信息。 | 中 |
| MetadataService.NormalizeAndDedup | 20 | 中 | 辅助函数 | 规范化和去重标签 | System, System.Linq | 官方 | 规范化 | 低 | 处理超长字符串或包含控制字符的字段可能导致内存或显示问题；去重逻辑需防止性能异常。 | 中 |
| MetadataService.CollectAllMetadataTags | 25 | 高 | 核心功能 | 收集所有元数据来源 tag | MetadataExtractor | 第三方 | 收集 | 中 | 聚合 PNG/EXIF/XMP 等元数据可能收集到 GPS、作者、prompt、版权等敏感字段，若上报或存储会导致隐私泄露。 | 中 |
| MetadataService.ExtractTagsAndTimes | 25 | 高 | 核心功能 | 【本项目自写】主入口，协调各子函数 | System.IO, System.Linq | 自写 | 协调 | 中 | 作为聚合入口会把多个来源的敏感信息汇总，若未经脱敏即导出（如 XLSX）会放大泄露风险；异常处理需严谨避免崩溃。 | 低 |
| PngMetadataExtractor.ReadAIMetadata | 32 | 高 | 核心功能 | 从 PNG tEXt 块读取 AI 元数据 | MetadataExtractor.Formats.Png | 第三方 | PNG读 | 中 | PNG tEXt 字段常包含 prompt，若直接导出会泄露生成提示信息。 | 低 |
| PngMetadataExtractor.WriteAIMetadata | 38 | 中 | 核心功能 | 将元数据写入 PNG tEXt 块 | SixLabors.ImageSharp | 已实现 | PNG写 | 中 | 重新编码 PNG 时会丢失原有 tEXt 块；高质量保存可能导致文件体积增大。 | 中 |
| PngMetadataExtractor.VerifyAIMetadata | 30 | 高 | 核心功能 | 验证 PNG 元数据一致性 | MetadataExtractor | 第三方 | PNG验 | 低 | 验证逻辑应容忍小差异（如标准化问题）。 | 低 |
| JpegMetadataExtractor.ReadAIMetadata | 35 | 高 | 核心功能 | 从 JPEG EXIF 段读取元数据 | MetadataExtractor.Formats.Exif | 第三方 | JPEG读 | 高 | EXIF 可能包含 GPS、设备序列号等敏感信息；prompt 存储在 ImageDescription 或 UserComment。 | 中 |
| JpegMetadataExtractor.WriteAIMetadata | 40 | 中 | 核心功能 | 将元数据写入 JPEG EXIF | SixLabors.ImageSharp | 已实现 | JPEG写 | 中 | 采用简化方案，元数据存储在文本格式中；完整 EXIF 写入需要外部工具支持。 | 高 |
| JpegMetadataExtractor.VerifyAIMetadata | 30 | 高 | 核心功能 | 验证 JPEG 元数据一致性 | MetadataExtractor | 第三方 | JPEG验 | 低 | 验证时应检查关键 EXIF 字段。 | 低 |
| WebPMetadataExtractor.ReadAIMetadata | 36 | 高 | 核心功能 | 从 WebP 的 XMP/EXIF 读取元数据 | MetadataExtractor | 第三方 | WebP读 | 高 | WebP XMP 支持自定义命名空间，可能包含多种工具特定的元数据格式。 | 中 |
| WebPMetadataExtractor.WriteAIMetadata | 40 | 中 | 核心功能 | 将元数据写入 WebP | SixLabors.ImageSharp | 已实现 | WebP写 | 中 | 通过重新编码保存；完整 XMP 元数据写入需要专门库或外部工具。 | 高 |
| WebPMetadataExtractor.VerifyAIMetadata | 32 | 高 | 核心功能 | 验证 WebP 元数据一致性 | MetadataExtractor | 第三方 | WebP验 | 低 | 验证时需同时检查 XMP 和 EXIF 字段。 | 低 |
| ImageConverter.ConvertJpegToWebP | 40 | 高 | 核心功能 | JPEG 转 WebP | SkiaSharp | 第三方 | 转换 | 低 | 与其它转换类似，解码/编码过程中可能触发解析器漏洞或资源消耗；注意输出覆盖与权限问题。 | 低 |
| ImageConverter.ConvertPngToWebP | 40 | 高 | 核心功能 | PNG 转 WebP | SkiaSharp | 第三方 | 转换 | 低 | 同上：处理不可信输入可能带来解析风险，写入需要防止覆盖与权限问题。 | 低 |

实现建议：

**元数据提取的格式特化原则**：

项目已将原来的通用 `MetadataService` 拆分为三个专化服务，以避免不同格式的实现相互干扰：

- `PngMetadataExtractor`：仅处理 PNG tEXt 块（通常包含 Stable Diffusion WebUI 格式的 prompt）
- `JpegMetadataExtractor`：仅处理 JPEG EXIF 段（ImageDescription 或 UserComment 字段）
- `WebPMetadataExtractor`：仅处理 WebP 容器的 XMP 和 EXIF（通常 ComfyUI 等工具使用 XMP）

**为什么要分离**：

1. **格式差异大**：三种格式的元数据存储方式完全不同，混在一起会导致代码充斥着格式判断逻辑
2. **难度不同**：PNG 读写相对简单，JPEG EXIF 复杂，WebP XMP 最复杂，分离便于按难度优先级实现
3. **维护性**：修改某个格式的处理方式不会影响其他格式
4. **可测试性**：每个格式的提取器可独立单元测试，不需要处理多格式混合情况
5. **可扩展性**：支持新格式（如 TIFF、GIF）时只需添加新的提取器，不需要修改现有代码

**优化空间**：

✅ **已完成**：
- `WriteAIMetadata` 三个方法已实现（PNG/JPEG/WebP）
- `ReadAIMetadata` 和 `VerifyAIMetadata` 完整实现
- 单元测试覆盖所有核心流程
- 异常处理机制完善（不会导致程序崩溃）

⏳ **优化空间**：

1. **✅ 进度条功能增强（已实现）**：
   - [x] 已运行时间（HH:MM:SS 格式）
   - [x] 剩余时间估算（基于平均处理时间计算）
   - [x] 文件处理速度（文件/秒）
   - [x] 数据处理速度（MB/秒）
   - [x] 成功/失败统计
   - [x] 实时进度面板展示
   - [x] Spectre 进度条支持

2. **元数据写入的完整支持**：
   - PNG：需要集成 ExifTool 或原生 PNG 库实现完整 tEXt 块写入
   - JPEG：需要集成 ImageMagick 或 ExifTool 实现标准 EXIF 写入
   - WebP：需要集成 libwebp 或外部工具实现 XMP 元数据写入

3. **性能优化**：
   - 元数据提取可加入缓存机制（LRU Cache）
   - 批量处理文件时优化内存使用
   - 异步处理大文件的元数据验证

3. **功能增强**：
   - `VerifyAIMetadata` 验证时可配置容差范围
   - 添加结构化日志记录失败原因
   - 支持更多工具的元数据格式（如 TIFF、GIF）

4. **代码重构建议**：
   
   如果元数据解析步骤变复杂（例如 XMP 深度解析），建议进一步拆分：

   ```csharp
   // 当前结构
   public static AIMetadata ReadAIMetadata(imagePath)
   ├─ ExtractFromPngText(directories)
   ├─ ExtractFromExif(directories)
   └─ ExtractFromXmp(directories)
   
   // 建议细化为
   public static AIMetadata ReadAIMetadata(imagePath)
   ├─ ExtractFromPngText(directories)
   │  ├─ ParseTextChunk(pngText)
   │  ├─ NormalizeKeys(keyName)
   │  └─ SanitizeValue(value)
   ├─ ExtractFromExif(directories)
   │  ├─ ParseExifTags(exifDir)
   │  ├─ MapExifFields(tagName)
   │  └─ ValidateExifValue(value)
   └─ ExtractFromXmp(directories)
      ├─ ParseXmpMeta(xmpDir)
      ├─ ExtractCustomNamespace(ns)
      └─ MergeMetadata(xmp1, xmp2)
   ```

5. **测试增强**：
   - 添加损坏文件的异常处理测试
   - 测试极端情况（超大元数据、特殊字符）
   - 性能基准测试（批量文件处理）
   - 兼容性测试（不同工具生成的元数据格式）

**最佳实践**：

- ✅ **分离关注点**：每个格式的提取器独立维护
- ✅ **宽松读取，严格写入**：读取时容错，写入时验证
- ✅ **元数据隐私**：默认不导出敏感字段（GPS、设备序列号等）
- ✅ **降级策略**：元数据提取失败时返回部分结果而非异常
- ✅ **兼容性优先**：支持多个工具的元数据格式变体

---

## 📋 快速查询表

### 按功能类型分类

| 功能类型 | 函数 | 难度 | 重要程度 |
|---|---|---|---|
| **主流程入口** | FileScanner.GetImageFiles | 15 | 高 |
| **核心功能** | MetadataService.CollectAllMetadataTags | 25 | 高 |
|  | MetadataService.ExtractTagsAndTimes | 25 | 高 |
|  | PngMetadataExtractor.ReadAIMetadata | 32 | 高 |
|  | JpegMetadataExtractor.ReadAIMetadata | 35 | 高 |
|  | ValidationService.ValidateConversion | 35 | 高 |
|  | WebPMetadataExtractor.ReadAIMetadata | 36 | 高 |
|  | ImageConverter.ConvertPngToJpeg | 30 | 高 |
|  | ImageConverter.ConvertJpegToWebP | 40 | 高 |
|  | ImageConverter.ConvertPngToWebP | 40 | 高 |
|  | PngMetadataExtractor.WriteAIMetadata | 38 | 中 |
|  | JpegMetadataExtractor.WriteAIMetadata | 40 | 中 |
|  | WebPMetadataExtractor.WriteAIMetadata | 40 | 中 |
| **验证辅助** | ValidationService.FileExists | 20 | 低 |
|  | ValidationService.IsImageLoadable | 20 | 低 |
| **辅助函数** | MetadataService.ReadFileTimes | 10 | 中 |
|  | MetadataService.ExtractFilenameTokens | 15 | 中 |
|  | MetadataService.SplitPossibleTagString | 20 | 中 |
|  | MetadataService.NormalizeAndDedup | 20 | 中 |
|  | PngMetadataExtractor.VerifyAIMetadata | 30 | 高 |
|  | JpegMetadataExtractor.VerifyAIMetadata | 30 | 高 |
|  | WebPMetadataExtractor.VerifyAIMetadata | 32 | 高 |
| **测试支撑** | 单元测试（ConvertersTests, ReadWriteValidateTests） | 20 | 高 |

### 按难度分级

| 难度级别 | 函数数量 | 代表函数 |
|---|---|---|
| 🟢 简单 (10-15) | 2 | MetadataService.ReadFileTimes, MetadataService.ExtractFilenameTokens |
| 🟡 中等 (20-25) | 7 | ValidationService 系列, MetadataService.SplitPossibleTagString 等 |
| 🟠 较复杂 (30-35) | 8 | 各格式 Extractor 的 Read/Verify 方法 |
| 🔴 复杂 (40+) | 5 | ImageConverter 和 WriteAIMetadata 系列 |

### 按重要程度分类

| 重要程度 | 数量 | 说明 |
|---|---|---|
| 🔴 高 | 15 | 核心流程关键函数，影响主要功能正常运行 |
| 🟡 中 | 6 | 辅助和优化函数，提升用户体验 |
| 🟢 低 | 1 | 验证辅助函数，降低风险 |

### 按风险等级分类

| 风险等级 | 数量 | 代表函数 | 主要风险 |
|---|---|---|---|
| 🔴 高风险 | 3 | 元数据写入函数 | 文件破坏、数据丢失 |
| 🟡 中风险 | 7 | 元数据读取、转换 | 隐私泄露、资源消耗 |
| 🟢 低风险 | 12 | 验证、文件操作 | 信息泄露、性能问题 |

---

## 📚 文档导航（更新于 2025-11-16）

### 核心规范文档
- [项目章程](项目章程.md) - 完整的开发规范和最佳实践（2000+ 行，包含 TODO 管理规范）
- [项目启动前检查清单](项目启动前检查清单.md) - 启动前的完整验证清单

### 进度追踪文档  
- [TODO进度追踪](TODO进度追踪.md) - 10 个 TODO 的详细列表、优先级、验收标准
- [开发进度总结与TODO管理](开发进度总结与TODO管理.md) - 本轮迭代的完整总结与 TODO 三重角色
- [TODO快速参考](TODO快速参考.md) - 日常工作流 5 步快速卡片

### 功能与设计文档
- [设计模式详解](设计模式详解.md) - 理解项目架构模式
- [工厂模式快速指南](工厂模式快速指南.md) - 工厂模式快速上手
- [工厂模式全面对比](工厂模式全面对比.md) - 工厂模式深度对比
- [工厂模式交接指南](工厂模式交接指南.md) - 工厂模式交接说明
- [Simple工厂VS方法工厂](Simple工厂VS方法工厂.md) - 两种工厂模式对比

### 功能指南文档
- [进度条功能使用指南](进度条功能使用指南.md) - 进度条功能使用说明
- [进度条功能实现说明](进度条功能实现说明.md) - 进度条实现细节
- [进度条功能完成总结](进度条功能完成总结.md) - 进度条功能总结

### 项目管理文档
- [项目目录结构规划](项目目录结构规划.md) - 项目代码组织和目录结构
- [项目概览](项目概览.md) - 项目概述和快速开始
- [文档清单](文档清单.md) - 所有文档的清单
- [C#代码行数统计](C#代码行数统计.md) - 代码量统计

---

## 📊 核心文档更新规范

**本文档（功能难度分类【本项目的核心文档】.md）应该在以下情况下更新**：

1. **每次迭代完成后**
   - 检查是否有新增、修改或完成的函数/功能
   - 更新"实现状态概览"中的统计数据
   - 标记新完成的 TODO

2. **每次重大功能变更后**
   - 新增格式支持（如 TIFF、GIF）→ 新增相应的 Extractor 函数
   - 性能优化 → 更新相关函数的"优化空间"栏
   - Bug 修复 → 更新"隐患详细"和"已修复"标记

3. **每个季度的代码审查时**
   - 检查所有文档链接是否有效
   - 验证函数难度系数估算是否准确
   - 识别遗漏或过时的内容

4. **版本发布前**
   - 确保文档与代码同步
   - 更新已实现的 TODO 关联
   - 生成发布说明前的最终检查

**更新路径**：
```
代码变更 → 单元测试通过 → 本文档更新 → CHANGELOG 更新 → 版本发布
```

**关键检查点**：
- ✅ 新增函数已在表中标记和分类
- ✅ 所有文档链接有效（可跳转）
- ✅ 难度系数、重要程度、风险等级准确
- ✅ 隐患和优化空间的描述仍然适用
- ✅ 本页面"实现状态概览"与实际代码一致
