# 功能5：个性化推荐评分系统 (C# 重构)

## 📚 核心原理概述

功能5 是一个**二维评分系统**，在功能4 的基础上新增两列数据：

### 1️⃣ 文件夹默认匹配分 (难度等级：0 ⭐)

**原理**：基于硬编码的规则，检查文件路径是否包含特定关键词

**工作流程**：
```
输入文件路径 → 检查RATING_MAP中的关键词 → 返回对应分数
```

**评分规则** (来自 `ImageScorerConfig.RatingMap`)：
```csharp
特殊：100分  → 100分
特殊：98分   → 98分
超绝         → 95分
特殊画风     → 90分
超级精选     → 85分
精选         → 80分
(都不匹配)   → 50分 (默认中性分)
```

**优先级**：
1. 自定义评分标记 (例：`image@@@评分75.jpg`) → 75分
2. 文件夹名称关键词匹配 → 对应分数
3. 默认中性分 → 50分

**特点**：
- ✅ 实现简单，无需训练
- ✅ 快速可靠
- ❌ 只能识别预定义的关键词
- ❌ 无法处理新类型的图片

---

### 2️⃣ 个性化推荐预估评分 (难度等级：3 ⭐⭐⭐)

**原理**：基于机器学习（TF-IDF + Ridge回归）学习用户偏好

#### 工作流程（4个步骤）：

```
┌─────────────────────┐
│   输入Excel文件      │  (A列:路径, L列:核心词汇)
└──────────┬──────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 步骤A：构建词汇表和计算IDF值          │
│ (Inverse Document Frequency)         │
│ IDF = log(总文档数 / 包含该词的文档数) │
│ 含义：稀有词权重高                    │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 步骤B：构建TF-IDF矩阵                 │
│ 每行=一个文档(图片)                   │
│ 每列=一个词汇                         │
│ 矩阵值 = TF(词频) × IDF(逆文档频率)   │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 步骤C：训练Ridge回归模型              │
│ 输入：TF-IDF矩阵 + 基准评分           │
│ 输出：每个词汇的权重系数              │
│ 学习：[词汇特征] → [用户偏好评分]     │
└──────────┬───────────────────────────┘
           │
           ▼
┌──────────────────────────────────────┐
│ 步骤D：预测所有图片的评分             │
│ 预测 = TF-IDF向量 · 学到的权重 + 均值 │
│ 结果限制在[0, 100]范围内              │
└──────────────────────────────────────┘
```

#### 具体例子：

假设你的RATING_MAP中标注了这些高分图片：
```
图1路径：C:\特殊画风\girl.jpg
图1的L列词汇：少女 精致 和服 光线好 细节

图2路径：C:\精选\portrait.jpg  
图2的L列词汇：少女 精致 古装 光线好 质感
```

模型通过学习会发现：
- ✅ "少女"、"精致"、"光线好" → 出现在高分图片中 → 权重为正 → 提升评分
- ✅ "细节"、"质感" → 也出现在高分图片中 → 权重为正 → 提升评分

后续对于未标注的图片：
```
图3路径：C:\unknown\image.jpg
图3的L列词汇：少女 精致 古装 光线一般

预测分数 = 基础分(50) + 0.8×少女权重 + 0.8×精致权重 + 0.5×古装权重 + 0.3×光线一般权重
        = 50 + 10 + 8 + 4 + 2 = 74分
```

#### 关键概念解析：

**TF (Term Frequency) - 词频**
```
TF(词, 文档) = 该词在文档中的出现次数 / 文档总词数

例：
文档A包含10个词，其中"少女"出现2次
TF("少女", A) = 2/10 = 0.2
```

**IDF (Inverse Document Frequency) - 逆文档频率**
```
IDF(词) = log(总文档数 / 包含该词的文档数)

例：
总共100张图片，其中50张包含"少女"
IDF("少女") = log(100/50) = log(2) ≈ 0.69

总共100张图片，其中5张包含"特殊风格"
IDF("特殊风格") = log(100/5) = log(20) ≈ 2.99

结论：稀有词("特殊风格")的IDF更高，权重更大
```

**Ridge回归 - 正则化线性回归**
```
目标函数：最小化 ||y - Xw||² + alpha·||w||²
                [预测误差]   [正则化项]

作用：
- 第一项：让预测尽可能准确
- 第二项：防止权重过大，避免过拟合

alpha值作用：
- alpha越小：模型越复杂，更容易过拟合
- alpha越大：模型越简单，可能欠拟合
- 推荐值：1.0
```

---

## 🚀 使用方式

### 快速启动

#### 方式1：命令行快速启动
```powershell
dotnet run -- --5
```

#### 方式2：交互式模式
```powershell
dotnet run
# 程序启动后输入 5 进入功能5
```

### 交互式操作步骤

1. **启动程序**
   ```
   dotnet run
   ```

2. **选择功能5**
   ```
   请选择功能: 5
   ```

3. **输入Excel文件路径**
   ```
   请输入Excel文件的完整路径：
   C:\Data\图片信息报告.xlsx
   ```

4. **自动处理**
   - ✅ 读取Excel文件
   - ✅ 计算文件夹默认匹配分
   - ✅ 训练TF-IDF + Ridge回归模型
   - ✅ 预测所有图片的个性化评分
   - ✅ 保存结果到原文件

### 输出结果

添加两个新列到Excel中：

| 列名 | 说明 | 示例值 |
|------|------|--------|
| `文件夹默认匹配分` | 基于RATING_MAP的硬编码规则 | 80, 95, 50 |
| `个性化推荐预估评分` | 基于TF-IDF + Ridge回归的预测 | 76, 88, 52 |

---

## 📊 代码架构

### 核心类

#### 1. `ImageScorerConfig` (Models/ImageScorerConfig.cs)
```csharp
public class ImageScorerConfig
{
    public Dictionary<string, int> RatingMap { get; set; }           // RATING_MAP规则
    public string ScorePrefix { get; set; } = "@@@评分";             // 自定义评分标记
    public double DefaultNeutralScore { get; set; } = 50.0;          // 默认分数
    public int LColumnIndex { get; set; } = 11;                      // L列索引
    public string FolderMatchScoreColumn { get; set; } = "文件夹默认匹配分";
    public string PredictedScoreColumn { get; set; } = "个性化推荐预估评分";
    public double RidgeAlpha { get; set; } = 1.0;                    // Ridge正则化参数
}
```

#### 2. `ImageScorerService` (Services/ImageScorerService.cs)
```csharp
public class ImageScorerService
{
    // 主方法
    public async Task<bool> ScoreFromExcelAsync(string excelPath)
    
    // 核心评分逻辑
    public async Task<bool> ScoreDataTableAsync(DataTable dataTable)
    
    // 难度0：文件夹匹配
    private double ExtractFolderScore(string filePath)
    
    // 难度3：TF-IDF特征工程
    private void BuildVocabularyAndIDF(DataTable dataTable, string vocabColumn)
    private double[][] BuildTFIDFMatrix(DataTable dataTable, string vocabColumn)
    
    // Ridge回归训练与预测
    private void TrainRidgeRegression(double[][] tfidfMatrix, DataTable dataTable, List<int> trainingIndices)
    private void PredictAllScores(DataTable dataTable, double[][] tfidfMatrix)
}
```

#### 3. `DevelopmentModeService` (Services/DevelopmentModeService.cs)
```csharp
public static void RunScanMode5(string folder)
    // 功能5的入口点
    
private static async Task RunImageScorerAsync(string excelPath)
    // 异步执行评分任务
```

---

## ⚙️ 配置说明

### 默认配置 (位于 `ImageScorerConfig`)

```csharp
// 文件夹关键词映射
RatingMap = new Dictionary<string, int>
{
    { "特殊：100分", 100 },
    { "特殊：98分", 98 },
    { "超绝", 95 },
    { "特殊画风", 90 },
    { "超级精选", 85 },
    { "精选", 80 }
}

// TF-IDF参数
MinTokenLength = 1;         // 最小词长
MaxTokenLength = 100;       // 最大词长
EnableStopWordFilter = false; // 不过滤常用词

// Ridge回归参数
RidgeAlpha = 1.0;           // 正则化强度
```

### 自定义配置

```csharp
// 创建自定义配置
var config = new ImageScorerConfig
{
    RatingMap = new Dictionary<string, int>
    {
        { "我的分类A", 90 },
        { "我的分类B", 70 },
    },
    ScorePrefix = "@score",    // 改为@score
    RidgeAlpha = 0.5           // 降低正则化强度
};

var scorer = new ImageScorerService(config);
await scorer.ScoreFromExcelAsync(excelPath);
```

---

## 📈 性能考量

| 项目 | 影响因素 | 优化建议 |
|------|---------|---------|
| 速度 | 图片数量、词汇量 | 词汇量>1000时可能较慢 |
| 准确度 | 训练样本数 | 至少需要10-20个标注样本 |
| 内存 | TF-IDF矩阵大小 | (样本数 × 词汇数)的双精度数组 |

### 性能指标示例
```
输入数据：1000张图片，L列平均包含50个词汇
词汇总数：约500个不同词汇
处理时间：约1-2秒
内存占用：约10-20MB
```

---

## 🔍 故障排查

### 问题1：找不到L列
**错误信息**：`Excel列数不足，无法找到L列`
**原因**：Excel文件的列数少于12列
**解决**：
1. 检查Excel是否是功能4的输出
2. 确认L列（第12列）包含核心词汇

### 问题2：未找到训练样本
**错误信息**：`未找到训练样本，无法训练模型`
**原因**：文件路径中没有匹配RATING_MAP的关键词
**解决**：
1. 检查RATING_MAP配置是否正确
2. 确保文件路径包含相应关键词
3. 或使用自定义标记 (如 `@@@评分80`)

### 问题3：预测评分都相同
**原因**：训练样本太少或特征差异不大
**解决**：
1. 增加标注样本
2. 检查L列是否有足够的文本内容
3. 降低RidgeAlpha值（如改为0.5）

---

## 📌 与Python版本的对应关系

| Python (image_scorer_supervised.py) | C# (ImageScorerService.cs) |
|-------------------------------------|---------------------------|
| `ScorerConfig` | `ImageScorerConfig` |
| `ImageScorer` | `ImageScorerService` |
| `_extract_score_from_path()` | `ExtractFolderScore()` |
| `_setup_and_vectorize()` | `ScoreDataTableAsync()` |
| `BuildVocabularyAndIDF()` | `BuildVocabularyAndIDF()` |
| `BuildTFIDFMatrix()` | `BuildTFIDFMatrix()` |
| `TrainRidgeRegression()` | `TrainRidgeRegression()` |
| `PredictAllScores()` | `PredictAllScores()` |
| `run_scoring_from_file()` | `ScoreFromExcelAsync()` |

---

## 💡 最佳实践

1. **数据质量**
   - 确保L列有有意义的词汇
   - 标注至少10-20个样本以获得良好的模型

2. **参数调整**
   - 如果预测分数差异过小，降低RidgeAlpha
   - 如果预测分数波动过大，增加RidgeAlpha

3. **词汇质量**
   - 过短的词汇（如"a", "的"）可能噪声大
   - 过长的词汇可能欠拟合

4. **更新策略**
   - 当新增图片数据时，重新运行功能5以更新模型
   - 定期检查Top权重词汇是否符合预期

---

## 🎯 下一步改进方向

可能的改进项：
1. 支持多个特征列（不仅仅是L列）
2. 支持自定义分词器
3. 增加模型可解释性报告
4. 支持模型保存和加载
5. 集成更高级的机器学习算法（SVM, Random Forest等）
